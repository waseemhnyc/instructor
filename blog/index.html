<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Enhancing OpenAI function calling with Pydantic"><meta name=author content="Jason Liu"><link href=https://jxnl.github.io/instructor/blog/ rel=canonical><link href=../api/ rel=prev><link href=archive/2023/ rel=next><link rel=alternate type=application/rss+xml title="RSS feed" href=../feed_rss_created.xml><link rel=alternate type=application/rss+xml title="RSS feed of updated content" href=../feed_rss_updated.xml><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-9.4.14"><title>Welcome to the Instructor Blog - Instructor</title><link rel=stylesheet href=../assets/stylesheets/main.fad675c6.min.css><link rel=stylesheet href=../assets/stylesheets/palette.356b1318.min.css><style>:root{--md-admonition-icon--note:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1 7.775V2.75C1 1.784 1.784 1 2.75 1h5.025c.464 0 .91.184 1.238.513l6.25 6.25a1.75 1.75 0 0 1 0 2.474l-5.026 5.026a1.75 1.75 0 0 1-2.474 0l-6.25-6.25A1.752 1.752 0 0 1 1 7.775Zm1.5 0c0 .066.026.13.073.177l6.25 6.25a.25.25 0 0 0 .354 0l5.025-5.025a.25.25 0 0 0 0-.354l-6.25-6.25a.25.25 0 0 0-.177-.073H2.75a.25.25 0 0 0-.25.25ZM6 5a1 1 0 1 1 0 2 1 1 0 0 1 0-2Z"/></svg>');--md-admonition-icon--abstract:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.5 1.75v11.5c0 .138.112.25.25.25h3.17a.75.75 0 0 1 0 1.5H2.75A1.75 1.75 0 0 1 1 13.25V1.75C1 .784 1.784 0 2.75 0h8.5C12.216 0 13 .784 13 1.75v7.736a.75.75 0 0 1-1.5 0V1.75a.25.25 0 0 0-.25-.25h-8.5a.25.25 0 0 0-.25.25Zm13.274 9.537v-.001l-4.557 4.45a.75.75 0 0 1-1.055-.008l-1.943-1.95a.75.75 0 0 1 1.062-1.058l1.419 1.425 4.026-3.932a.75.75 0 1 1 1.048 1.074ZM4.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM4 7.75A.75.75 0 0 1 4.75 7h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 4 7.75Z"/></svg>');--md-admonition-icon--info:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"/></svg>');--md-admonition-icon--tip:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M3.499.75a.75.75 0 0 1 1.5 0v.996C5.9 2.903 6.793 3.65 7.662 4.376l.24.202c-.036-.694.055-1.422.426-2.163C9.1.873 10.794-.045 12.622.26 14.408.558 16 1.94 16 4.25c0 1.278-.954 2.575-2.44 2.734l.146.508.065.22c.203.701.412 1.455.476 2.226.142 1.707-.4 3.03-1.487 3.898C11.714 14.671 10.27 15 8.75 15h-6a.75.75 0 0 1 0-1.5h1.376a4.484 4.484 0 0 1-.563-1.191 3.835 3.835 0 0 1-.05-2.063 4.647 4.647 0 0 1-2.025-.293.75.75 0 0 1 .525-1.406c1.357.507 2.376-.006 2.698-.318l.009-.01a.747.747 0 0 1 1.06 0 .748.748 0 0 1-.012 1.074c-.912.92-.992 1.835-.768 2.586.221.74.745 1.337 1.196 1.621H8.75c1.343 0 2.398-.296 3.074-.836.635-.507 1.036-1.31.928-2.602-.05-.603-.216-1.224-.422-1.93l-.064-.221c-.12-.407-.246-.84-.353-1.29a2.425 2.425 0 0 1-.507-.441 3.075 3.075 0 0 1-.633-1.248.75.75 0 0 1 1.455-.364c.046.185.144.436.31.627.146.168.353.305.712.305.738 0 1.25-.615 1.25-1.25 0-1.47-.95-2.315-2.123-2.51-1.172-.196-2.227.387-2.706 1.345-.46.92-.27 1.774.019 3.062l.042.19a.884.884 0 0 1 .01.05c.348.443.666.949.94 1.553a.75.75 0 1 1-1.365.62c-.553-1.217-1.32-1.94-2.3-2.768L6.7 5.527c-.814-.68-1.75-1.462-2.692-2.619a3.737 3.737 0 0 0-1.023.88c-.406.495-.663 1.036-.722 1.508.116.122.306.21.591.239.388.038.797-.06 1.032-.19a.75.75 0 0 1 .728 1.31c-.515.287-1.23.439-1.906.373-.682-.067-1.473-.38-1.879-1.193L.75 5.677V5.5c0-.984.48-1.94 1.077-2.664.46-.559 1.05-1.055 1.673-1.353V.75Z"/></svg>');--md-admonition-icon--success:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M13.78 4.22a.75.75 0 0 1 0 1.06l-7.25 7.25a.75.75 0 0 1-1.06 0L2.22 9.28a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018L6 10.94l6.72-6.72a.75.75 0 0 1 1.06 0Z"/></svg>');--md-admonition-icon--question:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.92 6.085h.001a.749.749 0 1 1-1.342-.67c.169-.339.436-.701.849-.977C6.845 4.16 7.369 4 8 4a2.756 2.756 0 0 1 1.637.525c.503.377.863.965.863 1.725 0 .448-.115.83-.329 1.15-.205.307-.47.513-.692.662-.109.072-.22.138-.313.195l-.006.004a6.24 6.24 0 0 0-.26.16.952.952 0 0 0-.276.245.75.75 0 0 1-1.248-.832c.184-.264.42-.489.692-.661.103-.067.207-.132.313-.195l.007-.004c.1-.061.182-.11.258-.161a.969.969 0 0 0 .277-.245C8.96 6.514 9 6.427 9 6.25a.612.612 0 0 0-.262-.525A1.27 1.27 0 0 0 8 5.5c-.369 0-.595.09-.74.187a1.01 1.01 0 0 0-.34.398ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--warning:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"/></svg>');--md-admonition-icon--failure:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M2.344 2.343h-.001a8 8 0 0 1 11.314 11.314A8.002 8.002 0 0 1 .234 10.089a8 8 0 0 1 2.11-7.746Zm1.06 10.253a6.5 6.5 0 1 0 9.108-9.275 6.5 6.5 0 0 0-9.108 9.275ZM6.03 4.97 8 6.94l1.97-1.97a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734L9.06 8l1.97 1.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L8 9.06l-1.97 1.97a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L6.94 8 4.97 6.03a.751.751 0 0 1 .018-1.042.751.751 0 0 1 1.042-.018Z"/></svg>');--md-admonition-icon--danger:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M9.504.43a1.516 1.516 0 0 1 2.437 1.713L10.415 5.5h2.123c1.57 0 2.346 1.909 1.22 3.004l-7.34 7.142a1.249 1.249 0 0 1-.871.354h-.302a1.25 1.25 0 0 1-1.157-1.723L5.633 10.5H3.462c-1.57 0-2.346-1.909-1.22-3.004L9.503.429Zm1.047 1.074L3.286 8.571A.25.25 0 0 0 3.462 9H6.75a.75.75 0 0 1 .694 1.034l-1.713 4.188 6.982-6.793A.25.25 0 0 0 12.538 7H9.25a.75.75 0 0 1-.683-1.06l2.008-4.418.003-.006a.036.036 0 0 0-.004-.009l-.006-.006-.008-.001c-.003 0-.006.002-.009.004Z"/></svg>');--md-admonition-icon--bug:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M4.72.22a.75.75 0 0 1 1.06 0l1 .999a3.488 3.488 0 0 1 2.441 0l.999-1a.748.748 0 0 1 1.265.332.75.75 0 0 1-.205.729l-.775.776c.616.63.995 1.493.995 2.444v.327c0 .1-.009.197-.025.292.408.14.764.392 1.029.722l1.968-.787a.75.75 0 0 1 .556 1.392L13 7.258V9h2.25a.75.75 0 0 1 0 1.5H13v.5c0 .409-.049.806-.141 1.186l2.17.868a.75.75 0 0 1-.557 1.392l-2.184-.873A4.997 4.997 0 0 1 8 16a4.997 4.997 0 0 1-4.288-2.427l-2.183.873a.75.75 0 0 1-.558-1.392l2.17-.868A5.036 5.036 0 0 1 3 11v-.5H.75a.75.75 0 0 1 0-1.5H3V7.258L.971 6.446a.75.75 0 0 1 .558-1.392l1.967.787c.265-.33.62-.583 1.03-.722a1.677 1.677 0 0 1-.026-.292V4.5c0-.951.38-1.814.995-2.444L4.72 1.28a.75.75 0 0 1 0-1.06Zm.53 6.28a.75.75 0 0 0-.75.75V11a3.5 3.5 0 1 0 7 0V7.25a.75.75 0 0 0-.75-.75ZM6.173 5h3.654A.172.172 0 0 0 10 4.827V4.5a2 2 0 1 0-4 0v.327c0 .096.077.173.173.173Z"/></svg>');--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M5 5.782V2.5h-.25a.75.75 0 0 1 0-1.5h6.5a.75.75 0 0 1 0 1.5H11v3.282l3.666 5.76C15.619 13.04 14.543 15 12.767 15H3.233c-1.776 0-2.852-1.96-1.899-3.458Zm-2.4 6.565a.75.75 0 0 0 .633 1.153h9.534a.75.75 0 0 0 .633-1.153L12.225 10.5h-8.45ZM9.5 2.5h-3V6c0 .143-.04.283-.117.403L4.73 9h6.54L9.617 6.403A.746.746 0 0 1 9.5 6Z"/></svg>');--md-admonition-icon--quote:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M1.75 2.5h10.5a.75.75 0 0 1 0 1.5H1.75a.75.75 0 0 1 0-1.5Zm4 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5Zm0 5h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1 0-1.5ZM2.5 7.75v6a.75.75 0 0 1-1.5 0v-6a.75.75 0 0 1 1.5 0Z"/></svg>');}</style><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../assets/_mkdocstrings.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><script id=__analytics>function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-5CR8QXF5CN"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-5CR8QXF5CN",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-5CR8QXF5CN",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script><script>"undefined"!=typeof __md_analytics&&__md_analytics()</script><meta property=og:type content=website><meta property=og:title content="Welcome to the Instructor Blog - Instructor"><meta property=og:description content="Enhancing OpenAI function calling with Pydantic"><meta property=og:image content=https://jxnl.github.io/instructor/assets/images/social/blog/index.png><meta property=og:image:type content=image/png><meta property=og:image:width content=1200><meta property=og:image:height content=630><meta content=https://jxnl.github.io/instructor/blog/ property=og:url><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Welcome to the Instructor Blog - Instructor"><meta name=twitter:description content="Enhancing OpenAI function calling with Pydantic"><meta name=twitter:image content=https://jxnl.github.io/instructor/assets/images/social/blog/index.png></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#welcome-to-the-instructor-blog class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title=Instructor class="md-header__button md-logo" aria-label=Instructor data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Instructor </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Welcome to the Instructor Blog </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> <input class=md-option data-md-color-media data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12c0-2.42-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <a href=javascript:void(0) class="md-search__icon md-icon" title=Share aria-label=Share data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/jxnl/instructor/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> instructor </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=Tabs data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=.. class=md-tabs__link> Introduction </a> </li> <li class=md-tabs__item> <a href=../concepts/prompting/ class=md-tabs__link> Tips </a> </li> <li class=md-tabs__item> <a href=../concepts/philosophy/ class=md-tabs__link> Concepts </a> </li> <li class=md-tabs__item> <a href=../examples/ class=md-tabs__link> Cookbook </a> </li> <li class=md-tabs__item> <a href=../cli/ class=md-tabs__link> CLI Reference </a> </li> <li class=md-tabs__item> <a href=../api/ class=md-tabs__link> API Reference </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=./ class=md-tabs__link> Blog </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title=Instructor class="md-nav__button md-logo" aria-label=Instructor data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Instructor </label> <div class=md-nav__source> <a href=https://github.com/jxnl/instructor/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> instructor </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_1> <div class="md-nav__link md-nav__container"> <a href=.. class="md-nav__link "> <span class=md-ellipsis> Introduction </span> </a> <label class="md-nav__link " for=__nav_1 id=__nav_1_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> Introduction </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../why/ class=md-nav__link> <span class=md-ellipsis> Why use Instructor? </span> </a> </li> <li class=md-nav__item> <a href=../help/ class=md-nav__link> <span class=md-ellipsis> Help with Instructor </span> </a> </li> <li class=md-nav__item> <a href=../installation/ class=md-nav__link> <span class=md-ellipsis> Installation </span> </a> </li> <li class=md-nav__item> <a href=../contributing/ class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../concepts/prompting/ class=md-nav__link> <span class=md-ellipsis> Tips </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Concepts </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Concepts </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../concepts/philosophy/ class=md-nav__link> <span class=md-ellipsis> Philosophy </span> </a> </li> <li class=md-nav__item> <a href=../concepts/models/ class=md-nav__link> <span class=md-ellipsis> Models </span> </a> </li> <li class=md-nav__item> <a href=../concepts/fields/ class=md-nav__link> <span class=md-ellipsis> Fields </span> </a> </li> <li class=md-nav__item> <a href=../concepts/maybe/ class=md-nav__link> <span class=md-ellipsis> Missing </span> </a> </li> <li class=md-nav__item> <a href=../concepts/patching/ class=md-nav__link> <span class=md-ellipsis> Patching </span> </a> </li> <li class=md-nav__item> <a href=../concepts/lists/ class=md-nav__link> <span class=md-ellipsis> Streaming </span> </a> </li> <li class=md-nav__item> <a href=../concepts/fastapi/ class=md-nav__link> <span class=md-ellipsis> FastAPI </span> </a> </li> <li class=md-nav__item> <a href=../concepts/caching/ class=md-nav__link> <span class=md-ellipsis> Caching </span> </a> </li> <li class=md-nav__item> <a href=../concepts/reask_validation/ class=md-nav__link> <span class=md-ellipsis> Validators </span> </a> </li> <li class=md-nav__item> <a href=../concepts/distillation/ class=md-nav__link> <span class=md-ellipsis> Distillation </span> </a> </li> <li class=md-nav__item> <a href=../concepts/types/ class=md-nav__link> <span class=md-ellipsis> Types </span> </a> </li> <li class=md-nav__item> <a href=../concepts/union/ class=md-nav__link> <span class=md-ellipsis> Union </span> </a> </li> <li class=md-nav__item> <a href=../concepts/alias/ class=md-nav__link> <span class=md-ellipsis> Alias </span> </a> </li> <li class=md-nav__item> <a href=../concepts/typeadapter/ class=md-nav__link> <span class=md-ellipsis> Type Adapter </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <div class="md-nav__link md-nav__container"> <a href=../examples/ class="md-nav__link "> <span class=md-ellipsis> Cookbook </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Cookbook </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../examples/classification/ class=md-nav__link> <span class=md-ellipsis> Text Classification </span> </a> </li> <li class=md-nav__item> <a href=../examples/self_critique/ class=md-nav__link> <span class=md-ellipsis> Self Critique </span> </a> </li> <li class=md-nav__item> <a href=../examples/exact_citations/ class=md-nav__link> <span class=md-ellipsis> Citations </span> </a> </li> <li class=md-nav__item> <a href=../examples/knowledge_graph/ class=md-nav__link> <span class=md-ellipsis> Knowledge Graph </span> </a> </li> <li class=md-nav__item> <a href=../examples/entity_resolution/ class=md-nav__link> <span class=md-ellipsis> Entity Resolution </span> </a> </li> <li class=md-nav__item> <a href=../examples/search/ class=md-nav__link> <span class=md-ellipsis> Search Queries </span> </a> </li> <li class=md-nav__item> <a href=../examples/planning-tasks/ class=md-nav__link> <span class=md-ellipsis> Query Decomposition </span> </a> </li> <li class=md-nav__item> <a href=../examples/recursive/ class=md-nav__link> <span class=md-ellipsis> Recursive Schemas </span> </a> </li> <li class=md-nav__item> <a href=../examples/autodataframe/ class=md-nav__link> <span class=md-ellipsis> Table Extraction </span> </a> </li> <li class=md-nav__item> <a href=../examples/action_items/ class=md-nav__link> <span class=md-ellipsis> Action Item and Dependency Mapping </span> </a> </li> <li class=md-nav__item> <a href=../examples/gpt-engineer/ class=md-nav__link> <span class=md-ellipsis> Multi-File Code Generation </span> </a> </li> <li class=md-nav__item> <a href=../examples/pii/ class=md-nav__link> <span class=md-ellipsis> PII Data Sanitization </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <div class="md-nav__link md-nav__container"> <a href=../cli/ class="md-nav__link "> <span class=md-ellipsis> CLI Reference </span> </a> <label class="md-nav__link " for=__nav_5 id=__nav_5_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> CLI Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../cli/finetune/ class=md-nav__link> <span class=md-ellipsis> Finetuning GPT-3.5 </span> </a> </li> <li class=md-nav__item> <a href=../cli/usage/ class=md-nav__link> <span class=md-ellipsis> Usage Tracking </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex> <span class=md-ellipsis> API Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> API Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../api/ class=md-nav__link> <span class=md-ellipsis> Core Library </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7 checked> <div class="md-nav__link md-nav__container"> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Blog </span> </a> <label class="md-nav__link md-nav__link--active" for=__nav_7 id=__nav_7_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=true> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_7_2> <label class=md-nav__link for=__nav_7_2 id=__nav_7_2_label tabindex> <span class=md-ellipsis> Archive </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_7_2_label aria-expanded=false> <label class=md-nav__title for=__nav_7_2> <span class="md-nav__icon md-icon"></span> Archive </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=archive/2023/ class=md-nav__link> <span class=md-ellipsis> 2023 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#advanced-topics class=md-nav__link> <span class=md-ellipsis> Advanced Topics </span> </a> </li> <li class=md-nav__item> <a href=#learning-python class=md-nav__link> <span class=md-ellipsis> Learning Python </span> </a> </li> <li class=md-nav__item> <a href=#talks class=md-nav__link> <span class=md-ellipsis> Talks </span> </a> </li> <li class=md-nav__item> <a href=#introduction-to-caching-in-python class=md-nav__link> <span class=md-ellipsis> Introduction to Caching in Python </span> </a> </li> <li class=md-nav__item> <a href=#generators-and-llm-streaming class=md-nav__link> <span class=md-ellipsis> Generators and LLM Streaming </span> </a> </li> <li class=md-nav__item> <a href=#verifying-llm-citations-with-pydantic class=md-nav__link> <span class=md-ellipsis> Verifying LLM Citations with Pydantic </span> </a> </li> <li class=md-nav__item> <a href=#introduction-to-batch-processing-using-asyncio-and-instructor class=md-nav__link> <span class=md-ellipsis> Introduction to Batch Processing using asyncio and Instructor </span> </a> </li> <li class=md-nav__item> <a href=#smarter-summaries-w-finetuning-gpt-35-and-chain-of-density class=md-nav__link> <span class=md-ellipsis> Smarter Summaries w/ Finetuning GPT-3.5 and Chain of Density </span> </a> </li> <li class=md-nav__item> <a href=#ai-engineer-keynote-pydantic-is-all-you-need class=md-nav__link> <span class=md-ellipsis> AI Engineer Keynote: Pydantic is all you need </span> </a> </li> <li class=md-nav__item> <a href=#good-llm-validation-is-just-good-validation class=md-nav__link> <span class=md-ellipsis> Good LLM Validation is Just Good Validation </span> </a> </li> <li class=md-nav__item> <a href=#enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation class=md-nav__link> <span class=md-ellipsis> Enhancing Python Functions with Instructor: A Guide to Fine-Tuning and Distillation </span> </a> </li> <li class=md-nav__item> <a href=#rag-is-more-than-just-embedding-search class=md-nav__link> <span class=md-ellipsis> RAG is more than just embedding search </span> </a> </li> <li class=md-nav__item> <a href=#bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls class=md-nav__link> <span class=md-ellipsis> Bridging Language Models with Python using Instructor, Pydantic, and OpenAI's Function Calls </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <div class=md-content__inner> <header class=md-typeset> <h1 id=welcome-to-the-instructor-blog>Welcome to the Instructor Blog<a class=headerlink href=#welcome-to-the-instructor-blog title="Permanent link">&para;</a></h1> <p>The goal of the blog is to capture some content that does not neatly fit within documentation or the cookbooks.</p> <h2 id=advanced-topics>Advanced Topics<a class=headerlink href=#advanced-topics title="Permanent link">&para;</a></h2> <ol> <li><a href=2023/09/17/rag-is-more-than-just-embedding-search/ >What is Query Understanding, how does it go beyond embeddings?</a></li> <li><a href=2023/11/05/chain-of-density/ >How can one achieve GPT-4 level summaries using GPT-3.5-turbo?</a></li> <li><a href=2023/10/23/good-llm-validation-is-just-good-validation/ >What are the basics of Guardrails and Validation in AI models?</a></li> <li><a href=2023/11/18/validate-citations/ >How does one validate citations in AI-generated content?</a></li> <li><a href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/ >What are the methods and benefits of fine-tuning and distillation in AI models?</a></li> </ol> <h2 id=learning-python>Learning Python<a class=headerlink href=#learning-python title="Permanent link">&para;</a></h2> <ul> <li><a href=2023/11/26/python-caching/ >How can I effectively cache my functions in Python?</a></li> <li><a href=2023/11/13/learn-async/ >What are the fundamentals of batch processing with async in Python?</a></li> <li><a href=posts/generators.md>How can I stream models to improve latency?</a></li> </ul> <h2 id=talks>Talks<a class=headerlink href=#talks title="Permanent link">&para;</a></h2> <ul> <li><a href=2023/11/02/ai-engineer-keynote-pydantic-is-all-you-need/ >What were the key insights and topics covered at the AI Engineering Summit 2023?</a></li> </ul> </header> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1724672723748638720/qOBwmkOI_400x400.jpg alt="Jason Liu"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-11-26 00:00:00">2023/11/26</time></li> <li class=md-meta__item> 7 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=introduction-to-caching-in-python><a href=2023/11/26/python-caching/ class=toclink>Introduction to Caching in Python</a></h2> <blockquote> <p>Instructor makes working with language models easy, but they are still computationally expensive.</p> </blockquote> <p>Today, we're diving into optimizing instructor code while maintaining the excellent DX offered by <a href=https://docs.pydantic.dev/latest/ >Pydantic</a> models. We'll tackle the challenges of caching Pydantic models, typically incompatible with <code>pickle</code>, and explore solutions that use <code>decorators</code> like <code>functools.cache</code>. Then, we'll craft custom decorators with <code>diskcache</code> and <code>redis</code> to support persistent caching and distributed systems.</p> <p>Lets first consider our canonical example, using the <code>OpenAI</code> Python client to extract user details.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=c1># Enables `response_model`</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=k>class</span> <span class=nc>UserDetail</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=k>def</span> <span class=nf>extract</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>UserDetail</span><span class=p>:</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>    <span class=k>return</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>UserDetail</span><span class=p>,</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=n>data</span><span class=p>},</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>    <span class=p>]</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=p>)</span>
</span></code></pre></div> <p>Now imagine batch processing data, running tests or experiments, or simply calling <code>extract</code> multiple times over a workflow. We'll quickly run into performance issues, as the function may be called repeatedly, and the same data will be processed over and over again, costing us time and money.</p> <h3 id=1-functoolscache-for-simple-in-memory-caching><a class=toclink href=2023/11/26/python-caching/#1-functoolscache-for-simple-in-memory-caching>1. <code>functools.cache</code> for Simple In-Memory Caching</a></h3> <p><strong>When to Use</strong>: Ideal for functions with immutable arguments, called repeatedly with the same parameters in small to medium-sized applications. This makes sense when we might be reusing the same data within a single session or in an application where we don't need to persist the cache between sessions.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kn>import</span> <span class=nn>functools</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=nd>@functools</span><span class=o>.</span><span class=n>cache</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=k>def</span> <span class=nf>extract</span><span class=p>(</span><span class=n>data</span><span class=p>):</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>    <span class=k>return</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>        <span class=n>response_model</span><span class=o>=</span><span class=n>UserDetail</span><span class=p>,</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>            <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=n>data</span><span class=p>},</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>        <span class=p>]</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>    <span class=p>)</span>
</span></code></pre></div> <div class="admonition warning"> <p class=admonition-title>Changing the Model does not Invalidate the Cache</p> <p>Note that changing the model does not invalidate the cache. This is because the cache key is based on the function's name and arguments, not the model. This means that if we change the model, the cache will still return the old result.</p> </div> <p>Now we can call <code>extract</code> multiple times with the same argument, and the result will be cached in memory for faster access.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>import</span> <span class=nn>time</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span> <span class=c1># (1)</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=hll><span class=n>model</span> <span class=o>=</span> <span class=n>extract</span><span class=p>(</span><span class=s2>&quot;Extract jason is 25 years old&quot;</span><span class=p>)</span>
</span></span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Time taken: </span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=n>start</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=hll><span class=n>model</span> <span class=o>=</span> <span class=n>extract</span><span class=p>(</span><span class=s2>&quot;Extract jason is 25 years old&quot;</span><span class=p>)</span> <span class=c1># (2)</span>
</span></span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Time taken: </span><span class=si>{</span><span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=o>&gt;&gt;&gt;</span> <span class=n>Time</span> <span class=n>taken</span><span class=p>:</span> <span class=mf>0.9267581660533324</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=hll><span class=o>&gt;&gt;&gt;</span> <span class=n>Time</span> <span class=n>taken</span><span class=p>:</span> <span class=mf>1.2080417945981026e-06</span> <span class=c1># (3)</span>
</span></span></code></pre></div> <ol> <li>Using <code>time.perf_counter()</code> to measure the time taken to run the function is better than using <code>time.time()</code> because it's more accurate and less susceptible to system clock changes.</li> <li>The second time we call <code>extract</code>, the result is returned from the cache, and the function is not called.</li> <li>The second call to <code>extract</code> is much faster because the result is returned from the cache!</li> </ol> <p><strong>Benefits</strong>: Easy to implement, provides fast access due to in-memory storage, and requires no additional libraries.</p> <details class=question> <summary>What is a decorator?</summary> <p>A decorator is a function that takes another function and extends the behavior of the latter function without explicitly modifying it. In Python, decorators are functions that take a function as an argument and return a closure.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>def</span> <span class=nf>decorator</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=hll>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Do something before&quot;</span><span class=p>)</span> <span class=c1># (1)</span>
</span></span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=hll>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=hll>        <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Do something after&quot;</span><span class=p>)</span> <span class=c1># (2)</span>
</span></span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>        <span class=k>return</span> <span class=n>result</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    <span class=k>return</span> <span class=n>wrapper</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=hll><span class=nd>@decorator</span>
</span></span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=k>def</span> <span class=nf>say_hello</span><span class=p>():</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>    <span class=nb>print</span><span class=p>(</span><span class=s2>&quot;Hello!&quot;</span><span class=p>)</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=n>say_hello</span><span class=p>()</span>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=o>&gt;&gt;&gt;</span> <span class=s2>&quot;Do something before&quot;</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=o>&gt;&gt;&gt;</span> <span class=s2>&quot;Hello!&quot;</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=o>&gt;&gt;&gt;</span> <span class=s2>&quot;Do something after&quot;</span>
</span></code></pre></div> <ol> <li>The code is executed before the function is called</li> <li>The code is executed after the function is called</li> </ol> </details> <h3 id=2-diskcache-for-persistent-large-data-caching><a class=toclink href=2023/11/26/python-caching/#2-diskcache-for-persistent-large-data-caching>2. <code>diskcache</code> for Persistent, Large Data Caching</a></h3> <details class=note> <summary>Copy Caching Code</summary> <p>We'll be using the same <code>instructor_cache</code> decorator for both <code>diskcache</code> and <code>redis</code> caching. You can copy the code below and use it for both examples.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kn>import</span> <span class=nn>functools</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kn>import</span> <span class=nn>inspect</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=kn>import</span> <span class=nn>diskcache</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=n>cache</span> <span class=o>=</span> <span class=n>diskcache</span><span class=o>.</span><span class=n>Cache</span><span class=p>(</span><span class=s1>&#39;./my_cache_directory&#39;</span><span class=p>)</span> <span class=c1># (1)</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=k>def</span> <span class=nf>instructor_cache</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Cache a function that returns a Pydantic model&quot;&quot;&quot;</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>    <span class=n>return_type</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>signature</span><span class=p>(</span><span class=n>func</span><span class=p>)</span><span class=o>.</span><span class=n>return_annotation</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>issubclass</span><span class=p>(</span><span class=n>return_type</span><span class=p>,</span> <span class=n>BaseModel</span><span class=p>):</span> <span class=c1># (2)</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;The return type must be a Pydantic model&quot;</span><span class=p>)</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>    <span class=nd>@functools</span><span class=o>.</span><span class=n>wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>        <span class=n>key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>functools</span><span class=o>.</span><span class=n>_make_key</span><span class=p>(</span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=n>kwargs</span><span class=p>,</span><span class=w> </span><span class=n>typed</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>        <span class=c1># Check if the result is already cached</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>        <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>:=</span> <span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>))</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>            <span class=c1># Deserialize from JSON based on the return type</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>            <span class=k>return</span> <span class=n>return_type</span><span class=o>.</span><span class=n>model_validate_json</span><span class=p>(</span><span class=n>cached</span><span class=p>)</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a>        <span class=c1># Call the function and cache its result</span>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a>        <span class=n>serialized_result</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>model_dump_json</span><span class=p>()</span>
</span><span id=__span-4-24><a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a>        <span class=n>cache</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>serialized_result</span><span class=p>)</span>
</span><span id=__span-4-25><a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a>
</span><span id=__span-4-26><a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a>        <span class=k>return</span> <span class=n>result</span>
</span><span id=__span-4-27><a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a>
</span><span id=__span-4-28><a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a>    <span class=k>return</span> <span class=n>wrapper</span>
</span></code></pre></div> <ol> <li>We create a new <code>diskcache.Cache</code> instance to store the cached data. This will create a new directory called <code>my_cache_directory</code> in the current working directory.</li> <li>We only want to cache functions that return a Pydantic model to simplify serialization and deserialization logic in this example code</li> </ol> <p>Remember that you can change this code to support non-Pydantic models, or to use a different caching backend. More over, don't forget that this cache does not invalidate when the model changes, so you might want to encode the <code>Model.model_json_schema()</code> as part of the key.</p> </details> <p><strong>When to Use</strong>: Suitable for applications needing cache persistence between sessions or dealing with large datasets. This is useful when we want to reuse the same data across multiple sessions, or when we need to store large amounts of data!</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>import</span> <span class=nn>functools</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=kn>import</span> <span class=nn>inspect</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=kn>import</span> <span class=nn>diskcache</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=hll><span class=n>cache</span> <span class=o>=</span> <span class=n>diskcache</span><span class=o>.</span><span class=n>Cache</span><span class=p>(</span><span class=s1>&#39;./my_cache_directory&#39;</span><span class=p>)</span>
</span></span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=k>def</span> <span class=nf>instructor_cache</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Cache a function that returns a Pydantic model&quot;&quot;&quot;</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>    <span class=n>return_type</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>signature</span><span class=p>(</span><span class=n>func</span><span class=p>)</span><span class=o>.</span><span class=n>return_annotation</span> <span class=c1># (4)</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>issubclass</span><span class=p>(</span><span class=n>return_type</span><span class=p>,</span> <span class=n>BaseModel</span><span class=p>):</span> <span class=c1># (1)</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;The return type must be a Pydantic model&quot;</span><span class=p>)</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>    <span class=nd>@functools</span><span class=o>.</span><span class=n>wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>        <span class=n>key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>functools</span><span class=o>.</span><span class=n>_make_key</span><span class=p>(</span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=n>kwargs</span><span class=p>,</span><span class=w> </span><span class=n>typed</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span> <span class=c1>#  (2)</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>        <span class=c1># Check if the result is already cached</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>        <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>:=</span> <span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>))</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>            <span class=c1># Deserialize from JSON based on the return type (3)</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a>            <span class=k>return</span> <span class=n>return_type</span><span class=o>.</span><span class=n>model_validate_json</span><span class=p>(</span><span class=n>cached</span><span class=p>)</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>        <span class=c1># Call the function and cache its result</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span><span id=__span-5-29><a id=__codelineno-5-29 name=__codelineno-5-29 href=#__codelineno-5-29></a>        <span class=n>serialized_result</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>model_dump_json</span><span class=p>()</span>
</span><span id=__span-5-30><a id=__codelineno-5-30 name=__codelineno-5-30 href=#__codelineno-5-30></a>        <span class=n>cache</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>serialized_result</span><span class=p>)</span>
</span><span id=__span-5-31><a id=__codelineno-5-31 name=__codelineno-5-31 href=#__codelineno-5-31></a>
</span><span id=__span-5-32><a id=__codelineno-5-32 name=__codelineno-5-32 href=#__codelineno-5-32></a>        <span class=k>return</span> <span class=n>result</span>
</span><span id=__span-5-33><a id=__codelineno-5-33 name=__codelineno-5-33 href=#__codelineno-5-33></a>
</span><span id=__span-5-34><a id=__codelineno-5-34 name=__codelineno-5-34 href=#__codelineno-5-34></a>    <span class=k>return</span> <span class=n>wrapper</span>
</span><span id=__span-5-35><a id=__codelineno-5-35 name=__codelineno-5-35 href=#__codelineno-5-35></a>
</span><span id=__span-5-36><a id=__codelineno-5-36 name=__codelineno-5-36 href=#__codelineno-5-36></a><span class=k>class</span> <span class=nc>UserDetail</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-5-37><a id=__codelineno-5-37 name=__codelineno-5-37 href=#__codelineno-5-37></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-5-38><a id=__codelineno-5-38 name=__codelineno-5-38 href=#__codelineno-5-38></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-5-39><a id=__codelineno-5-39 name=__codelineno-5-39 href=#__codelineno-5-39></a>
</span><span id=__span-5-40><a id=__codelineno-5-40 name=__codelineno-5-40 href=#__codelineno-5-40></a><span class=nd>@instructor_cache</span>
</span><span id=__span-5-41><a id=__codelineno-5-41 name=__codelineno-5-41 href=#__codelineno-5-41></a><span class=k>def</span> <span class=nf>extract</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>UserDetail</span><span class=p>:</span>
</span><span id=__span-5-42><a id=__codelineno-5-42 name=__codelineno-5-42 href=#__codelineno-5-42></a>    <span class=k>return</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-5-43><a id=__codelineno-5-43 name=__codelineno-5-43 href=#__codelineno-5-43></a>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-5-44><a id=__codelineno-5-44 name=__codelineno-5-44 href=#__codelineno-5-44></a>        <span class=n>response_model</span><span class=o>=</span><span class=n>UserDetail</span><span class=p>,</span>
</span><span id=__span-5-45><a id=__codelineno-5-45 name=__codelineno-5-45 href=#__codelineno-5-45></a>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-5-46><a id=__codelineno-5-46 name=__codelineno-5-46 href=#__codelineno-5-46></a>            <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=n>data</span><span class=p>},</span>
</span><span id=__span-5-47><a id=__codelineno-5-47 name=__codelineno-5-47 href=#__codelineno-5-47></a>        <span class=p>]</span>
</span><span id=__span-5-48><a id=__codelineno-5-48 name=__codelineno-5-48 href=#__codelineno-5-48></a>    <span class=p>)</span>
</span></code></pre></div> <ol> <li>We only want to cache functions that return a Pydantic model to simplify serialization and deserialization logic</li> <li>We use functool's <code>_make_key</code> to generate a unique key based on the function's name and arguments. This is important because we want to cache the result of each function call separately.</li> <li>We use Pydantic's <code>model_validate_json</code> to deserialize the cached result into a Pydantic model.</li> <li>We use <code>inspect.signature</code> to get the function's return type annotation, which we use to validate the cached result.</li> </ol> <p><strong>Benefits</strong>: Reduces computation time for heavy data processing, provides disk-based caching for persistence.</p> <h3 id=2-redis-caching-decorator-for-distributed-systems><a class=toclink href=2023/11/26/python-caching/#2-redis-caching-decorator-for-distributed-systems>2. Redis Caching Decorator for Distributed Systems</a></h3> <details class=note> <summary>Copy Caching Code</summary> <p>We'll be using the same <code>instructor_cache</code> decorator for both <code>diskcache</code> and <code>redis</code> caching. You can copy the code below and use it for both examples.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kn>import</span> <span class=nn>functools</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=kn>import</span> <span class=nn>inspect</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=kn>import</span> <span class=nn>redis</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=n>cache</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=s2>&quot;localhost&quot;</span><span class=p>)</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=k>def</span> <span class=nf>instructor_cache</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Cache a function that returns a Pydantic model&quot;&quot;&quot;</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>    <span class=n>return_type</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>signature</span><span class=p>(</span><span class=n>func</span><span class=p>)</span><span class=o>.</span><span class=n>return_annotation</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>issubclass</span><span class=p>(</span><span class=n>return_type</span><span class=p>,</span> <span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;The return type must be a Pydantic model&quot;</span><span class=p>)</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>    <span class=nd>@functools</span><span class=o>.</span><span class=n>wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>        <span class=n>key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>functools</span><span class=o>.</span><span class=n>_make_key</span><span class=p>(</span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=n>kwargs</span><span class=p>,</span><span class=w> </span><span class=n>typed</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>        <span class=c1># Check if the result is already cached</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a>        <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>:=</span> <span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>))</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>            <span class=c1># Deserialize from JSON based on the return type</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>            <span class=k>return</span> <span class=n>return_type</span><span class=o>.</span><span class=n>model_validate_json</span><span class=p>(</span><span class=n>cached</span><span class=p>)</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a>        <span class=c1># Call the function and cache its result</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>        <span class=n>serialized_result</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>model_dump_json</span><span class=p>()</span>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a>        <span class=n>cache</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>serialized_result</span><span class=p>)</span>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a>
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>        <span class=k>return</span> <span class=n>result</span>
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a>    <span class=k>return</span> <span class=n>wrapper</span>
</span></code></pre></div> <p>Remember that you can change this code to support non-Pydantic models, or to use a different caching backend. More over, don't forget that this cache does not invalidate when the model changes, so you might want to encode the <code>Model.model_json_schema()</code> as part of the key.</p> </details> <p><strong>When to Use</strong>: Recommended for distributed systems where multiple processes need to access the cached data, or for applications requiring fast read/write access and handling complex data structures.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=kn>import</span> <span class=nn>redis</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=kn>import</span> <span class=nn>functools</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=kn>import</span> <span class=nn>inspect</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=kn>import</span> <span class=nn>json</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=n>cache</span> <span class=o>=</span> <span class=n>redis</span><span class=o>.</span><span class=n>Redis</span><span class=p>(</span><span class=s2>&quot;localhost&quot;</span><span class=p>)</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>
</span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=k>def</span> <span class=nf>instructor_cache</span><span class=p>(</span><span class=n>func</span><span class=p>):</span>
</span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Cache a function that returns a Pydantic model&quot;&quot;&quot;</span>
</span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a>    <span class=n>return_type</span> <span class=o>=</span> <span class=n>inspect</span><span class=o>.</span><span class=n>signature</span><span class=p>(</span><span class=n>func</span><span class=p>)</span><span class=o>.</span><span class=n>return_annotation</span>
</span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a>    <span class=k>if</span> <span class=ow>not</span> <span class=nb>issubclass</span><span class=p>(</span><span class=n>return_type</span><span class=p>,</span> <span class=n>BaseModel</span><span class=p>):</span> <span class=c1># (1)</span>
</span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;The return type must be a Pydantic model&quot;</span><span class=p>)</span>
</span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a>
</span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a>    <span class=nd>@functools</span><span class=o>.</span><span class=n>wraps</span><span class=p>(</span><span class=n>func</span><span class=p>)</span>
</span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a>    <span class=k>def</span> <span class=nf>wrapper</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a>        <span class=n>key</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>func</span><span class=o>.</span><span class=vm>__name__</span><span class=si>}</span><span class=s2>-</span><span class=si>{</span><span class=n>functools</span><span class=o>.</span><span class=n>_make_key</span><span class=p>(</span><span class=n>args</span><span class=p>,</span><span class=w> </span><span class=n>kwargs</span><span class=p>,</span><span class=w> </span><span class=n>typed</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span> <span class=c1># (2)</span>
</span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a>        <span class=c1># Check if the result is already cached</span>
</span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a>        <span class=k>if</span> <span class=p>(</span><span class=n>cached</span> <span class=o>:=</span> <span class=n>cache</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>key</span><span class=p>))</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a>            <span class=c1># Deserialize from JSON based on the return type</span>
</span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a>            <span class=k>return</span> <span class=n>return_type</span><span class=o>.</span><span class=n>model_validate_json</span><span class=p>(</span><span class=n>cached</span><span class=p>)</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a>        <span class=c1># Call the function and cache its result</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a>        <span class=n>result</span> <span class=o>=</span> <span class=n>func</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a>        <span class=n>serialized_result</span> <span class=o>=</span> <span class=n>result</span><span class=o>.</span><span class=n>model_dump_json</span><span class=p>()</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a>        <span class=n>cache</span><span class=o>.</span><span class=n>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=n>serialized_result</span><span class=p>)</span>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a>
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a>        <span class=k>return</span> <span class=n>result</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a>    <span class=k>return</span> <span class=n>wrapper</span>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a><span class=k>class</span> <span class=nc>UserDetail</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a>
</span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a><span class=nd>@instructor_cache</span>
</span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a><span class=k>def</span> <span class=nf>extract</span><span class=p>(</span><span class=n>data</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>UserDetail</span><span class=p>:</span>
</span><span id=__span-7-43><a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a>    <span class=c1># Assuming client.chat.completions.create returns a UserDetail instance</span>
</span><span id=__span-7-44><a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a>    <span class=k>return</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-7-45><a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-7-46><a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a>        <span class=n>response_model</span><span class=o>=</span><span class=n>UserDetail</span><span class=p>,</span>
</span><span id=__span-7-47><a id=__codelineno-7-47 name=__codelineno-7-47 href=#__codelineno-7-47></a>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-7-48><a id=__codelineno-7-48 name=__codelineno-7-48 href=#__codelineno-7-48></a>            <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=n>data</span><span class=p>},</span>
</span><span id=__span-7-49><a id=__codelineno-7-49 name=__codelineno-7-49 href=#__codelineno-7-49></a>        <span class=p>]</span>
</span><span id=__span-7-50><a id=__codelineno-7-50 name=__codelineno-7-50 href=#__codelineno-7-50></a>    <span class=p>)</span>
</span></code></pre></div> <ol> <li>We only want to cache functions that return a Pydantic model to simplify serialization and deserialization logic</li> <li>We use functool's <code>_make_key</code> to generate a unique key based on the function's name and arguments. This is important because we want to cache the result of each function call separately.</li> </ol> <p><strong>Benefits</strong>: Scalable for large-scale systems, supports fast in-memory data storage and retrieval, and is versatile for various data types.</p> <div class="admonition note"> <p class=admonition-title>Looking carefully</p> <p>If you look carefully at the code above you'll notice that we're using the same <code>instructor_cache</code> decorator as before. The implementatino is the same, but we're using a different caching backend!</p> </div> <h3 id=conclusion><a class=toclink href=2023/11/26/python-caching/#conclusion>Conclusion</a></h3> <p>Choosing the right caching strategy depends on your application's specific needs, such as the size and type of data, the need for persistence, and the system's architecture. Whether it's optimizing a function's performance in a small application or managing large datasets in a distributed environment, Python offers robust solutions to improve efficiency and reduce computational overhead.</p> <p>If you'd like to use this code, try to send it over to ChatGPT to understand it more, and to add additional features that might matter for you, for example, the cache isn't invalidated when your BaseModel changes, so you might want to encode the <code>Model.model_json_schema()</code> as part of the key.</p> <p>If you like the content check out our <a href=https://github.com/jxnl/instructor>GitHub</a> as give us a star and checkout the library.</p> <nav class=md-post__action> <a href=2023/11/26/python-caching/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1724672723748638720/qOBwmkOI_400x400.jpg alt="Jason Liu"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-11-26 00:00:00">2023/11/26</time></li> <li class=md-meta__item> 6 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=generators-and-llm-streaming><a href=2023/11/26/python-generators-and-llm-streaming/ class=toclink>Generators and LLM Streaming</a></h2> <p>Latency is crucial, especially in eCommerce and newer chat applications like ChatGPT. Streaming is the solution that enables us to enhance the user experience without the need for faster response times.</p> <p>And what makes streaming possible? Generators!</p> <p>In this post, we're going to dive into the cool world of Python generators  these tools are more than just a coding syntax trick. We'll explore Python generators from the ground up and then delve into LLM streaming using the Instructor library.</p> <h3 id=python-generators-an-efficient-approach-to-iterables><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#python-generators-an-efficient-approach-to-iterables>Python Generators: An Efficient Approach to Iterables</a></h3> <p>Generators in Python are a game-changer for handling large data sets and stream processing. They allow functions to yield values one at a time, pausing and resuming their state, which is a faster and more memory-efficient approach compared to traditional collections that store all elements in memory.</p> <h4 id=the-basics-yielding-values><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#the-basics-yielding-values>The Basics: Yielding Values</a></h4> <p>A generator function in Python uses the <code>yield</code> keyword. It yields values one at a time, allowing the function to pause and resume its state.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>def</span> <span class=nf>count_to_3</span><span class=p>():</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>    <span class=k>yield</span> <span class=mi>1</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>    <span class=k>yield</span> <span class=mi>2</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>    <span class=k>yield</span> <span class=mi>3</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=k>for</span> <span class=n>num</span> <span class=ow>in</span> <span class=n>count_to_3</span><span class=p>():</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>    <span class=nb>print</span><span class=p>(</span><span class=n>num</span><span class=p>)</span>
</span></code></pre></div> <div class="language-text highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>1
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>2
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>3
</span></code></pre></div> <h4 id=advantages-over-traditional-collections><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#advantages-over-traditional-collections>Advantages Over Traditional Collections</a></h4> <ul> <li><strong>Lazy Evaluation &amp; reduced latency</strong>: The time to get the first element (or time-to-first-token in LLM land) from a generator is significantly lower. Generators only produce one value at a time, whereas accessing the first element of a collection will require that the whole collection be created first.</li> <li><strong>Memory Efficiency</strong>: Only one item is in memory at a time.</li> <li><strong>Maintain State</strong>: Automatically maintains state between executions.</li> </ul> <p>Let's see how much faster generators are and where they really shine:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>import</span> <span class=nn>time</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=k>def</span> <span class=nf>expensive_func</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Simulate an expensive operation.&quot;&quot;&quot;</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>    <span class=n>time</span><span class=o>.</span><span class=n>sleep</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>    <span class=k>return</span> <span class=n>x</span> <span class=o>**</span> <span class=mi>2</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=k>def</span> <span class=nf>calculate_time_for_first_result_with_list</span><span class=p>(</span><span class=n>func_input</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Calculate using a list comprehension and return the first result with its computation time.&quot;&quot;&quot;</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>    <span class=n>start_perf</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>    <span class=n>result</span> <span class=o>=</span> <span class=p>[</span><span class=n>func</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>func_input</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>    <span class=n>end_perf</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Time for first result (list): </span><span class=si>{</span><span class=n>end_perf</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start_perf</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> seconds&quot;</span><span class=p>)</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>    <span class=k>return</span> <span class=n>result</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=k>def</span> <span class=nf>calculate_time_for_first_result_with_generator</span><span class=p>(</span><span class=n>func_input</span><span class=p>,</span> <span class=n>func</span><span class=p>):</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;Calculate using a generator and return the first result with its computation time.&quot;&quot;&quot;</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a>    <span class=n>start_perf</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span><span id=__span-2-19><a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a>    <span class=n>result</span> <span class=o>=</span> <span class=nb>next</span><span class=p>(</span><span class=n>func</span><span class=p>(</span><span class=n>x</span><span class=p>)</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=n>func_input</span><span class=p>)</span>
</span><span id=__span-2-20><a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a>    <span class=n>end_perf</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span><span id=__span-2-21><a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Time for first result (generator): </span><span class=si>{</span><span class=n>end_perf</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start_perf</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> seconds&quot;</span><span class=p>)</span>
</span><span id=__span-2-22><a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a>    <span class=k>return</span> <span class=n>result</span>
</span><span id=__span-2-23><a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a>
</span><span id=__span-2-24><a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=c1># Prepare inputs for the function</span>
</span><span id=__span-2-25><a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a><span class=n>numbers</span> <span class=o>=</span> <span class=p>[</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>3</span><span class=p>,</span> <span class=mi>4</span><span class=p>,</span> <span class=mi>5</span><span class=p>]</span>
</span><span id=__span-2-26><a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>
</span><span id=__span-2-27><a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a><span class=c1># Benchmarking</span>
</span><span id=__span-2-28><a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a><span class=n>first_result_list</span> <span class=o>=</span> <span class=n>calculate_time_for_first_result_with_list</span><span class=p>(</span><span class=n>numbers</span><span class=p>,</span> <span class=n>expensive_func</span><span class=p>)</span>
</span><span id=__span-2-29><a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a><span class=n>first_result_gen</span> <span class=o>=</span> <span class=n>calculate_time_for_first_result_with_generator</span><span class=p>(</span><span class=n>numbers</span><span class=p>,</span> <span class=n>expensive_func</span><span class=p>)</span>
</span></code></pre></div> <div class="language-text highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>Time for first result (list): 5.02 seconds
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>Time for first result (generator): 1.01 seconds
</span></code></pre></div> <p>The generator computes one expensive operation and returns the first result immediately, while the list comprehension computes the expensive operation for all elements in the list before returning the first result.</p> <h4 id=generator-expressions-a-shortcut><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#generator-expressions-a-shortcut>Generator Expressions: A Shortcut</a></h4> <p>Python also allows creating generators in a single line of code, known as generator expressions. They are syntactically similar to list comprehensions but use parentheses.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=n>squares</span> <span class=o>=</span> <span class=p>(</span><span class=n>x</span><span class=o>*</span><span class=n>x</span> <span class=k>for</span> <span class=n>x</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span>
</span></code></pre></div> <h4 id=use-cases-in-real-world-applications><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#use-cases-in-real-world-applications>Use Cases in Real-World Applications</a></h4> <p>Generators shine in scenarios like reading large files, data streaming (eg. llm token streaming), and pipeline creation for data processing.</p> <h3 id=llm-streaming><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#llm-streaming>LLM Streaming</a></h3> <p>If you've used ChatGPT, you'll see that the tokens are streamed out one by one, instead of the full response being shown at the end (can you imagine waiting for the full response??). This is made possible by generators.</p> <p>Here's how a vanilla openai generator looks:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=c1># Set your OpenAI API key</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=n>client</span> <span class=o>=</span> <span class=n>OpenAI</span><span class=p>(</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>    <span class=n>api_key</span><span class=o>=</span><span class=s2>&quot;My API Key&quot;</span><span class=p>,</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=p>)</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=n>response_generator</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>    <span class=n>model</span><span class=o>=</span><span class=s1>&#39;gpt-3.5-turbo&#39;</span><span class=p>,</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>        <span class=p>{</span><span class=s1>&#39;role&#39;</span><span class=p>:</span> <span class=s1>&#39;user&#39;</span><span class=p>,</span> <span class=s1>&#39;content&#39;</span><span class=p>:</span> <span class=s2>&quot;What are some good reasons to smile?&quot;</span><span class=p>}</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>    <span class=p>],</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>    <span class=n>temperature</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>    <span class=n>stream</span><span class=o>=</span><span class=kc>True</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=p>)</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=k>for</span> <span class=n>chunk</span> <span class=ow>in</span> <span class=n>response_generator</span><span class=p>:</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>    <span class=nb>print</span><span class=p>(</span><span class=n>chunk</span><span class=o>.</span><span class=n>choices</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>delta</span><span class=o>.</span><span class=n>content</span><span class=p>,</span> <span class=n>end</span><span class=o>=</span><span class=s2>&quot;&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>This is great, but what if we want to do some structured extraction on this stream? For instance, we might want to render frontend components based on product rankings that are streamed out by an LLM.</p> <p>Should we wait for the entire stream to finish before extracting &amp; validating the list of components or can we extract &amp; validate the components in real time as they are streamed?</p> <p>In e-commerce, every millisecond matters so the time-to-first-render can differentiate a successful and not-so-successful e commerce store (and i know how a failing e commerce store feels :/ ).</p> <p>Let's see how we can use Instructor to handle extraction from this real time stream!</p> <h4 id=e-commerce-product-ranking><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#e-commerce-product-ranking>E-commerce Product Ranking</a></h4> <h5 id=scenario><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#scenario>Scenario</a></h5> <p>Imagine an e-commerce platform where we have:</p> <p> <strong>a customer profile</strong>: this includes a detailed history of purchases, browsing behavior, product ratings, preferences in various categories, search history, and even responses to previous recommendations. This extensive data is crucial for generating highly personalized and relevant product suggestions.</p> <p> <strong>a list of candidate products</strong>: these could be some shortlisted products we think the customer would like.</p> <p>Our goal is to re-rerank these candidate products for the best conversion and we'll use an LLM!</p> <h5 id=stream-processing><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#stream-processing>Stream Processing</a></h5> <p><strong>User Data</strong>:</p> <p>Let's assume we have the following user profile:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>profile_data</span> <span class=o>=</span> <span class=s2>&quot;&quot;&quot;</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=s2>Customer ID: 12345</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=s2>Recent Purchases: [Laptop, Wireless Headphones, Smart Watch]</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=s2>Frequently Browsed Categories: [Electronics, Books, Fitness Equipment]</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=s2>Product Ratings: {Laptop: 5 stars, Wireless Headphones: 4 stars}</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=s2>Recent Search History: [best budget laptops 2023, latest sci-fi books, yoga mats]</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=s2>Preferred Brands: [Apple, AllBirds, Bench]</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=s2>Responses to Previous Recommendations: {Philips: Not Interested, Adidas: Not Interested}</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=s2>Loyalty Program Status: Gold Member</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=s2>Average Monthly Spend: $500</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=s2>Preferred Shopping Times: Weekend Evenings</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=s2>...</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=s2>&quot;&quot;&quot;</span>
</span></code></pre></div> <p>We want to rank the following products for this user:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=n>products</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;Apple MacBook Air (2023) - Latest model, high performance, portable&quot;</span><span class=p>},</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>2</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;Sony WH-1000XM4 Wireless Headphones - Noise-canceling, long battery life&quot;</span><span class=p>},</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>3</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;Apple Watch Series 7 - Advanced fitness tracking, seamless integration with Apple ecosystem&quot;</span><span class=p>},</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>4</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;Kindle Oasis - Premium e-reader with adjustable warm light&quot;</span><span class=p>},</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>5</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;AllBirds Wool Runners - Comfortable, eco-friendly sneakers&quot;</span><span class=p>},</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>6</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;Manduka PRO Yoga Mat - High-quality, durable, eco-friendly&quot;</span><span class=p>},</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>7</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;Bench Hooded Jacket - Stylish, durable, suitable for outdoor activities&quot;</span><span class=p>},</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>8</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;GoPro HERO9 Black - 5K video, waterproof, for action photography&quot;</span><span class=p>},</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>9</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;Nespresso Vertuo Next Coffee Machine - Quality coffee, easy to use, compact design&quot;</span><span class=p>},</span>
</span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>    <span class=p>{</span><span class=s2>&quot;product_id&quot;</span><span class=p>:</span> <span class=mi>10</span><span class=p>,</span> <span class=s2>&quot;product_name&quot;</span><span class=p>:</span> <span class=s2>&quot;Project Hail Mary by Andy Weir - Latest sci-fi book from a renowned author&quot;</span><span class=p>}</span>
</span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=p>]</span>
</span></code></pre></div> <p>Let's now define our models for structured extraction. Note: instructor will conveniently let us use <code>Iterable</code> to model an iterable of our class. In this case, once we define our product recommendation model, we can slap on <code>Iterable</code> to define what we ultimately want - a (ranked) list of product recommendations.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Iterable</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>(),</span> <span class=n>mode</span><span class=o>=</span><span class=n>instructor</span><span class=o>.</span><span class=n>function_calls</span><span class=o>.</span><span class=n>Mode</span><span class=o>.</span><span class=n>JSON</span><span class=p>)</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a><span class=k>class</span> <span class=nc>ProductRecommendation</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>    <span class=n>product_id</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>    <span class=n>product_name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a><span class=n>Recommendations</span> <span class=o>=</span> <span class=n>Iterable</span><span class=p>[</span><span class=n>ProductRecommendation</span><span class=p>]</span>
</span></code></pre></div> <p>Now let's use our instructor patch. Since we don't want to wait for all the tokens to finish, will set stream to <code>True</code> and process each product recommendation as it comes in:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=n>prompt</span> <span class=o>=</span> <span class=sa>f</span><span class=s2>&quot;Based on the following user profile:</span><span class=se>\n</span><span class=si>{</span><span class=n>profile_data</span><span class=si>}</span><span class=se>\n</span><span class=s2>Rank the following products from most relevant to least relevant:</span><span class=se>\n</span><span class=s2>&quot;</span> <span class=o>+</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;</span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;product_id&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2> </span><span class=si>{</span><span class=n>product</span><span class=p>[</span><span class=s1>&#39;product_name&#39;</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span> <span class=k>for</span> <span class=n>product</span> <span class=ow>in</span> <span class=n>products</span><span class=p>)</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=n>start_perf</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=n>recommendations_stream</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo-1106&quot;</span><span class=p>,</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>    <span class=n>temperature</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>Iterable</span><span class=p>[</span><span class=n>ProductRecommendation</span><span class=p>],</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>    <span class=n>stream</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;Generate product recommendations based on the customer profile. Return in order of highest recommended first.&quot;</span><span class=p>},</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>    <span class=p>]</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=p>)</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=k>for</span> <span class=n>product</span> <span class=ow>in</span> <span class=n>recommendations_stream</span><span class=p>:</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>    <span class=nb>print</span><span class=p>(</span><span class=n>product</span><span class=p>)</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>    <span class=n>end_perf</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Time for first result (generator): </span><span class=si>{</span><span class=n>end_perf</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start_perf</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> seconds&quot;</span><span class=p>)</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>    <span class=k>break</span>
</span></code></pre></div> <div class="language-text highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>product_id=&#39;1&#39; product_name=&#39;Apple MacBook Air (2023)&#39;
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>Time for first result (generator): 4.33 seconds
</span></code></pre></div> <p><code>recommendations_stream</code> is a generator! It yields the extracted products as it's processing the stream in real-time. Now let's get the same response without streaming and see how they compare.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=n>start_perf</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a><span class=n>recommendations_list</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-11-3><a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo-1106&quot;</span><span class=p>,</span>
</span><span id=__span-11-4><a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>    <span class=n>temperature</span><span class=o>=</span><span class=mf>0.1</span><span class=p>,</span>
</span><span id=__span-11-5><a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>Iterable</span><span class=p>[</span><span class=n>ProductRecommendation</span><span class=p>],</span>
</span><span id=__span-11-6><a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a>    <span class=n>stream</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
</span><span id=__span-11-7><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-11-8><a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;Generate product recommendations based on the customer profile. Return in order of highest recommended first.&quot;</span><span class=p>},</span>
</span><span id=__span-11-9><a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=n>prompt</span><span class=p>}</span>
</span><span id=__span-11-10><a id=__codelineno-11-10 name=__codelineno-11-10 href=#__codelineno-11-10></a>    <span class=p>]</span>
</span><span id=__span-11-11><a id=__codelineno-11-11 name=__codelineno-11-11 href=#__codelineno-11-11></a><span class=p>)</span>
</span><span id=__span-11-12><a id=__codelineno-11-12 name=__codelineno-11-12 href=#__codelineno-11-12></a><span class=nb>print</span><span class=p>(</span><span class=n>recommendations_list</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span><span id=__span-11-13><a id=__codelineno-11-13 name=__codelineno-11-13 href=#__codelineno-11-13></a><span class=n>end_perf</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>perf_counter</span><span class=p>()</span>
</span><span id=__span-11-14><a id=__codelineno-11-14 name=__codelineno-11-14 href=#__codelineno-11-14></a><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Time for first result (list): </span><span class=si>{</span><span class=n>end_perf</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>start_perf</span><span class=si>:</span><span class=s2>.2f</span><span class=si>}</span><span class=s2> seconds&quot;</span><span class=p>)</span>
</span></code></pre></div> <div class="language-text highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>product_id=&#39;1&#39; product_name=&#39;Apple MacBook Air (2023)&#39;
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>Time for first result (list): 8.63 seconds
</span></code></pre></div> <p>Our web application now displays results faster. Even a 100ms improvement can lead to a 1% increase in revenue.</p> <h4 id=fastapi><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#fastapi>FastAPI</a></h4> <p>We can also take this and set up a streaming LLM API endpoint using FastAPI. Check out our docs on using FastAPI <a href=../concepts/fastapi/ >here</a>! </p> <h3 id=key-takeaways><a class=toclink href=2023/11/26/python-generators-and-llm-streaming/#key-takeaways>Key Takeaways</a></h3> <p>To summarize, we looked at:</p> <p> Generators in Python: A powerful feature that allows for efficient data handling with reduced latency</p> <p> LLM Streaming: LLMs provide us generators to stream tokens and Instructor can let us validate and extract data from this stream. Real-time data validation ftw!</p> <p>Don't forget to check our <a href=https://github.com/jxnl/instructor>GitHub</a> for more resources and give us a star if you find the library helpful!</p> <hr> <p>If you have any questions or need further clarifications, feel free to reach out or dive into the Instructor library's documentation for more detailed information. Happy coding!</p> <nav class=md-post__action> <a href=2023/11/26/python-generators-and-llm-streaming/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1724672723748638720/qOBwmkOI_400x400.jpg alt="Jason Liu"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-11-18 00:00:00">2023/11/18</time></li> <li class=md-meta__item> 4 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=verifying-llm-citations-with-pydantic><a href=2023/11/18/validate-citations/ class=toclink>Verifying LLM Citations with Pydantic</a></h2> <p>Ensuring the accuracy of information is crucial. This blog post explores how Pydantic's powerful and flexible validators can enhance data accuracy through citation verification.</p> <p>We'll start with using a simple substring check to verify citations. Then we'll use <code>instructor</code> itself to power an LLM to verify citations and align answers with the given citations. Finally, we'll explore how we can use these techniques to generate a dataset of accurate responses.</p> <h3 id=example-1-simple-substring-check><a class=toclink href=2023/11/18/validate-citations/#example-1-simple-substring-check>Example 1: Simple Substring Check</a></h3> <p>In this example, we use the <code>Statements</code> class to verify if a given substring quote exists within a text chunk. If the substring is not found, an error is raised.</p> <h4 id=code-example><a class=toclink href=2023/11/18/validate-citations/#code-example>Code Example:</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>Field</span><span class=p>,</span> <span class=n>ValidationError</span><span class=p>,</span> <span class=n>ValidationInfo</span><span class=p>,</span> <span class=n>field_validator</span><span class=p>,</span> <span class=n>model_validator</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=k>class</span> <span class=nc>Statements</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>    <span class=n>body</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    <span class=n>substring_quote</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>    <span class=nd>@field_validator</span><span class=p>(</span><span class=s2>&quot;substring_quote&quot;</span><span class=p>)</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>    <span class=nd>@classmethod</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>    <span class=k>def</span> <span class=nf>substring_quote_exists</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>info</span><span class=p>:</span> <span class=n>ValidationInfo</span><span class=p>):</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>        <span class=n>context</span> <span class=o>=</span> <span class=n>info</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;text_chunks&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>        <span class=k>for</span> <span class=n>text_chunk</span> <span class=ow>in</span> <span class=n>context</span><span class=o>.</span><span class=n>values</span><span class=p>():</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>            <span class=k>if</span> <span class=n>v</span> <span class=ow>in</span> <span class=n>text_chunk</span><span class=p>:</span> <span class=c1># (1)</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>                <span class=k>return</span> <span class=n>v</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Could not find substring_quote `</span><span class=si>{v}</span><span class=s2>` in contexts&quot;</span><span class=p>)</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=k>class</span> <span class=nc>AnswerWithCitaton</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>    <span class=n>question</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>    <span class=n>answer</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Statements</span><span class=p>]</span>
</span></code></pre></div> <ol> <li>While we use a simple substring check in this example, we can use more complex techniques like regex or Levenshtein distance.</li> </ol> <p>Once the class is defined, we can use it to validate the context and raise an error if the substring is not found.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>    <span class=n>AnswerWithCitaton</span><span class=o>.</span><span class=n>model_validate</span><span class=p>(</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>        <span class=p>{</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>            <span class=s2>&quot;question&quot;</span><span class=p>:</span> <span class=s2>&quot;What is the capital of France?&quot;</span><span class=p>,</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>            <span class=s2>&quot;answer&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>                <span class=p>{</span><span class=s2>&quot;body&quot;</span><span class=p>:</span> <span class=s2>&quot;Paris&quot;</span><span class=p>,</span> <span class=s2>&quot;substring_quote&quot;</span><span class=p>:</span> <span class=s2>&quot;Paris is the capital of France&quot;</span><span class=p>},</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>            <span class=p>],</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>        <span class=p>},</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>        <span class=n>context</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>            <span class=s2>&quot;text_chunks&quot;</span><span class=p>:</span> <span class=p>{</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>                <span class=mi>1</span><span class=p>:</span> <span class=s2>&quot;Jason is a pirate&quot;</span><span class=p>,</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>                <span class=mi>2</span><span class=p>:</span> <span class=s2>&quot;Paris is not the capital of France&quot;</span><span class=p>,</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>                <span class=mi>3</span><span class=p>:</span> <span class=s2>&quot;Irrelevant data&quot;</span><span class=p>,</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>            <span class=p>}</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>        <span class=p>},</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>    <span class=p>)</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></code></pre></div> <h4 id=error-message-example><a class=toclink href=2023/11/18/validate-citations/#error-message-example>Error Message Example:</a></h4> <div class="language-text highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>answer.0.substring_quote
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>  Value error, Could not find substring_quote `Paris is the capital of France` in contexts [type=value_error, input_value=&#39;Paris is the capital of France&#39;, input_type=str]
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>    For further information visit [https://errors.pydantic.dev/2.4/v/value_error](https://errors.pydantic.dev/2.4/v/value_error)
</span></code></pre></div> <p>Pydantic raises a validation error when the <code>substring_quote</code> attribute does not exist in the context. This approach can be used to validate more complex data using techniques like regex or Levenshtein distance.</p> <h3 id=example-2-using-llm-for-verification><a class=toclink href=2023/11/18/validate-citations/#example-2-using-llm-for-verification>Example 2: Using LLM for Verification</a></h3> <p>This approach leverages OpenAI's LLM to validate citations. If the citation does not exist in the context, the LLM returns an error message.</p> <h4 id=code-example_1><a class=toclink href=2023/11/18/validate-citations/#code-example_1>Code Example:</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>class</span> <span class=nc>Validation</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    <span class=n>is_valid</span><span class=p>:</span> <span class=nb>bool</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=n>error_messages</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=kc>None</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Error messages if any&quot;</span><span class=p>)</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=k>class</span> <span class=nc>Statements</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    <span class=n>body</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>    <span class=n>substring_quote</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>    <span class=nd>@model_validator</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=s2>&quot;after&quot;</span><span class=p>)</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>    <span class=k>def</span> <span class=nf>substring_quote_exists</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>info</span><span class=p>:</span> <span class=n>ValidationInfo</span><span class=p>):</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>        <span class=n>context</span> <span class=o>=</span> <span class=n>info</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;text_chunks&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>        <span class=n>resp</span><span class=p>:</span> <span class=n>Validation</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>            <span class=n>response_model</span><span class=o>=</span><span class=n>Validation</span><span class=p>,</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>            <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>                <span class=p>{</span>
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>                    <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>                    <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Does the following citation exist in the following context?</span><span class=se>\n\n</span><span class=s2>Citation: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>substring_quote</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>Context: </span><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>                <span class=p>}</span>
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>            <span class=p>],</span>
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>            <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-3-23><a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>        <span class=p>)</span>
</span><span id=__span-3-24><a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>
</span><span id=__span-3-25><a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>        <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>is_valid</span><span class=p>:</span>
</span><span id=__span-3-26><a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>            <span class=k>return</span> <span class=bp>self</span>
</span><span id=__span-3-27><a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>
</span><span id=__span-3-28><a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=n>resp</span><span class=o>.</span><span class=n>error_messages</span><span class=p>)</span>
</span><span id=__span-3-29><a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>
</span><span id=__span-3-30><a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>
</span><span id=__span-3-31><a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a><span class=k>class</span> <span class=nc>AnswerWithCitaton</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-3-32><a id=__codelineno-3-32 name=__codelineno-3-32 href=#__codelineno-3-32></a>    <span class=n>question</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-3-33><a id=__codelineno-3-33 name=__codelineno-3-33 href=#__codelineno-3-33></a>    <span class=n>answer</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Statements</span><span class=p>]</span>
</span></code></pre></div> <p>Now when we use a correct citation, the LLM returns a valid response.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=n>resp</span> <span class=o>=</span> <span class=n>AnswerWithCitaton</span><span class=o>.</span><span class=n>model_validate</span><span class=p>(</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    <span class=p>{</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>        <span class=s2>&quot;question&quot;</span><span class=p>:</span> <span class=s2>&quot;What is the capital of France?&quot;</span><span class=p>,</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>        <span class=s2>&quot;answer&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>            <span class=p>{</span><span class=s2>&quot;body&quot;</span><span class=p>:</span> <span class=s2>&quot;Paris&quot;</span><span class=p>,</span> <span class=s2>&quot;substring_quote&quot;</span><span class=p>:</span> <span class=s2>&quot;Paris is the capital of France&quot;</span><span class=p>},</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>        <span class=p>],</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>    <span class=p>},</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    <span class=n>context</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>        <span class=s2>&quot;text_chunks&quot;</span><span class=p>:</span> <span class=p>{</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>            <span class=mi>1</span><span class=p>:</span> <span class=s2>&quot;Jason is a pirate&quot;</span><span class=p>,</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>            <span class=mi>2</span><span class=p>:</span> <span class=s2>&quot;Paris is the capital of France&quot;</span><span class=p>,</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>            <span class=mi>3</span><span class=p>:</span> <span class=s2>&quot;Irrelevant data&quot;</span><span class=p>,</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>        <span class=p>}</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>    <span class=p>},</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=p>)</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=nb>print</span><span class=p>(</span><span class=n>resp</span><span class=o>.</span><span class=n>model_dump_json</span><span class=p>(</span><span class=n>indent</span><span class=o>=</span><span class=mi>2</span><span class=p>))</span>
</span></code></pre></div> <h4 id=result><a class=toclink href=2023/11/18/validate-citations/#result>Result:</a></h4> <div class="language-json highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=p>{</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>  </span><span class=nt>&quot;question&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;What is the capital of France?&quot;</span><span class=p>,</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>  </span><span class=nt>&quot;answer&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>    </span><span class=p>{</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>      </span><span class=nt>&quot;body&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Paris&quot;</span><span class=p>,</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>      </span><span class=nt>&quot;substring_quote&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;Paris is the capital of France&quot;</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>    </span><span class=p>}</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>  </span><span class=p>]</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=p>}</span>
</span></code></pre></div> <p>When we have citations that don't exist in the context, the LLM returns an error message.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>    <span class=n>AnswerWithCitaton</span><span class=o>.</span><span class=n>model_validate</span><span class=p>(</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>        <span class=p>{</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>            <span class=s2>&quot;question&quot;</span><span class=p>:</span> <span class=s2>&quot;What is the capital of France?&quot;</span><span class=p>,</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>            <span class=s2>&quot;answer&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>                <span class=p>{</span><span class=s2>&quot;body&quot;</span><span class=p>:</span> <span class=s2>&quot;Paris&quot;</span><span class=p>,</span> <span class=s2>&quot;substring_quote&quot;</span><span class=p>:</span> <span class=s2>&quot;Paris is the capital of France&quot;</span><span class=p>},</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>            <span class=p>],</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>        <span class=p>},</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>        <span class=n>context</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>            <span class=s2>&quot;text_chunks&quot;</span><span class=p>:</span> <span class=p>{</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>                <span class=mi>1</span><span class=p>:</span> <span class=s2>&quot;Jason is a pirate&quot;</span><span class=p>,</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>                <span class=mi>2</span><span class=p>:</span> <span class=s2>&quot;Paris is not the capital of France&quot;</span><span class=p>,</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>                <span class=mi>3</span><span class=p>:</span> <span class=s2>&quot;Irrelevant data&quot;</span><span class=p>,</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>            <span class=p>}</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>        <span class=p>},</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a>    <span class=p>)</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></code></pre></div> <h4 id=error-message-example_1><a class=toclink href=2023/11/18/validate-citations/#error-message-example_1>Error Message Example:</a></h4> <div class="language-text highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>1 validation error for AnswerWithCitaton
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>answer.0
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>  Value error, Citation not found in context [type=value_error, input_value={&#39;body&#39;: &#39;Paris&#39;, &#39;substr... the capital of France&#39;}, input_type=dict]
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>    For further information visit [https://errors.pydantic.dev/2.4/v/value_error](https://errors.pydantic.dev/2.4/v/value_error)
</span></code></pre></div> <h3 id=example-3-aligning-citations-and-answers><a class=toclink href=2023/11/18/validate-citations/#example-3-aligning-citations-and-answers>Example 3: Aligning Citations and Answers</a></h3> <p>In this example, we ensure that the provided answers are aligned with the given citations and context. The LLM is used to verify the alignment.</p> <p>We use the same <code>Statements</code> model as above, but we add a new model for the answer that also verifies the alignment of citations.</p> <h4 id=code-example_2><a class=toclink href=2023/11/18/validate-citations/#code-example_2>Code Example:</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>class</span> <span class=nc>AnswerWithCitaton</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    <span class=n>question</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    <span class=n>answer</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Statements</span><span class=p>]</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>    <span class=nd>@model_validator</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=s2>&quot;after&quot;</span><span class=p>)</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>    <span class=k>def</span> <span class=nf>validate_answer</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>info</span><span class=p>:</span> <span class=n>ValidationInfo</span><span class=p>):</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>        <span class=n>context</span> <span class=o>=</span> <span class=n>info</span><span class=o>.</span><span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;text_chunks&quot;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>        <span class=n>resp</span><span class=p>:</span> <span class=n>Validation</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>            <span class=n>response_model</span><span class=o>=</span><span class=n>Validation</span><span class=p>,</span>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>            <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>                <span class=p>{</span>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>                    <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>                    <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Does the following answers match the question and the context?</span><span class=se>\n\n</span><span class=s2>Question: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>question</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>Answer: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>answer</span><span class=si>}</span><span class=se>\n\n</span><span class=s2>Context: </span><span class=si>{</span><span class=n>context</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>                <span class=p>}</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>            <span class=p>],</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>            <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>        <span class=p>)</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>        <span class=k>if</span> <span class=n>resp</span><span class=o>.</span><span class=n>is_valid</span><span class=p>:</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>            <span class=k>return</span> <span class=bp>self</span>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=n>resp</span><span class=o>.</span><span class=n>error_messages</span><span class=p>)</span>
</span></code></pre></div> <p>When we have a mismatch between the answer and the citation, the LLM returns an error message.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>    <span class=n>AnswerWithCitaton</span><span class=o>.</span><span class=n>model_validate</span><span class=p>(</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>        <span class=p>{</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>            <span class=s2>&quot;question&quot;</span><span class=p>:</span> <span class=s2>&quot;What is the capital of France?&quot;</span><span class=p>,</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>            <span class=s2>&quot;answer&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a>                <span class=p>{</span><span class=s2>&quot;body&quot;</span><span class=p>:</span> <span class=s2>&quot;Texas&quot;</span><span class=p>,</span> <span class=s2>&quot;substring_quote&quot;</span><span class=p>:</span> <span class=s2>&quot;Paris is the capital of France&quot;</span><span class=p>},</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a>            <span class=p>],</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a>        <span class=p>},</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a>        <span class=n>context</span><span class=o>=</span><span class=p>{</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a>            <span class=s2>&quot;text_chunks&quot;</span><span class=p>:</span> <span class=p>{</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a>                <span class=mi>1</span><span class=p>:</span> <span class=s2>&quot;Jason is a pirate&quot;</span><span class=p>,</span>
</span><span id=__span-9-12><a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a>                <span class=mi>2</span><span class=p>:</span> <span class=s2>&quot;Paris is the capital of France&quot;</span><span class=p>,</span>
</span><span id=__span-9-13><a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a>                <span class=mi>3</span><span class=p>:</span> <span class=s2>&quot;Irrelevant data&quot;</span><span class=p>,</span>
</span><span id=__span-9-14><a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a>            <span class=p>}</span>
</span><span id=__span-9-15><a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a>        <span class=p>},</span>
</span><span id=__span-9-16><a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a>    <span class=p>)</span>
</span><span id=__span-9-17><a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-9-18><a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></code></pre></div> <h4 id=error-message-example_2><a class=toclink href=2023/11/18/validate-citations/#error-message-example_2>Error Message Example:</a></h4> <div class="language-text highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>1 validation error for AnswerWithCitaton
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>  Value error, The answer does not match the question and context [type=value_error, input_value={&#39;question&#39;: &#39;What is the...he capital of France&#39;}]}, input_type=dict]
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    For further information visit [https://errors.pydantic.dev/2.4/v/value_error](https://errors.pydantic.dev/2.4/v/value_error)
</span></code></pre></div> <h3 id=conclusion><a class=toclink href=2023/11/18/validate-citations/#conclusion>Conclusion</a></h3> <p>These examples demonstrate the potential of using Pydantic and OpenAI to enhance data accuracy through citation verification. While the LLM-based approach may not be efficient for runtime operations, it has exciting implications for generating a dataset of accurate responses. By leveraging this method during data generation, we can fine-tune a model that excels in citation accuracy. Similar to our last post on <a href=https://jxnl.github.io/instructor/blog/2023/11/05/chain-of-density/ >finetuning a better summarizer</a>.</p> <p>If you like the content check out our <a href=https://github.com/jxnl/instructor>GitHub</a> as give us a star and checkout the library.</p> <nav class=md-post__action> <a href=2023/11/18/validate-citations/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1724672723748638720/qOBwmkOI_400x400.jpg alt="Jason Liu"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-11-13 00:00:00">2023/11/13</time></li> <li class=md-meta__item> 6 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=introduction-to-batch-processing-using-asyncio-and-instructor><a href=2023/11/13/learn-async/ class=toclink>Introduction to Batch Processing using <code>asyncio</code> and <code>Instructor</code></a></h2> <p>Today, I will introduce you to various approaches for using asyncio in Python. We will apply this to batch process data using <code>instructor</code> and learn how to use <code>asyncio.gather</code> and <code>asyncio.as_completed</code> for concurrent data processing. Additionally, we will explore how to limit the number of concurrent requests to a server using <code>asyncio.Semaphore</code>.</p> <div class="admonition notes"> <p class=admonition-title>Github Example</p> <p>If you want to run the code examples in this article, you can find them on <a href=https://github.com/jxnl/instructor/blob/main/examples/learn-async/run.py>jxnl/instructor</a></p> </div> <p>We will start by defining an <code>async</code> function that calls <code>openai</code> to extract data, and then examine four different ways to execute it. We will discuss the pros and cons of each approach and analyze the results of running them on a small batch.</p> <h3 id=understanding-asyncio><a class=toclink href=2023/11/13/learn-async/#understanding-asyncio>Understanding <code>asyncio</code></a></h3> <p><code>asyncio</code> is a Python library that enables writing concurrent code using the async/await syntax. It is particularly useful for IO-bound and structured network code. If you are familiar with OpenAI's SDK, you might have encountered two classes: <code>OpenAI()</code> and <code>AsyncOpenAI()</code>. Today, we will be using the <code>AsyncOpenAI()</code> class, which processes data asynchronously.</p> <p>By utilizing these tools in web applications or batch processing, we can significantly improve performance by handling multiple requests concurrently instead of sequentially.</p> <h4 id=understanding-async-and-await><a class=toclink href=2023/11/13/learn-async/#understanding-async-and-await>Understanding <code>async</code> and <code>await</code></a></h4> <p>We will be using the <code>async</code> and <code>await</code> keywords to define asynchronous functions. The <code>async</code> keyword is used to define a function that returns a coroutine object. The <code>await</code> keyword is used to wait for the result of a coroutine object.</p> <p>If you want to understand the deeper details of <code>asyncio</code>, I recommend reading <a href=https://realpython.com/async-io-python/ >this article</a> by Real Python.</p> <h4 id=understanding-gather-vs-as_completed><a class=toclink href=2023/11/13/learn-async/#understanding-gather-vs-as_completed>Understanding <code>gather</code> vs <code>as_completed</code></a></h4> <p>In this post we'll show two ways to run tasks concurrently: <code>asyncio.gather</code> and <code>asyncio.as_completed</code>. The <code>gather</code> method is used to run multiple tasks concurrently and return the results as a <code>list</code>. The <code>as_completed</code> returns a <code>iterable</code> is used to run multiple tasks concurrently and return the results as they complete. Another great resource on the differences between the two can be found <a href=https://medium.com/dev-bits/a-minimalistic-guide-for-understanding-asyncio-in-python-52c436c244ea>here</a>.</p> <h3 id=example-batch-processing><a class=toclink href=2023/11/13/learn-async/#example-batch-processing>Example: Batch Processing</a></h3> <p>In this example, we will demonstrate how to use <code>asyncio</code> for batch processing tasks, specifically for extracting and processing data concurrently. The script will extract data from a list of texts and process it concurrently using <code>asyncio</code>.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>AsyncOpenAI</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=c1># Enables `response_model` in `create` method</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>apatch</span><span class=p>(</span><span class=n>AsyncOpenAI</span><span class=p>())</span> <span class=c1># (1)!</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=k>class</span> <span class=nc>Person</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=k>async</span> <span class=k>def</span> <span class=nf>extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Person</span><span class=p>:</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>    <span class=k>return</span> <span class=k>await</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span> <span class=c1># (2)!</span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>            <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=n>text</span><span class=p>},</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>        <span class=p>],</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>        <span class=n>response_model</span><span class=o>=</span><span class=n>Person</span><span class=p>,</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>    <span class=p>)</span>
</span></code></pre></div> <ol> <li>We use <code>instructor.apatch</code> to patch the <code>create</code> method of <code>AsyncOpenAI</code> to accept a <code>response_model</code> argument. This is because the <code>create</code> method of <code>AsyncOpenAI</code> does not accept a <code>response_model</code> argument without this patch.</li> <li>We use <code>await</code> here to wait for the response from the server before we return the result. This is because <code>create</code> returns a coroutine object, not the result of the coroutine.</li> </ol> <p>Notice that now there are <code>async</code> and <code>await</code> keywords in the function definition. This is because we're using the <code>asyncio</code> library to run the function concurrently. Now lets define a batch of texts to process.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=n>dataset</span> <span class=o>=</span> <span class=p>[</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>        <span class=s2>&quot;My name is John and I am 20 years old&quot;</span><span class=p>,</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>        <span class=s2>&quot;My name is Mary and I am 21 years old&quot;</span><span class=p>,</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>        <span class=s2>&quot;My name is Bob and I am 22 years old&quot;</span><span class=p>,</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>        <span class=s2>&quot;My name is Alice and I am 23 years old&quot;</span><span class=p>,</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>        <span class=s2>&quot;My name is Jane and I am 24 years old&quot;</span><span class=p>,</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>        <span class=s2>&quot;My name is Joe and I am 25 years old&quot;</span><span class=p>,</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>        <span class=s2>&quot;My name is Jill and I am 26 years old&quot;</span><span class=p>,</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>    <span class=p>]</span>
</span></code></pre></div> <h4 id=for-loop-running-tasks-sequentially><a class=toclink href=2023/11/13/learn-async/#for-loop-running-tasks-sequentially><strong><code>for loop</code></strong>: Running tasks sequentially.</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=n>persons</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>:</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=hll>    <span class=n>person</span> <span class=o>=</span> <span class=k>await</span> <span class=n>extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span></span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>    <span class=n>persons</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>person</span><span class=p>)</span>
</span></code></pre></div> <p>Even though there is an <code>await</code> keyword, we still have to wait for each task to finish before starting the next one. This is because we're using a <code>for</code> loop to iterate over the dataset. This method, which uses a <code>for</code> loop, will be the slowest among the four methods discussed today.</p> <h4 id=asynciogather-running-tasks-concurrently><a class=toclink href=2023/11/13/learn-async/#asynciogather-running-tasks-concurrently><strong><code>asyncio.gather</code></strong>: Running tasks concurrently.</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>async</span> <span class=k>def</span> <span class=nf>gather</span><span class=p>():</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    <span class=n>tasks_get_persons</span> <span class=o>=</span> <span class=p>[</span><span class=n>extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>)</span> <span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>]</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=hll>    <span class=n>all_persons</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks_get_persons</span><span class=p>)</span> <span class=c1># (1)!</span>
</span></span></code></pre></div> <ol> <li>We use <code>await</code> here to wait for all the tasks to finish before assigning the result to <code>all_persons</code>. This is because <code>asyncio.gather</code> returns a coroutine object, not the result of the coroutine. Alternatively, we can use <code>asyncio.as_completed</code> to achieve the same result.</li> </ol> <p>Using <code>asyncio.gather</code> allows us to return all the results at once. It is an effective way to speed up our code, but it's not the only way. Particularly, if we have a large dataset, we might not want to wait for everything to finish before starting to process the results. This is where <code>asyncio.as_completed</code> comes into play.</p> <h4 id=asyncioas_completed-handling-tasks-as-they-complete><a class=toclink href=2023/11/13/learn-async/#asyncioas_completed-handling-tasks-as-they-complete><strong><code>asyncio.as_completed</code></strong>: Handling tasks as they complete.</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>async</span> <span class=k>def</span> <span class=nf>as_completed</span><span class=p>():</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    <span class=n>all_persons</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    <span class=n>tasks_get_persons</span> <span class=o>=</span> <span class=p>[</span><span class=n>extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>)</span> <span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>]</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=hll>    <span class=k>for</span> <span class=n>person</span> <span class=ow>in</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>as_completed</span><span class=p>(</span><span class=n>tasks_get_persons</span><span class=p>):</span>
</span></span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=hll>        <span class=n>all_persons</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=k>await</span> <span class=n>person</span><span class=p>)</span> <span class=c1># (1)!</span>
</span></span></code></pre></div> <ol> <li>We use <code>await</code> here to wait for each task to complete before appending it to the list. This is because <code>as_completed</code> returns a coroutine object, not the result of the coroutine. Alternatively, we can use <code>asyncio.gather</code> to achieve the same result.</li> </ol> <p>This method is a great way to handle large datasets. We can start processing the results as they come in, especially if we are streaming data back to a client.</p> <p>However, these methods aim to complete as many tasks as possible as quickly as possible. This can be problematic if we want to be considerate to the server we're making requests to. This is where rate limiting comes into play. While there are libraries available to assist with rate limiting, for our initial defense, we will use a semaphore to limit the number of concurrent requests we make.</p> <div class="admonition note"> <p class=admonition-title>Ordering of results</p> <p>Its important to note that the order of the results will not be the same as the order of the dataset. This is because the tasks are completed in the order they finish, not the order they were started. If you need to preserve the order of the results, you can use <code>asyncio.gather</code> instead.</p> </div> <h4 id=rate-limited-gather-using-semaphores-to-limit-concurrency><a class=toclink href=2023/11/13/learn-async/#rate-limited-gather-using-semaphores-to-limit-concurrency><strong>Rate-Limited Gather</strong>: Using semaphores to limit concurrency.</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=n>sem</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>Semaphore</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=k>async</span> <span class=k>def</span> <span class=nf>rate_limited_extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>sem</span><span class=p>:</span> <span class=n>Semaphore</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Person</span><span class=p>:</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=hll>    <span class=k>async</span> <span class=k>with</span> <span class=n>sem</span><span class=p>:</span> <span class=c1># (1)!</span>
</span></span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>        <span class=k>return</span> <span class=k>await</span> <span class=n>extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=k>async</span> <span class=k>def</span> <span class=nf>rate_limited_gather</span><span class=p>(</span><span class=n>sem</span><span class=p>:</span> <span class=n>Semaphore</span><span class=p>):</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=hll>    <span class=n>tasks_get_persons</span> <span class=o>=</span> <span class=p>[</span><span class=n>rate_limited_extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>sem</span><span class=p>)</span> <span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>]</span>
</span></span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=hll>    <span class=n>resp</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=n>tasks_get_persons</span><span class=p>)</span>
</span></span></code></pre></div> <ol> <li>We use a semaphore to limit the number of concurrent requests to 2. This approach strikes a balance between speed and being considerate to the server we're making requests to.</li> </ol> <h4 id=rate-limited-as-completed-using-semaphores-to-limit-concurrency><a class=toclink href=2023/11/13/learn-async/#rate-limited-as-completed-using-semaphores-to-limit-concurrency><strong>Rate-Limited As Completed</strong>: Using semaphores to limit concurrency.</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=n>sem</span> <span class=o>=</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>Semaphore</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=k>async</span> <span class=k>def</span> <span class=nf>rate_limited_extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>sem</span><span class=p>:</span> <span class=n>Semaphore</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Person</span><span class=p>:</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=hll>    <span class=k>async</span> <span class=k>with</span> <span class=n>sem</span><span class=p>:</span> <span class=c1># (1)!</span>
</span></span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>        <span class=k>return</span> <span class=k>await</span> <span class=n>extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=k>async</span> <span class=k>def</span> <span class=nf>rate_limited_as_completed</span><span class=p>(</span><span class=n>sem</span><span class=p>:</span> <span class=n>Semaphore</span><span class=p>):</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>    <span class=n>all_persons</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=hll>    <span class=n>tasks_get_persons</span> <span class=o>=</span> <span class=p>[</span><span class=n>rate_limited_extract_person</span><span class=p>(</span><span class=n>text</span><span class=p>,</span> <span class=n>sem</span><span class=p>)</span> <span class=k>for</span> <span class=n>text</span> <span class=ow>in</span> <span class=n>dataset</span><span class=p>]</span>
</span></span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=hll>    <span class=k>for</span> <span class=n>person</span> <span class=ow>in</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>as_completed</span><span class=p>(</span><span class=n>tasks_get_persons</span><span class=p>):</span>
</span></span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>        <span class=n>all_persons</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=k>await</span> <span class=n>person</span><span class=p>)</span> <span class=c1># (2)!</span>
</span></code></pre></div> <ol> <li> <p>We use a semaphore to limit the number of concurrent requests to 2. This approach strikes a balance between speed and being considerate to the server we're making requests to.</p> </li> <li> <p>We use <code>await</code> here to wait for each task to complete before appending it to the list. This is because <code>as_completed</code> returns a coroutine object, not the result of the coroutine. Alternatively, we can use <code>asyncio.gather</code> to achieve the same result.</p> </li> </ol> <p>Now that we have seen the code, let's examine the results of processing 7 texts. As the prompts become longer or if we use GPT-4, the differences between these methods will become more pronounced.</p> <div class="admonition note"> <p class=admonition-title>Other Options</p> <p>Its important to also note that here we are using a <code>semaphore</code> to limit the number of concurrent requests. However, there are other ways to limit concurrency esp since we have rate limit information from the <code>openai</code> request. You can imagine using a library like <code>ratelimit</code> to limit the number of requests per second. OR catching rate limit exceptions and using <code>tenacity</code> to retry the request after a certain amount of time.</p> <ul> <li><a href=https://pypi.org/project/tenacity/ >tenacity</a></li> <li><a href=https://pypi.org/project/aiolimiter/ >aiolimiter</a></li> </ul> </div> <h3 id=results><a class=toclink href=2023/11/13/learn-async/#results>Results</a></h3> <p>As you can see, the <code>for</code> loop is the slowest, while <code>asyncio.as_completed</code> and <code>asyncio.gather</code> are the fastest without any rate limiting.</p> <table> <thead> <tr> <th>Method</th> <th>Execution Time</th> <th>Rate Limited (Semaphore)</th> </tr> </thead> <tbody> <tr> <td>For Loop</td> <td>6.17 seconds</td> <td></td> </tr> <tr> <td>Asyncio.gather</td> <td>0.85 seconds</td> <td></td> </tr> <tr> <td>Asyncio.as_completed</td> <td>0.95 seconds</td> <td></td> </tr> <tr> <td>Asyncio.gather</td> <td>3.04 seconds</td> <td>2</td> </tr> <tr> <td>Asyncio.as_completed</td> <td>3.26 seconds</td> <td>2</td> </tr> </tbody> </table> <h3 id=practical-implications-of-batch-processing><a class=toclink href=2023/11/13/learn-async/#practical-implications-of-batch-processing>Practical implications of batch processing</a></h3> <p>The choice of approach depends on the task's nature and the desired balance between speed and resource utilization.</p> <p>Here are some guidelines to consider:</p> <ul> <li>Use <code>asyncio.gather</code> for handling multiple independent tasks quickly.</li> <li>Apply <code>asyncio.as_completed</code> for large datasets to process tasks as they complete.</li> <li>Implement rate-limiting to avoid overwhelming servers or API endpoints.</li> </ul> <p>If you find the content helpful or want to try out <code>Instructor</code>, please visit our <a href=https://github.com/jxnl/instructor>GitHub</a> page and give us a star!</p> <nav class=md-post__action> <a href=2023/11/13/learn-async/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1524186822389026816/sWRHRIkY_400x400.jpg alt="Ivan Leo"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-11-05 00:00:00">2023/11/05</time></li> <li class=md-meta__item> 15 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=smarter-summaries-w-finetuning-gpt-35-and-chain-of-density><a href=2023/11/05/chain-of-density/ class=toclink>Smarter Summaries w/ Finetuning GPT-3.5 and Chain of Density</a></h2> <blockquote> <p>Discover how to distil an iterative method like Chain Of Density into a single finetuned model using Instructor</p> </blockquote> <p>In this article, we'll guide you through implementing the original Chain of Density method using Instructor, then show how to distile a GPT 3.5 model to match GPT-4's iterative summarization capabilities. Using these methods were able to decrease latency by 20x, reduce costs by 50x and maintain entity density.</p> <p>By the end you'll end up with a GPT 3.5 model, (fine-tuned using Instructor's great tooling), capable of producing summaries that rival the effectiveness of Chain of Density <a href=https://arxiv.org/abs/2309.04269>[Adams et al. (2023)]</a>. As always, all code is readily available in our <code>examples/chain-of-density</code> folder in our repo for your reference.</p> <details class=abstract> <summary>Datasets and Colab Notebook</summary> <p>We've also uploaded all our generated data to Hugging Face <a href=https://huggingface.co/datasets/ivanleomk/gpt4-chain-of-density>here</a> for you to use if you'd like to try reproducing these experiments. We've also added a <a href="https://colab.research.google.com/drive/1iBkrEh2G5U8yh8RmI8EkWxjLq6zIIuVm?usp=sharing">Colab Instance</a> for you to check our generated values.</p> </details> <h3 id=part-1-chain-of-density><a class=toclink href=2023/11/05/chain-of-density/#part-1-chain-of-density>Part 1) Chain of Density</a></h3> <p>Summarizing extensive texts with AI can be challenging, often relying on inconsistent techniques. Their novel method, Chain Of Density prompting, enhances AI-based text summarization, outperforming human-generated summaries.</p> <p>Initially, an AI produces a summary, then refines it through multiple iterations, adding missing article entities. Each iteration adds new article entities to the summary, keeping length consistent, leading to an entity-dense, informative summary called Chain Of Density.</p> <p>First introduced in the paper - <a href=https://arxiv.org/abs/2309.04269>From Sparse to Dense: GPT-4 Summarization with Chain of Density Prompting</a>. The team has found that this method is able to consistently beats similar summaries written by human annotators.</p> <details class=info> <summary>Implementation Details</summary> <p>Note that our implementation uses a validator to ensure that the rewritten summary has a minimum length rather than a prompt. We also perform just 3 and not 5 rounds of rewrites, resulting in a lower final entity density.</p> </details> <h4 id=original-prompt><a class=toclink href=2023/11/05/chain-of-density/#original-prompt>Original Prompt</a></h4> <p>We can break down the original process into smaller api calls. This allows us to introduce validation at each step to ensure that we're getting the results that we want.</p> <details class=note> <summary>Original Chain of Density Prompt</summary> <div class="language-text highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>Article: {{ARTICLE}}
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>You will generate increasingly concise, entity-dense summaries of the
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>above Article.
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>Repeat the following 2 steps 5 times.
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>Step 1. Identify 1-3 informative Entities (&quot;;&quot; delimited) from the
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>Article which are missing from the previously generated summary.
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>Step 2. Write a new, denser summary of identical length which covers
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>every entity and detail from the previous summary plus the Missing
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>Entities.
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>A Missing Entity is:
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>- Relevant: to the main story.
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>- Specific: descriptive yet concise (5 words or fewer).
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>- Novel; not in the previous summary.
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>- Faithful: present in the Article.
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>- Anywhere: located anywhere in the Article.
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>Guidelines:
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>- The first summary should be long (4-5 sentences, -80 words) yet
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>highly non-specific, containing little information beyond the
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>entities marked as missing. Use overly verbose language and fillers
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>(e.g., &quot;this article discusses&quot;) to reach -80 words.
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>- Make every word count: re-write the previous summary to improve
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>flow and make space for additional entities.
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>- Make space with fusion, compression, and removal of uninformative
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a>phrases like &quot;the article discusses&quot;
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>- The summaries should become highly dense and concise yet
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a>self-contained, e.g., easily understood without the Article.
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a>- Missing entities can appear anywhere in the new summary.
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a>- Never drop entities from the previous summary. If space cannot be
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a>made, add fewer new entities.
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a>
</span><span id=__span-0-36><a id=__codelineno-0-36 name=__codelineno-0-36 href=#__codelineno-0-36></a>Remember, use the exact same number of words for each summary.
</span><span id=__span-0-37><a id=__codelineno-0-37 name=__codelineno-0-37 href=#__codelineno-0-37></a>
</span><span id=__span-0-38><a id=__codelineno-0-38 name=__codelineno-0-38 href=#__codelineno-0-38></a>Answer in JSON. The JSON should be a list (length 5) of dictionaries
</span><span id=__span-0-39><a id=__codelineno-0-39 name=__codelineno-0-39 href=#__codelineno-0-39></a>whose keys are &quot;Missing_Entities&quot; and &quot;Denser_Summary&quot;
</span></code></pre></div> </details> <figure> <p><img alt=RAG src=img/chain-of-density.png> </p> <figcaption>Improved process with Instructor</figcaption> </figure> <h4 id=data-modelling><a class=toclink href=2023/11/05/chain-of-density/#data-modelling>Data Modelling</a></h4> <p>Before we begin modelling the data, let's make sure we install all of our dependencies</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a>pip install instructor aiohttp rich
</span></code></pre></div> <h5 id=initial-summary><a class=toclink href=2023/11/05/chain-of-density/#initial-summary>Initial Summary</a></h5> <p>Let's start by walking through some of the data models that we'll be using as the <code>response_model</code> for our open ai function calls</p> <p>Firstly, we'll need a data model for the initial summary that we will be generating. We'll take the description of this class straight from the original prompt. It's important to note that these docstrings serve a purpose, they are <strong>directly used by the LLM when generating the outputs</strong>.</p> <details class=note> <summary>A quick note on Docstrings</summary> <p>Under the hood, Instructor parses the <code>response_model</code> that you give us into a function call for OpenAI to execute. This means that the final output will be closely linked to the Pydantic model you specify.</p> <p>For instance, this simple model that we later use in fine-tuning.</p> <div class="language-py highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>class</span> <span class=nc>GeneratedSummary</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=sd>This represents a highly concise summary that includes as many entities as possible from the original source article.</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=sd>An Entity is a real-world object that&#39;s assigned a name - for example, a person, country a product or a book title.</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=sd>Guidelines</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=sd>- Make every word count</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=sd>- The new summary should be highly dense and concise yet self-contained, eg., easily understood without the Article.</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=sd>- Make space with fusion, compression, and removal of uninformative phrases like &quot;the article discusses&quot;</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=n>summary</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>    <span class=o>...</span><span class=p>,</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>    <span class=n>description</span><span class=o>=</span><span class=s2>&quot;This represents the final summary generated that captures the meaning of the original article which is as concise as possible. &quot;</span><span class=p>,</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=p>)</span>
</span></code></pre></div> <p>We eventually transform it into an OpenAI function call as seen below.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>{
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>&quot;functions&quot;: [
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    {
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    &quot;name&quot;: &quot;GeneratedSummary&quot;,
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>    &quot;description&quot;: &quot;This represents a highly concise summary that includes as many entities as possible from the original source article.\n\nAn Entity is a real-world object that&#39;s assigned a name - for example, a person, country a product or a book title.\n\nGuidelines\n- Make every word count\n- The new summary should be highly dense and concise yet self-contained, eg., easily understood without the Article.\n- Make space with fusion, compression, and removal of uninformative phrases like \&quot;the article discusses\&quot;&quot;,
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>    &quot;parameters&quot;: {
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>        &quot;properties&quot;: {
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>        &quot;summary&quot;: {
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>            &quot;description&quot;: &quot;This represents the final summary generated that captures the meaning of the original article which is as concise as possible. &quot;,
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>            &quot;title&quot;: &quot;Summary&quot;,
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>            &quot;type&quot;: &quot;string&quot;
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>        }
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>        },
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>        &quot;required&quot;: [
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>        &quot;summary&quot;
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>        ],
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>        &quot;type&quot;: &quot;object&quot;
</span><span id=__span-3-18><a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>    }
</span><span id=__span-3-19><a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>    }
</span><span id=__span-3-20><a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>]
</span><span id=__span-3-21><a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>}
</span><span id=__span-3-22><a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>}
</span></code></pre></div> <p>Therefore this means that the more elaborate and detailed your descriptions are, the better the outputs you will be able to get back. But we don't just stop there, since it's all Pydantic under the hood, you can validate and parse the resulting output to make sure it is <strong>exactly what you specify</strong>. It's all python all the way down.</p> </details> <div class="language-py highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>class</span> <span class=nc>InitialSummary</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=sd>    This is an initial summary which should be long ( 4-5 sentences, ~80 words)</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=sd>    yet highly non-specific, containing little information beyond the entities marked as missing.</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=sd>    Use overly verbose languages and fillers (Eg. This article discusses) to reach ~80 words.</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    <span class=n>summary</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>        <span class=o>...</span><span class=p>,</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;This is a summary of the article provided which is overly verbose and uses fillers. It should be roughly 80 words in length&quot;</span><span class=p>,</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>    <span class=p>)</span>
</span></code></pre></div> <h5 id=rewritten-summary><a class=toclink href=2023/11/05/chain-of-density/#rewritten-summary>Rewritten Summary</a></h5> <p>We'll also need one additional class to help model the rewritten schema</p> <div class="language-py highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>class</span> <span class=nc>RewrittenSummary</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=sd>    This is a new, denser summary of identical length which covers every entity</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=sd>    and detail from the previous summary plus the Missing Entities.</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=sd>    Guidelines</span>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=sd>    - Make every word count : Rewrite the previous summary to improve flow and make space for additional entities</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=sd>    - Never drop entities from the previous summary. If space cannot be made, add fewer new entities.</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=sd>    - The new summary should be highly dense and concise yet self-contained, eg., easily understood without the Article.</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=sd>    - Make space with fusion, compression, and removal of uninformative phrases like &quot;the article discusses&quot;</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=sd>    - Missing entities can appear anywhere in the new summary</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=sd>    An Entity is a real-world object that&#39;s assigned a name - for example, a person, country a product or a book title.</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>    <span class=n>summary</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a>        <span class=o>...</span><span class=p>,</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;This is a new, denser summary of identical length which covers every entity and detail from the previous summary plus the Missing Entities. It should have the same length ( ~ 80 words ) as the previous summary and should be easily understood without the Article&quot;</span><span class=p>,</span>
</span><span id=__span-5-19><a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a>    <span class=p>)</span>
</span><span id=__span-5-20><a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a>    <span class=n>absent</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-5-21><a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a>        <span class=o>...</span><span class=p>,</span>
</span><span id=__span-5-22><a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a>        <span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>,</span>
</span><span id=__span-5-23><a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;this is a list of Entities found absent from the new summary that were present in the previous summary&quot;</span><span class=p>,</span>
</span><span id=__span-5-24><a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a>    <span class=p>)</span>
</span><span id=__span-5-25><a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a>    <span class=n>missing</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-5-26><a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a>        <span class=n>default_factory</span><span class=o>=</span><span class=nb>list</span><span class=p>,</span>
</span><span id=__span-5-27><a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;This is a list of 1-3 informative Entities from the Article that are missing from the new summary which should be included in the next generated summary.&quot;</span><span class=p>,</span>
</span><span id=__span-5-28><a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a>    <span class=p>)</span>
</span></code></pre></div> <div class="admonition tip"> <p class=admonition-title>Using Pydantic Validators with Instructor</p> <p>For a more in-depth walkthrough on how to use <code>Pydantic</code> validators with the <code>Instructor</code> library, we recommend checking out our previous article on LLM validation - <a href=2023/10/23/good-llm-validation-is-just-good-validation/ >Good LLM Validation is just Good Validation</a></p> </div> <p>Ideally, we'd like for <code>Missing</code> to have a length between 1 and 3, <code>Absent</code> to be an empty list and for our rewritten summaries to keep a minimum entity density. With <code>Instructor</code>, we can implement this logic using native <code>Pydantic</code> validators that are simply declared as part of the class itself.</p> <div class="language-py highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kn>import</span> <span class=nn>nltk</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=kn>import</span> <span class=nn>spacy</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=n>nlp</span> <span class=o>=</span> <span class=n>spacy</span><span class=o>.</span><span class=n>load</span><span class=p>(</span><span class=s2>&quot;en_core_web_sm&quot;</span><span class=p>)</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=nd>@field_validator</span><span class=p>(</span><span class=s2>&quot;summary&quot;</span><span class=p>)</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=k>def</span> <span class=nf>min_length</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=hll>    <span class=n>tokens</span> <span class=o>=</span> <span class=n>nltk</span><span class=o>.</span><span class=n>word_tokenize</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=c1>#(1)!</span>
</span></span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>    <span class=n>num_tokens</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>)</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>    <span class=k>if</span> <span class=n>num_tokens</span> <span class=o>&lt;</span> <span class=mi>60</span><span class=p>:</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>            <span class=s2>&quot;The current summary is too short. Please make sure that you generate a new summary that is around 80 words long.&quot;</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a>        <span class=p>)</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a>    <span class=k>return</span> <span class=n>v</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=nd>@field_validator</span><span class=p>(</span><span class=s2>&quot;missing&quot;</span><span class=p>)</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=k>def</span> <span class=nf>has_missing_entities</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>missing_entities</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>missing_entities</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a>            <span class=s2>&quot;You must identify 1-3 informative Entities from the Article which are missing from the previously generated summary to be used in a new summary&quot;</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a>        <span class=p>)</span>
</span><span id=__span-6-22><a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a>    <span class=k>return</span> <span class=n>missing_entities</span>
</span><span id=__span-6-23><a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a>
</span><span id=__span-6-24><a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=nd>@field_validator</span><span class=p>(</span><span class=s2>&quot;absent&quot;</span><span class=p>)</span>
</span><span id=__span-6-25><a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=k>def</span> <span class=nf>has_no_absent_entities</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>absent_entities</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]):</span>
</span><span id=__span-6-26><a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a>    <span class=n>absent_entity_string</span> <span class=o>=</span> <span class=s2>&quot;,&quot;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>absent_entities</span><span class=p>)</span>
</span><span id=__span-6-27><a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a>    <span class=k>if</span> <span class=nb>len</span><span class=p>(</span><span class=n>absent_entities</span><span class=p>)</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>:</span>
</span><span id=__span-6-28><a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Detected absent entities of </span><span class=si>{</span><span class=n>absent_entity_string</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>)</span>
</span><span id=__span-6-29><a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
</span><span id=__span-6-30><a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a>            <span class=sa>f</span><span class=s2>&quot;Do not omit the following Entities </span><span class=si>{</span><span class=n>absent_entity_string</span><span class=si>}</span><span class=s2> from the new summary&quot;</span>
</span><span id=__span-6-31><a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a>        <span class=p>)</span>
</span><span id=__span-6-32><a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a>    <span class=k>return</span> <span class=n>absent_entities</span>
</span><span id=__span-6-33><a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a>
</span><span id=__span-6-34><a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a><span class=nd>@field_validator</span><span class=p>(</span><span class=s2>&quot;summary&quot;</span><span class=p>)</span>
</span><span id=__span-6-35><a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a>    <span class=k>def</span> <span class=nf>min_entity_density</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
</span><span id=__span-6-36><a id=__codelineno-6-36 name=__codelineno-6-36 href=#__codelineno-6-36></a>        <span class=n>tokens</span> <span class=o>=</span> <span class=n>nltk</span><span class=o>.</span><span class=n>word_tokenize</span><span class=p>(</span><span class=n>v</span><span class=p>)</span>
</span><span id=__span-6-37><a id=__codelineno-6-37 name=__codelineno-6-37 href=#__codelineno-6-37></a>        <span class=n>num_tokens</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>tokens</span><span class=p>)</span>
</span><span id=__span-6-38><a id=__codelineno-6-38 name=__codelineno-6-38 href=#__codelineno-6-38></a>
</span><span id=__span-6-39><a id=__codelineno-6-39 name=__codelineno-6-39 href=#__codelineno-6-39></a>        <span class=c1># Extract Entities</span>
</span><span id=__span-6-40><a id=__codelineno-6-40 name=__codelineno-6-40 href=#__codelineno-6-40></a><span class=hll>        <span class=n>doc</span> <span class=o>=</span> <span class=n>nlp</span><span class=p>(</span><span class=n>v</span><span class=p>)</span> <span class=c1>#(2)!</span>
</span></span><span id=__span-6-41><a id=__codelineno-6-41 name=__codelineno-6-41 href=#__codelineno-6-41></a>        <span class=n>num_entities</span> <span class=o>=</span> <span class=nb>len</span><span class=p>(</span><span class=n>doc</span><span class=o>.</span><span class=n>ents</span><span class=p>)</span>
</span><span id=__span-6-42><a id=__codelineno-6-42 name=__codelineno-6-42 href=#__codelineno-6-42></a>
</span><span id=__span-6-43><a id=__codelineno-6-43 name=__codelineno-6-43 href=#__codelineno-6-43></a>        <span class=n>density</span> <span class=o>=</span> <span class=n>num_entities</span> <span class=o>/</span> <span class=n>num_tokens</span>
</span><span id=__span-6-44><a id=__codelineno-6-44 name=__codelineno-6-44 href=#__codelineno-6-44></a><span class=hll>        <span class=k>if</span> <span class=n>density</span> <span class=o>&lt;</span> <span class=mf>0.08</span><span class=p>:</span> <span class=c1>#(3)!</span>
</span></span><span id=__span-6-45><a id=__codelineno-6-45 name=__codelineno-6-45 href=#__codelineno-6-45></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span>
</span><span id=__span-6-46><a id=__codelineno-6-46 name=__codelineno-6-46 href=#__codelineno-6-46></a>                <span class=sa>f</span><span class=s2>&quot;The summary of </span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2> has too few entities. Please regenerate a new summary with more new entities added to it. Remember that new entities can be added at any point of the summary.&quot;</span>
</span><span id=__span-6-47><a id=__codelineno-6-47 name=__codelineno-6-47 href=#__codelineno-6-47></a>            <span class=p>)</span>
</span><span id=__span-6-48><a id=__codelineno-6-48 name=__codelineno-6-48 href=#__codelineno-6-48></a>
</span><span id=__span-6-49><a id=__codelineno-6-49 name=__codelineno-6-49 href=#__codelineno-6-49></a>        <span class=k>return</span> <span class=n>v</span>
</span></code></pre></div> <ol> <li> <p>Similar to the original paper, we utilize the <code>NLTK</code> word tokenizer to count the number of tokens within our generated sentences. We aim for at least 60 tokens in our generated summary so that we don't lose information.</p> </li> <li> <p>We also use the spaCy library to calculate the entity density of the generated summary.</p> </li> <li> <p>We also implement a minimum entity density so that we stay within a given range. 0.08 is arbitrarily chosen in this case</p> </li> </ol> <h4 id=putting-it-all-together><a class=toclink href=2023/11/05/chain-of-density/#putting-it-all-together>Putting it all Together</a></h4> <p>Now that we have our models and the rough flow figured out, let's implement a function to summarize a piece of text using <code>Chain Of Density</code> summarization.</p> <div class="language-py highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=hll><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span> <span class=c1>#(1)!</span>
</span></span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a><span class=k>def</span> <span class=nf>summarize_article</span><span class=p>(</span><span class=n>article</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>summary_steps</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span><span class=p>):</span>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>    <span class=n>summary_chain</span> <span class=o>=</span> <span class=p>[]</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>    <span class=c1># We first generate an initial summary</span>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=hll>    <span class=n>summary</span><span class=p>:</span> <span class=n>InitialSummary</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>  <span class=c1># (2)!</span>
</span></span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=hll>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4-0613&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-11><a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a><span class=hll>        <span class=n>response_model</span><span class=o>=</span><span class=n>InitialSummary</span><span class=p>,</span>
</span></span><span id=__span-7-12><a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a><span class=hll>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span></span><span id=__span-7-13><a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a><span class=hll>            <span class=p>{</span>
</span></span><span id=__span-7-14><a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a><span class=hll>                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-15><a id=__codelineno-7-15 name=__codelineno-7-15 href=#__codelineno-7-15></a><span class=hll>                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;Write a summary about the article that is long (4-5 sentences) yet highly non-specific. Use overly, verbose language and fillers(eg.,&#39;this article discusses&#39;) to reach ~80 words&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-16><a id=__codelineno-7-16 name=__codelineno-7-16 href=#__codelineno-7-16></a><span class=hll>            <span class=p>},</span>
</span></span><span id=__span-7-17><a id=__codelineno-7-17 name=__codelineno-7-17 href=#__codelineno-7-17></a><span class=hll>            <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Here is the Article: </span><span class=si>{</span><span class=n>article</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>},</span>
</span></span><span id=__span-7-18><a id=__codelineno-7-18 name=__codelineno-7-18 href=#__codelineno-7-18></a><span class=hll>            <span class=p>{</span>
</span></span><span id=__span-7-19><a id=__codelineno-7-19 name=__codelineno-7-19 href=#__codelineno-7-19></a><span class=hll>                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-20><a id=__codelineno-7-20 name=__codelineno-7-20 href=#__codelineno-7-20></a><span class=hll>                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;The generated summary should be about 80 words.&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-21><a id=__codelineno-7-21 name=__codelineno-7-21 href=#__codelineno-7-21></a><span class=hll>            <span class=p>},</span>
</span></span><span id=__span-7-22><a id=__codelineno-7-22 name=__codelineno-7-22 href=#__codelineno-7-22></a><span class=hll>        <span class=p>],</span>
</span></span><span id=__span-7-23><a id=__codelineno-7-23 name=__codelineno-7-23 href=#__codelineno-7-23></a><span class=hll>        <span class=n>max_retries</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span></span><span id=__span-7-24><a id=__codelineno-7-24 name=__codelineno-7-24 href=#__codelineno-7-24></a><span class=hll>    <span class=p>)</span>
</span></span><span id=__span-7-25><a id=__codelineno-7-25 name=__codelineno-7-25 href=#__codelineno-7-25></a>    <span class=n>prev_summary</span> <span class=o>=</span> <span class=kc>None</span>
</span><span id=__span-7-26><a id=__codelineno-7-26 name=__codelineno-7-26 href=#__codelineno-7-26></a>    <span class=n>summary_chain</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>summary</span><span class=o>.</span><span class=n>summary</span><span class=p>)</span>
</span><span id=__span-7-27><a id=__codelineno-7-27 name=__codelineno-7-27 href=#__codelineno-7-27></a>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>summary_steps</span><span class=p>):</span>
</span><span id=__span-7-28><a id=__codelineno-7-28 name=__codelineno-7-28 href=#__codelineno-7-28></a>        <span class=n>missing_entity_message</span> <span class=o>=</span> <span class=p>(</span>
</span><span id=__span-7-29><a id=__codelineno-7-29 name=__codelineno-7-29 href=#__codelineno-7-29></a>            <span class=p>[]</span>
</span><span id=__span-7-30><a id=__codelineno-7-30 name=__codelineno-7-30 href=#__codelineno-7-30></a>            <span class=k>if</span> <span class=n>prev_summary</span> <span class=ow>is</span> <span class=kc>None</span>
</span><span id=__span-7-31><a id=__codelineno-7-31 name=__codelineno-7-31 href=#__codelineno-7-31></a>            <span class=k>else</span> <span class=p>[</span>
</span><span id=__span-7-32><a id=__codelineno-7-32 name=__codelineno-7-32 href=#__codelineno-7-32></a>                <span class=p>{</span>
</span><span id=__span-7-33><a id=__codelineno-7-33 name=__codelineno-7-33 href=#__codelineno-7-33></a>                    <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span><span id=__span-7-34><a id=__codelineno-7-34 name=__codelineno-7-34 href=#__codelineno-7-34></a>                    <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Please include these Missing Entities: </span><span class=si>{</span><span class=s1>&#39;,&#39;</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>prev_summary</span><span class=o>.</span><span class=n>missing</span><span class=p>)</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-7-35><a id=__codelineno-7-35 name=__codelineno-7-35 href=#__codelineno-7-35></a>                <span class=p>},</span>
</span><span id=__span-7-36><a id=__codelineno-7-36 name=__codelineno-7-36 href=#__codelineno-7-36></a>            <span class=p>]</span>
</span><span id=__span-7-37><a id=__codelineno-7-37 name=__codelineno-7-37 href=#__codelineno-7-37></a>        <span class=p>)</span>
</span><span id=__span-7-38><a id=__codelineno-7-38 name=__codelineno-7-38 href=#__codelineno-7-38></a><span class=hll>        <span class=n>new_summary</span><span class=p>:</span> <span class=n>RewrittenSummary</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span> <span class=c1># (3)!</span>
</span></span><span id=__span-7-39><a id=__codelineno-7-39 name=__codelineno-7-39 href=#__codelineno-7-39></a><span class=hll>            <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4-0613&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-40><a id=__codelineno-7-40 name=__codelineno-7-40 href=#__codelineno-7-40></a><span class=hll>            <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span></span><span id=__span-7-41><a id=__codelineno-7-41 name=__codelineno-7-41 href=#__codelineno-7-41></a><span class=hll>                <span class=p>{</span>
</span></span><span id=__span-7-42><a id=__codelineno-7-42 name=__codelineno-7-42 href=#__codelineno-7-42></a><span class=hll>                    <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-43><a id=__codelineno-7-43 name=__codelineno-7-43 href=#__codelineno-7-43></a><span class=hll>                    <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;&quot;&quot;</span>
</span></span><span id=__span-7-44><a id=__codelineno-7-44 name=__codelineno-7-44 href=#__codelineno-7-44></a><span class=hll><span class=s2>                You are going to generate an increasingly concise,entity-dense summary of the following article.</span>
</span></span><span id=__span-7-45><a id=__codelineno-7-45 name=__codelineno-7-45 href=#__codelineno-7-45></a><span class=hll>
</span></span><span id=__span-7-46><a id=__codelineno-7-46 name=__codelineno-7-46 href=#__codelineno-7-46></a><span class=hll><span class=s2>                Perform the following two tasks</span>
</span></span><span id=__span-7-47><a id=__codelineno-7-47 name=__codelineno-7-47 href=#__codelineno-7-47></a><span class=hll><span class=s2>                - Identify 1-3 informative entities from the following article which is missing from the previous summary</span>
</span></span><span id=__span-7-48><a id=__codelineno-7-48 name=__codelineno-7-48 href=#__codelineno-7-48></a><span class=hll><span class=s2>                - Write a new denser summary of identical length which covers every entity and detail from the previous summary plus the Missing Entities</span>
</span></span><span id=__span-7-49><a id=__codelineno-7-49 name=__codelineno-7-49 href=#__codelineno-7-49></a><span class=hll>
</span></span><span id=__span-7-50><a id=__codelineno-7-50 name=__codelineno-7-50 href=#__codelineno-7-50></a><span class=hll><span class=s2>                Guidelines</span>
</span></span><span id=__span-7-51><a id=__codelineno-7-51 name=__codelineno-7-51 href=#__codelineno-7-51></a><span class=hll><span class=s2>                - Make every word count: re-write the previous summary to improve flow and make space for additional entities</span>
</span></span><span id=__span-7-52><a id=__codelineno-7-52 name=__codelineno-7-52 href=#__codelineno-7-52></a><span class=hll><span class=s2>                - Make space with fusion, compression, and removal of uninformative phrases like &quot;the article discusses&quot;.</span>
</span></span><span id=__span-7-53><a id=__codelineno-7-53 name=__codelineno-7-53 href=#__codelineno-7-53></a><span class=hll><span class=s2>                - The summaries should become highly dense and concise yet self-contained, e.g., easily understood without the Article.</span>
</span></span><span id=__span-7-54><a id=__codelineno-7-54 name=__codelineno-7-54 href=#__codelineno-7-54></a><span class=hll><span class=s2>                - Missing entities can appear anywhere in the new summary</span>
</span></span><span id=__span-7-55><a id=__codelineno-7-55 name=__codelineno-7-55 href=#__codelineno-7-55></a><span class=hll><span class=s2>                - Never drop entities from the previous summary. If space cannot be made, add fewer new entities.</span>
</span></span><span id=__span-7-56><a id=__codelineno-7-56 name=__codelineno-7-56 href=#__codelineno-7-56></a><span class=hll><span class=s2>                &quot;&quot;&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-57><a id=__codelineno-7-57 name=__codelineno-7-57 href=#__codelineno-7-57></a><span class=hll>                <span class=p>},</span>
</span></span><span id=__span-7-58><a id=__codelineno-7-58 name=__codelineno-7-58 href=#__codelineno-7-58></a><span class=hll>                <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Here is the Article: </span><span class=si>{</span><span class=n>article</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>},</span>
</span></span><span id=__span-7-59><a id=__codelineno-7-59 name=__codelineno-7-59 href=#__codelineno-7-59></a><span class=hll>                <span class=p>{</span>
</span></span><span id=__span-7-60><a id=__codelineno-7-60 name=__codelineno-7-60 href=#__codelineno-7-60></a><span class=hll>                    <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-61><a id=__codelineno-7-61 name=__codelineno-7-61 href=#__codelineno-7-61></a><span class=hll>                    <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Here is the previous summary: </span><span class=si>{</span><span class=n>summary_chain</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span></span><span id=__span-7-62><a id=__codelineno-7-62 name=__codelineno-7-62 href=#__codelineno-7-62></a><span class=hll>                <span class=p>},</span>
</span></span><span id=__span-7-63><a id=__codelineno-7-63 name=__codelineno-7-63 href=#__codelineno-7-63></a><span class=hll>                <span class=o>*</span><span class=n>missing_entity_message</span><span class=p>,</span>
</span></span><span id=__span-7-64><a id=__codelineno-7-64 name=__codelineno-7-64 href=#__codelineno-7-64></a><span class=hll>            <span class=p>],</span>
</span></span><span id=__span-7-65><a id=__codelineno-7-65 name=__codelineno-7-65 href=#__codelineno-7-65></a><span class=hll>            <span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span> <span class=c1>#(4)!</span>
</span></span><span id=__span-7-66><a id=__codelineno-7-66 name=__codelineno-7-66 href=#__codelineno-7-66></a><span class=hll>            <span class=n>max_tokens</span><span class=o>=</span><span class=mi>1000</span><span class=p>,</span>
</span></span><span id=__span-7-67><a id=__codelineno-7-67 name=__codelineno-7-67 href=#__codelineno-7-67></a><span class=hll>            <span class=n>response_model</span><span class=o>=</span><span class=n>RewrittenSummary</span><span class=p>,</span>
</span></span><span id=__span-7-68><a id=__codelineno-7-68 name=__codelineno-7-68 href=#__codelineno-7-68></a><span class=hll>        <span class=p>)</span>
</span></span><span id=__span-7-69><a id=__codelineno-7-69 name=__codelineno-7-69 href=#__codelineno-7-69></a>        <span class=n>summary_chain</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>new_summary</span><span class=o>.</span><span class=n>summary</span><span class=p>)</span>
</span><span id=__span-7-70><a id=__codelineno-7-70 name=__codelineno-7-70 href=#__codelineno-7-70></a>        <span class=n>prev_summary</span> <span class=o>=</span> <span class=n>new_summary</span>
</span><span id=__span-7-71><a id=__codelineno-7-71 name=__codelineno-7-71 href=#__codelineno-7-71></a>
</span><span id=__span-7-72><a id=__codelineno-7-72 name=__codelineno-7-72 href=#__codelineno-7-72></a>    <span class=k>return</span> <span class=n>summary_chain</span>
</span></code></pre></div> <ol> <li> <p>We need to apply a <code>patch</code> function on the <code>OpenAI</code> client for us to get all of the benefits that <code>Instructor</code> provides. With a simple <code>patch</code>, we can get <strong>automatic type coercion of our outputs and automatic retries for invalid outputs</strong> out of the box!</p> </li> <li> <p>We first generate an initial summary. Note here that we explictly ask for a summary that has 80 words and is lengthy with overly verbose fillers in the system prompt</p> </li> <li> <p>We slightly modify the original system prompt used in the original paper to perform a rewrite of the summary. Using <code>Instructor</code>, we also get validation of the generated output with our <code>field_validator</code>s that we defined above</p> </li> <li> <p>If you've chosen a value that is larger than 0.08, make sure to increase this value in case you need to do multiple rewrites</p> </li> </ol> <p>This summarization function yields a result which triples the number of entities while maintaining the same number of tokens. We can also see that stylistically, the summary is a lot more natural.</p> <p><strong>First Iteration</strong></p> <blockquote> <p>This article discusses the highly-anticipated boxing match between Manny Pacquiao and Floyd Mayweather. The article revolves around Manny Pacquiao's statements about his upcoming fight and his preparations for the same. A portion of the article provides details about the financial stipulations of the match and its significance in the sporting arena. Quotes from Pacquiao illustrating his determination and his battle strategy are highlighted. The tone of the article is largely centered around creating a build-up to the upcoming mega event.</p> </blockquote> <p><strong>Final Iteration</strong></p> <blockquote> <p>Manny Pacquiao, the Filipino boxer, anticipates the forthcoming May 2 showdown at the MGM Grand as the fight of his life, against the undefeated American Floyd Mayweather, in a $300m bout. Despite being seen as the underdog in this high-stakes Las Vegas match, Pacquiao is confident, promising a warrior's spirit and assuring the fans who have been awaiting this encounter for a decade, that it will indeed be the biggest sporting spectacle in history worthy of their anticipation</p> </blockquote> <h3 id=part-2-fine-tuning><a class=toclink href=2023/11/05/chain-of-density/#part-2-fine-tuning>Part 2) Fine-Tuning</a></h3> <p>In this section, we'll look into how to fine-tune a GPT 3.5 model so that it is able to perform at an equivalent level as a GPT-4 model. We'll then compare the performance of our model against that of <code>GPT-4</code> to see how it stacks up.</p> <h4 id=creating-a-training-set><a class=toclink href=2023/11/05/chain-of-density/#creating-a-training-set>Creating a Training Set</a></h4> <p>In order to prevent any contamination of data during testing, we randomly sampled 120 articles from the <code>griffin/chain-of-density</code> dataset and split these articles into a <code>train.csv</code> and a <code>test.csv</code> file which we uploaded to <a href=https://huggingface.co/datasets/ivanleomk/gpt4-chain-of-density>Hugging Face</a>. Now, we just neeed to import the <code>Instructions</code> module from the <code>Instructor</code> package which allows you to generate a nicely formatted <code>.jsonl</code> file to be used for fine-tuning</p> <div class="language-py highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=hll><span class=kn>from</span> <span class=nn>chain_of_density</span> <span class=kn>import</span> <span class=n>summarize_article</span> <span class=c1>#(1)!</span>
</span></span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a><span class=kn>import</span> <span class=nn>csv</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=kn>import</span> <span class=nn>logging</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=hll><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span> <span class=c1># (2)!</span>
</span></span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=hll><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span> <span class=c1>#(3)!</span>
</span></span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=hll><span class=n>instructions</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>Instructions</span><span class=p>(</span> <span class=c1>#(4)!</span>
</span></span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a><span class=hll>    <span class=n>name</span><span class=o>=</span><span class=s2>&quot;Chain Of Density&quot;</span><span class=p>,</span>
</span></span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=hll>    <span class=n>finetune_format</span><span class=o>=</span><span class=s2>&quot;messages&quot;</span><span class=p>,</span>
</span></span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=hll>    <span class=c1># log handler is used to save the data to a file</span>
</span></span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a><span class=hll>    <span class=c1># you can imagine saving it to a database or other storage</span>
</span></span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=hll>    <span class=c1># based on your needs!</span>
</span></span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=hll>    <span class=n>log_handlers</span><span class=o>=</span><span class=p>[</span><span class=n>logging</span><span class=o>.</span><span class=n>FileHandler</span><span class=p>(</span><span class=s2>&quot;generated.jsonl&quot;</span><span class=p>)],</span>
</span></span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=hll>    <span class=n>openai_client</span><span class=o>=</span><span class=n>client</span><span class=p>,</span>
</span></span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a><span class=hll><span class=p>)</span>
</span></span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a><span class=k>class</span> <span class=nc>GeneratedSummary</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-8-24><a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
</span><span id=__span-8-25><a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a><span class=sd>    This represents a highly concise summary that includes as many entities as possible from the original source article.</span>
</span><span id=__span-8-26><a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a>
</span><span id=__span-8-27><a id=__codelineno-8-27 name=__codelineno-8-27 href=#__codelineno-8-27></a><span class=sd>    An Entity is a real-world object that&#39;s assigned a name - for example, a person, country a product or a book title.</span>
</span><span id=__span-8-28><a id=__codelineno-8-28 name=__codelineno-8-28 href=#__codelineno-8-28></a>
</span><span id=__span-8-29><a id=__codelineno-8-29 name=__codelineno-8-29 href=#__codelineno-8-29></a><span class=sd>    Guidelines</span>
</span><span id=__span-8-30><a id=__codelineno-8-30 name=__codelineno-8-30 href=#__codelineno-8-30></a><span class=sd>    - Make every word count</span>
</span><span id=__span-8-31><a id=__codelineno-8-31 name=__codelineno-8-31 href=#__codelineno-8-31></a><span class=sd>    - The new summary should be highly dense and concise yet self-contained, eg., easily understood without the Article.</span>
</span><span id=__span-8-32><a id=__codelineno-8-32 name=__codelineno-8-32 href=#__codelineno-8-32></a><span class=sd>    - Make space with fusion, compression, and removal of uninformative phrases like &quot;the article discusses&quot;</span>
</span><span id=__span-8-33><a id=__codelineno-8-33 name=__codelineno-8-33 href=#__codelineno-8-33></a><span class=sd>    &quot;&quot;&quot;</span>
</span><span id=__span-8-34><a id=__codelineno-8-34 name=__codelineno-8-34 href=#__codelineno-8-34></a>
</span><span id=__span-8-35><a id=__codelineno-8-35 name=__codelineno-8-35 href=#__codelineno-8-35></a>    <span class=n>summary</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-8-36><a id=__codelineno-8-36 name=__codelineno-8-36 href=#__codelineno-8-36></a>        <span class=o>...</span><span class=p>,</span>
</span><span id=__span-8-37><a id=__codelineno-8-37 name=__codelineno-8-37 href=#__codelineno-8-37></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;This represents the final summary generated that captures the meaning of the original article which is as concise as possible. &quot;</span><span class=p>,</span>
</span><span id=__span-8-38><a id=__codelineno-8-38 name=__codelineno-8-38 href=#__codelineno-8-38></a>    <span class=p>)</span>
</span><span id=__span-8-39><a id=__codelineno-8-39 name=__codelineno-8-39 href=#__codelineno-8-39></a>
</span><span id=__span-8-40><a id=__codelineno-8-40 name=__codelineno-8-40 href=#__codelineno-8-40></a><span class=hll><span class=nd>@instructions</span><span class=o>.</span><span class=n>distil</span> <span class=c1>#(4)!</span>
</span></span><span id=__span-8-41><a id=__codelineno-8-41 name=__codelineno-8-41 href=#__codelineno-8-41></a><span class=k>def</span> <span class=nf>distil_summarization</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>GeneratedSummary</span><span class=p>:</span>
</span><span id=__span-8-42><a id=__codelineno-8-42 name=__codelineno-8-42 href=#__codelineno-8-42></a>    <span class=n>summary_chain</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>summarize_article</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span><span id=__span-8-43><a id=__codelineno-8-43 name=__codelineno-8-43 href=#__codelineno-8-43></a><span class=hll>    <span class=k>return</span> <span class=n>GeneratedSummary</span><span class=p>(</span><span class=n>summary</span><span class=o>=</span><span class=n>summary_chain</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span> <span class=c1>#(5)!</span>
</span></span><span id=__span-8-44><a id=__codelineno-8-44 name=__codelineno-8-44 href=#__codelineno-8-44></a>
</span><span id=__span-8-45><a id=__codelineno-8-45 name=__codelineno-8-45 href=#__codelineno-8-45></a><span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s2>&quot;train.csv&quot;</span><span class=p>,</span> <span class=s2>&quot;r&quot;</span><span class=p>)</span> <span class=k>as</span> <span class=n>file</span><span class=p>:</span>
</span><span id=__span-8-46><a id=__codelineno-8-46 name=__codelineno-8-46 href=#__codelineno-8-46></a>    <span class=n>reader</span> <span class=o>=</span> <span class=n>csv</span><span class=o>.</span><span class=n>reader</span><span class=p>(</span><span class=n>file</span><span class=p>)</span>
</span><span id=__span-8-47><a id=__codelineno-8-47 name=__codelineno-8-47 href=#__codelineno-8-47></a>    <span class=nb>next</span><span class=p>(</span><span class=n>reader</span><span class=p>)</span>  <span class=c1># Skip the header</span>
</span><span id=__span-8-48><a id=__codelineno-8-48 name=__codelineno-8-48 href=#__codelineno-8-48></a>    <span class=k>for</span> <span class=n>article</span><span class=p>,</span> <span class=n>summary</span> <span class=ow>in</span> <span class=n>reader</span><span class=p>:</span>
</span><span id=__span-8-49><a id=__codelineno-8-49 name=__codelineno-8-49 href=#__codelineno-8-49></a>        <span class=c1># Run Distillisation to generate the values</span>
</span><span id=__span-8-50><a id=__codelineno-8-50 name=__codelineno-8-50 href=#__codelineno-8-50></a>        <span class=n>distil_summarization</span><span class=p>(</span><span class=n>article</span><span class=p>)</span>
</span></code></pre></div> <ol> <li> <p>In this example, we're using the summarize_article that we defined up above. We saved it in a local file called <code>chain_of_density.py</code>, hence the import</p> </li> <li> <p>We patch the default OpenAI client so that we can use the Instructor library with it</p> </li> <li> <p>We also need to configure logging at the <code>INFO</code> level. This is very important, if this is not configured, your output will not be generated.</p> </li> <li> <p>We instantiate a <code>Instruction</code> object which will help us handle the conversion of our function calls into a valid <code>.jsonl</code> file. We also define the name of the <code>.jsonl</code> file in the <code>log_handlers</code> parameter</p> </li> <li> <p>We add in an <code>instructions.distil</code> annotation so that we automatically capture the input and output of the function we'd like to fine-tune our model to output</p> </li> <li> <p>We return a <code>Pydantic</code> object which matches the annotation that we use on our function. Note that we must specify a <code>Pydantic</code> object to be returned when using the <code>instructions.distil</code> annotation</p> </li> </ol> <div class="admonition warning"> <p class=admonition-title>Rate Limiting</p> <p>We recommend running this script on a small subset of the dataset first to test you've got everything configured nicely. Don't forget to add in rate limiting error handling with <code>tenacity</code> and set the <code>OPENAI_API_KEY</code> shell environment variable before running any subsequent commands</p> </div> <h4 id=creating-fine-tuning-jobs><a class=toclink href=2023/11/05/chain-of-density/#creating-fine-tuning-jobs>Creating Fine-Tuning Jobs</a></h4> <p>Once we run this script, we'll have a new file called <code>generated.jsonl</code> in our local repository. Now all that's left is to run the command below to start fine-tuning your first model!</p> <div class="language-sh highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a>instructor<span class=w> </span><span class=nb>jobs</span><span class=w> </span>create-from-file<span class=w> </span>generated.jsonl
</span></code></pre></div> <details class=notes> <summary>Finetuning Reference</summary> <p>Checking out our <a href=../cli/finetune/ >Finetuning CLI</a> to learn about other hyperparameters that you can tune to improve your model's performance.</p> </details> <p>Once the job is complete, all we need to do is to then change the annotation in the function call to <code>distil_summarization</code> in our original file above to start using our new model.</p> <div class="language-py highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=nd>@instructions</span><span class=o>.</span><span class=n>distil</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s1>&#39;gpt-3.5-turbo:finetuned-123&#39;</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&quot;dispatch&quot;</span><span class=p>)</span> <span class=c1>#(1)!</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=k>def</span> <span class=nf>distil_summarization</span><span class=p>(</span><span class=n>text</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>GeneratedSummary</span><span class=p>:</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    <span class=n>summary_chain</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>summarize_article</span><span class=p>(</span><span class=n>text</span><span class=p>)</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>    <span class=k>return</span> <span class=n>GeneratedSummary</span><span class=p>(</span><span class=n>summary</span><span class=o>=</span><span class=n>summary_chain</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></code></pre></div> <ol> <li>Don't forget to replace this with your new model id. OpenAI identifies fine tuned models with an id of ft:gpt-3.5-turbo-0613:personal::<id> under their Fine-tuning tab on their dashboard</li> </ol> <p>With that, you've now got your own fine-tuned model ready to go and serve data in production. We've seen how Instructor can make your life easier, from fine-tuning to distillation.</p> <h3 id=results-and-benchmarks><a class=toclink href=2023/11/05/chain-of-density/#results-and-benchmarks>Results and Benchmarks</a></h3> <p>We'll be comparing the following models in 3 ways using 20 articles that were not used for fine-tuning.</p> <ul> <li>Entity Density : This is entities per token, the higher the better for density.</li> <li>Latency : Time to last token generated in seconds</li> <li>Costs : Total cost to generate outputs - we break down the cost into training and inference costs for easy reference</li> </ul> <dl> <dt><code>3.5 Finetuned (n)</code></dt> <dd> <p>This is a GPT 3.5 model that we fine-tuned on <code>n</code> examples. Each model was finetuned for 4-5 epochs ( This was automatically decided by the OpenAI scheduler )</p> </dd> <dt><code>GPT-4 (COD)</code></dt> <dd> <p>This is a GPT4 model which we applied 3 rounds of Chain Of Density rewrites to generate a summary with using the methodology above</p> </dd> <dt><code>GPT-3.5 (Vanilla)</code></dt> <dd> <p>This is a GPT 3.5 model that we asked to generate entity-dense summaries which were concise. Summaries were generated in a single pass targetting about 80-90 tokens.</p> </dd> </dl> <table> <thead> <tr> <th>Model</th> <th>Mean Latency (s)</th> <th>Mean Entity Density</th> </tr> </thead> <tbody> <tr> <td>3.5 Finetuned (20)</td> <td>2.1</td> <td>0.15</td> </tr> <tr> <td>3.5 Finetuned (50)</td> <td>2.1</td> <td>0.14</td> </tr> <tr> <td>3.5 Finetuned (76)</td> <td>2.1</td> <td>0.14</td> </tr> <tr> <td>GPT-3.5 (Vanilla)</td> <td>16.8</td> <td>0.12</td> </tr> <tr> <td>GPT-4 (COD)</td> <td>49.5</td> <td>0.15</td> </tr> </tbody> </table> <details class=notes> <summary>Finetuning Datasets</summary> <p>For our finetuned models, we did a few optimisations to raise the performance.</p> <p>We only included summaries that had a minimum density of 0.15 in the dataset, took the summary in the entire chain with the highest density as the final one, forced every regenerated summary to have a minimum density of 0.12 and regenerated summaries up to three times if they didn't meet the summaries. <strong>This is a much more expensive strategy and can cost up to 2.5x or more what we do in this tutorial</strong></p> <p>This resulted in the total cost of $63.46 to generate just 75 examples due to the stringent requirements, translating to about $0.85 per generated summary example.</p> </details> <p>Using the OpenAI Usage Dashboard, we can calculate the cost of generating 20 summaries as seen below.</p> <table> <thead> <tr> <th>Model</th> <th>Training Cost ($)</th> <th>Inference Cost ($)</th> <th>Tokens Used</th> <th>Total Cost ($)</th> </tr> </thead> <tbody> <tr> <td>GPT-3.5 (Vanilla)</td> <td>-</td> <td>0.20</td> <td>51,162</td> <td>0.2</td> </tr> <tr> <td>3.5 Finetuned (20)</td> <td>0.7</td> <td>0.20</td> <td>56,573</td> <td>0.8</td> </tr> <tr> <td>3.5 Finetuned (50)</td> <td>1.4</td> <td>0.17</td> <td>49,057</td> <td>1.3</td> </tr> <tr> <td>3.5 Finetuned (76)</td> <td>1.8</td> <td>0.17</td> <td>51,583</td> <td>2.5</td> </tr> <tr> <td>GPT-4 (COD)</td> <td>-</td> <td>12.9</td> <td>409,062</td> <td>12.9</td> </tr> </tbody> </table> <p>Here, we can see that <code>GPT-4</code> has an approximate inference cost of <code>0.65</code> per summary while our finetuned models have an inference cost of <code>0.0091</code> per summary which is ~ <code>72x</code> cheaper.</p> <p>Interestingly, the model finetuned with the least examples seems to outperform the others. While the reason for this is unknown, a few potential reasons could be that either we didn't train for sufficient epochs ( We chose the default 5 epochs ) or that the models started learning to imitate other behaviour such as more abstract writing styles from the larger variety of samples, resulting in a decrease in entity density.</p> <h3 id=conclusions><a class=toclink href=2023/11/05/chain-of-density/#conclusions>Conclusions</a></h3> <p>Finetuning this iterative method was 20-40x faster while improving overall performance, resulting in massive efficiency gains by finetuning and distilling capabilities into specialized models.</p> <p>We've seen how <code>Instructor</code> can make your life easier, from data modeling to distillation and finetuning. If you enjoy the content or want to try out <code>instructor</code> check out the <a href=https://github.com/jxnl/instructor>github</a> and don't forget to give us a star!</p> <nav class=md-post__action> <a href=2023/11/05/chain-of-density/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1724672723748638720/qOBwmkOI_400x400.jpg alt="Jason Liu"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-11-02 00:00:00">2023/11/02</time></li> <li class=md-meta__item> 1 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=ai-engineer-keynote-pydantic-is-all-you-need><a href=2023/11/02/ai-engineer-keynote-pydantic-is-all-you-need/ class=toclink>AI Engineer Keynote: Pydantic is all you need</a></h2> <p><a href="https://www.youtube.com/watch?v=yj-wSRJwrrc"><img alt="Pydantic is all you need" src=https://img.youtube.com/vi/yj-wSRJwrrc/0.jpg></a> </p> <p><a href="https://www.youtube.com/watch?v=yj-wSRJwrrc">Click here to watch the full talk</a></p> <p>Last month, I ventured back onto the speaking circuit at the inaugural <a href=https://www.ai.engineer/summit>AI Engineer Summit</a>, sharing insights on leveraging <a href=https://docs.pydantic.dev/latest/ >Pydantic</a> for effective prompt engineering. I dove deep into what is covered in our documentation and standard blog posts, </p> <p>I'd genuinely appreciate any feedback on the talk  every bit helps in refining the art. So, take a moment to check out the <a href="https://youtu.be/yj-wSRJwrrc?si=vGMIqtTapbIN8SLz">full talk here</a>, and let's continue pushing the boundaries of what's possible.</p> <nav class=md-post__action> <a href=2023/11/02/ai-engineer-keynote-pydantic-is-all-you-need/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1724672723748638720/qOBwmkOI_400x400.jpg alt="Jason Liu"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-10-23 00:00:00">2023/10/23</time></li> <li class=md-meta__item> 10 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=good-llm-validation-is-just-good-validation><a href=2023/10/23/good-llm-validation-is-just-good-validation/ class=toclink>Good LLM Validation is Just Good Validation</a></h2> <blockquote> <p>What if your validation logic could learn and adapt like a human, but operate at the speed of software? This is the future of validation and it's already here.</p> </blockquote> <p>Validation is the backbone of reliable software. But traditional methods are static, rule-based, and can't adapt to new challenges. This post looks at how to bring dynamic, machine learning-driven validation into your software stack using Python libraries like <code>Pydantic</code> and <code>Instructor</code>. We validate these outputs using a validation function which conforms to the structure seen below.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>def</span> <span class=nf>validation_function</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>    <span class=k>if</span> <span class=n>condition</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Value is not valid&quot;</span><span class=p>)</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>    <span class=k>return</span> <span class=n>mutation</span><span class=p>(</span><span class=n>value</span><span class=p>)</span>
</span></code></pre></div> <h3 id=what-is-instructor><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#what-is-instructor>What is Instructor?</a></h3> <p><code>Instructor</code> helps to ensure you get the exact response type you're looking for when using openai's function call api. Once you've defined the <code>Pydantic</code> model for your desired response, <code>Instructor</code> handles all the complicated logic in-between - from the parsing/validation of the response to the automatic retries for invalid responses. This means that we can build in validators 'for free' and have a clear separation of concerns between the prompt and the code that calls openai.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kn>import</span> <span class=nn>instructor</span> <span class=c1># pip install instructor</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=c1># This enables response_model keyword</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=c1># from client.chat.completions.create</span>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span> <span class=c1># (1)!</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=k>class</span> <span class=nc>UserDetail</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=n>user</span><span class=p>:</span> <span class=n>UserDetail</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>UserDetail</span><span class=p>,</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;Extract Jason is 25 years old&quot;</span><span class=p>},</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>    <span class=p>]</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a>    <span class=n>max_retries</span><span class=o>=</span><span class=mi>3</span> <span class=c1># (2)!</span>
</span><span id=__span-1-21><a id=__codelineno-1-21 name=__codelineno-1-21 href=#__codelineno-1-21></a><span class=p>)</span>
</span><span id=__span-1-22><a id=__codelineno-1-22 name=__codelineno-1-22 href=#__codelineno-1-22></a>
</span><span id=__span-1-23><a id=__codelineno-1-23 name=__codelineno-1-23 href=#__codelineno-1-23></a><span class=k>assert</span> <span class=n>user</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&quot;Jason&quot;</span> <span class=c1># (3)!</span>
</span><span id=__span-1-24><a id=__codelineno-1-24 name=__codelineno-1-24 href=#__codelineno-1-24></a><span class=k>assert</span> <span class=n>user</span><span class=o>.</span><span class=n>age</span> <span class=o>==</span> <span class=mi>25</span>
</span></code></pre></div> <ol> <li> <p>To simplify your work with OpenAI models and streamline the extraction of Pydantic objects from prompts, we offer a patching mechanism for the <code>ChatCompletion</code> class.</p> </li> <li> <p>Invalid responses that fail to be validated succesfully will trigger up to as many reattempts as you define.</p> </li> <li> <p>As long as you pass in a <code>response_model</code> parameter to the <code>ChatCompletion</code> api call, the returned object will always be a validated <code>Pydantic</code> object.</p> </li> </ol> <p>In this post, we'll explore how to evolve from static, rule-based validation methods to dynamic, machine learning-driven ones. You'll learn to use <code>Pydantic</code> and <code>Instructor</code> to leverage language models and dive into advanced topics like content moderation, validating chain of thought reasoning, and contextual validation.</p> <p>Let's examine how these approaches with a example. Imagine that you run a software company who wants to ensure you never serve hateful and racist content. This isn't an easy job since the language around these topics change very quickly and frequently.</p> <h3 id=software-10-introduction-to-validations-in-pydantic><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#software-10-introduction-to-validations-in-pydantic>Software 1.0: Introduction to Validations in Pydantic</a></h3> <p>A simple method could be to compile a list of different words that are often associated with hate speech. For simplicity, let's assume that we've found that the words <code>Steal</code> and <code>Rob</code> are good predictors of hateful speech from our database. We can modify our validation structure above to accomodate this.</p> <p>This will throw an error if we pass in a string like <code>Let's rob the bank!</code> or <code>We should steal from the supermarkets</code>.</p> <p>Pydantic offers two approaches for this validation: using the <code>field_validator</code> decorator or the <code>Annotated</code> hints.</p> <h4 id=using-field_validator-decorator><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#using-field_validator-decorator>Using <code>field_validator</code> decorator</a></h4> <p>We can use the <code>field_validator</code> decorator to define a validator for a field in Pydantic. Here's a quick example of how we might be able to do so.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>ValidationError</span><span class=p>,</span> <span class=n>field_validator</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=kn>from</span> <span class=nn>pydantic.fields</span> <span class=kn>import</span> <span class=n>Field</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=k>class</span> <span class=nc>UserMessage</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a>    <span class=n>message</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>    <span class=nd>@field_validator</span><span class=p>(</span><span class=s1>&#39;message&#39;</span><span class=p>)</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>    <span class=k>def</span> <span class=nf>message_cannot_have_blacklisted_words</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a>        <span class=k>for</span> <span class=n>word</span> <span class=ow>in</span> <span class=n>v</span><span class=o>.</span><span class=n>split</span><span class=p>():</span> <span class=c1># (1)!</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>            <span class=k>if</span> <span class=n>word</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>in</span> <span class=p>{</span><span class=s1>&#39;rob&#39;</span><span class=p>,</span><span class=s1>&#39;steal&#39;</span><span class=p>}:</span>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;`</span><span class=si>{</span><span class=n>word</span><span class=si>}</span><span class=s2>` was found in the message `</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2>`&quot;</span><span class=p>)</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>        <span class=k>return</span> <span class=n>v</span>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>    <span class=n>UserMessage</span><span class=p>(</span><span class=n>message</span><span class=o>=</span><span class=s2>&quot;This is a lovely day&quot;</span><span class=p>)</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>    <span class=n>UserMessage</span><span class=p>(</span><span class=n>message</span><span class=o>=</span><span class=s2>&quot;We should go and rob a bank&quot;</span><span class=p>)</span>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>We split the sentence into its individual words and iterate through each of the words. We then try to see if any of these words are in our blacklist which in this case is just <code>rob</code> and <code>steal</code></li> </ol> <p>Since the message <code>This is a lovely day</code> does not have any blacklisted words, no errors are thrown. However, in the given example above, the validation fails for the message <code>We should go and rob a bank</code> due to the presence of the word <code>rob</code> and the corresponding error message is displayed.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>1 validation error for UserMessage
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>message
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>  Value error, `rob` was found in the message `We should go and rob a bank` [type=value_error, input_value=&#39;We should go and rob a bank&#39;, input_type=str]
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    For further information visit https://errors.pydantic.dev/2.4/v/value_error
</span></code></pre></div> <h4 id=using-annotated><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#using-annotated>Using <code>Annotated</code></a></h4> <p>Alternatively, you can use the <code>Annotated</code> function to perform the same validation. Here's an example where we utilise the same function we started with.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>ValidationError</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Annotated</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=kn>from</span> <span class=nn>pydantic.functional_validators</span> <span class=kn>import</span> <span class=n>AfterValidator</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=k>def</span> <span class=nf>message_cannot_have_blacklisted_words</span><span class=p>(</span><span class=n>value</span><span class=p>:</span><span class=nb>str</span><span class=p>):</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>    <span class=k>for</span> <span class=n>word</span> <span class=ow>in</span> <span class=n>value</span><span class=o>.</span><span class=n>split</span><span class=p>():</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>        <span class=k>if</span> <span class=n>word</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span> <span class=ow>in</span> <span class=p>{</span><span class=s1>&#39;rob&#39;</span><span class=p>,</span><span class=s1>&#39;steal&#39;</span><span class=p>}:</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;`</span><span class=si>{</span><span class=n>word</span><span class=si>}</span><span class=s2>` was found in the message `</span><span class=si>{</span><span class=n>value</span><span class=si>}</span><span class=s2>`&quot;</span><span class=p>)</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>    <span class=k>return</span> <span class=n>value</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=k>class</span> <span class=nc>UserMessage</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>    <span class=n>message</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>AfterValidator</span><span class=p>(</span><span class=n>message_cannot_have_blacklisted_words</span><span class=p>)]</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>    <span class=n>UserMessage</span><span class=p>(</span><span class=n>message</span><span class=o>=</span><span class=s2>&quot;This is a lovely day&quot;</span><span class=p>)</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>    <span class=n>UserMessage</span><span class=p>(</span><span class=n>message</span><span class=o>=</span><span class=s2>&quot;We should go and rob a bank&quot;</span><span class=p>)</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></code></pre></div> <p>This code snippet achieves the same validation result. If the user message contains any of the words in the blacklist, a <code>ValueError</code> is raised and the corresponding error message is displayed.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>1 validation error for UserMessage
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>message
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>  Value error, `rob` was found in the message `We should go and rob a bank` [type=value_error, input_value=&#39;We should go and rob a bank&#39;, input_type=str]
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>    For further information visit https://errors.pydantic.dev/2.4/v/value_error
</span></code></pre></div> <p>Validation is a fundamental concept in software development and remains the same when applied to AI systems. Existing programming concepts should be leveraged when possible instead of introducing new terms and standards. The underlying principles of validation remain unchanged.</p> <p>Suppose now that we've gotten a new message - <code>Violence is always acceptable, as long as we silence the witness</code>. Our original validator wouldn't throw any errors when passed this new message since it uses neither the words <code>rob</code> or <code>steal</code>. However, it's clear that it is not a message which should be published. How can we ensure that our validation logic can adapt to new challenges?</p> <h3 id=software-30-validation-for-llms-or-powered-by-llms><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#software-30-validation-for-llms-or-powered-by-llms>Software 3.0: Validation for LLMs or powered by LLMs</a></h3> <p>Building upon the understanding of simple field validators, let's delve into probabilistic validation in software 3.0, (prompt engineering). We'll introduce an LLM-powered validator called <code>llm_validator</code> that uses a statement to verify the value.</p> <p>We can get around this by using the inbuilt <code>llm_validator</code> class from <code>Instructor</code>.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=kn>from</span> <span class=nn>instructor</span> <span class=kn>import</span> <span class=n>llm_validator</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>ValidationError</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>Annotated</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=kn>from</span> <span class=nn>pydantic.functional_validators</span> <span class=kn>import</span> <span class=n>AfterValidator</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=k>class</span> <span class=nc>UserMessage</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>    <span class=n>message</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>AfterValidator</span><span class=p>(</span><span class=n>llm_validator</span><span class=p>(</span><span class=s2>&quot;don&#39;t say objectionable things&quot;</span><span class=p>))]</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>    <span class=n>UserMessage</span><span class=p>(</span><span class=n>message</span><span class=o>=</span><span class=s2>&quot;Violence is always acceptable, as long as we silence the witness&quot;</span><span class=p>)</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></code></pre></div> <p>This produces the following error message as seen below</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>1 validation error for UserMessage
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>message
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>  Assertion failed, The statement promotes violence, which is objectionable. [type=assertion_error, input_value=&#39;Violence is always accep... we silence the witness&#39;, input_type=str]
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>    For further information visit https://errors.pydantic.dev/2.4/v/assertion_error
</span></code></pre></div> <p>The error message is generated by the language model (LLM) rather than the code itself, making it helpful for re-asking the model in a later section. To better understand this approach, let's see how to build an <code>llm_validator</code> from scratch.</p> <h4 id=creating-your-own-field-level-llm_validator><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#creating-your-own-field-level-llm_validator>Creating Your Own Field Level <code>llm_validator</code></a></h4> <p>Building your own <code>llm_validator</code> can be a valuable exercise to get started with <code>Instructor</code> and create custom validators.</p> <p>Before we continue, let's review the anatomy of a validator:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>def</span> <span class=nf>validation_function</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    <span class=k>if</span> <span class=n>condition</span><span class=p>(</span><span class=n>value</span><span class=p>):</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Value is not valid&quot;</span><span class=p>)</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>    <span class=k>return</span> <span class=n>value</span>
</span></code></pre></div> <p>As we can see, a validator is simply a function that takes in a value and returns a value. If the value is not valid, it raises a <code>ValueError</code>. We can represent this using the following structure:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>class</span> <span class=nc>Validation</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>    <span class=n>is_valid</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Whether the value is valid based on the rules&quot;</span><span class=p>)</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>    <span class=n>error_message</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span><span class=o>...</span><span class=p>,</span> <span class=n>description</span><span class=o>=</span><span class=s2>&quot;The error message if the value is not valid, to be used for re-asking the model&quot;</span><span class=p>)</span>
</span></code></pre></div> <p>Using this structure, we can implement the same logic as before and utilize <code>Instructor</code> to generate the validation.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a><span class=c1># Enables `response_model` and `max_retries` parameters</span>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=k>def</span> <span class=nf>validator</span><span class=p>(</span><span class=n>v</span><span class=p>):</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>    <span class=n>statement</span> <span class=o>=</span> <span class=s2>&quot;don&#39;t say objectionable things&quot;</span>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a>    <span class=n>resp</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a>            <span class=p>{</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a>                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a>                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;You are a validator. Determine if the value is valid for the statement. If it is not, explain why.&quot;</span><span class=p>,</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>            <span class=p>},</span>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a>            <span class=p>{</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a>                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a>                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Does `</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2>` follow the rules: </span><span class=si>{</span><span class=n>statement</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a>            <span class=p>},</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a>        <span class=p>],</span>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a>        <span class=c1># this comes from client = instructor.patch(OpenAI())</span>
</span><span id=__span-10-22><a id=__codelineno-10-22 name=__codelineno-10-22 href=#__codelineno-10-22></a>        <span class=n>response_model</span><span class=o>=</span><span class=n>Validation</span><span class=p>,</span> <span class=c1># (1)!</span>
</span><span id=__span-10-23><a id=__codelineno-10-23 name=__codelineno-10-23 href=#__codelineno-10-23></a>    <span class=p>)</span>
</span><span id=__span-10-24><a id=__codelineno-10-24 name=__codelineno-10-24 href=#__codelineno-10-24></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>resp</span><span class=o>.</span><span class=n>is_valid</span><span class=p>:</span>
</span><span id=__span-10-25><a id=__codelineno-10-25 name=__codelineno-10-25 href=#__codelineno-10-25></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=n>resp</span><span class=o>.</span><span class=n>error_message</span><span class=p>)</span>
</span><span id=__span-10-26><a id=__codelineno-10-26 name=__codelineno-10-26 href=#__codelineno-10-26></a>    <span class=k>return</span> <span class=n>v</span>
</span></code></pre></div> <ol> <li>The new parameter of <code>response_model</code> comes from <code>client = instructor.patch(OpenAI())</code> and does not exist in the original OpenAI SDK. This allows us to pass in the <code>Pydantic</code> model that we want as a response.</li> </ol> <p>Now we can use this validator in the same way we used the <code>llm_validator</code> from <code>Instructor</code>.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=k>class</span> <span class=nc>UserMessage</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-11-2><a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>    <span class=n>message</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span><span class=nb>str</span><span class=p>,</span> <span class=n>AfterValidator</span><span class=p>(</span><span class=n>validator</span><span class=p>)]</span>
</span></code></pre></div> <h3 id=writing-more-complex-validations><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#writing-more-complex-validations>Writing more complex validations</a></h3> <h4 id=validating-chain-of-thought><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#validating-chain-of-thought>Validating Chain of Thought</a></h4> <p>A popular way of prompting large language models nowadays is known as chain of thought. This involves getting a model to generate reasons and explanations for an answer to a prompt.</p> <p>We can utilise <code>Pydantic</code> and <code>Instructor</code> to perform a validation to check of the reasoning is reasonable, given both the answer and the chain of thought. To do this we can't build a field validator since we need to access multiple fields in the model. Instead we can use a model validator.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>def</span> <span class=nf>validate_chain_of_thought</span><span class=p>(</span><span class=n>values</span><span class=p>):</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>    <span class=n>chain_of_thought</span> <span class=o>=</span> <span class=n>values</span><span class=p>[</span><span class=s2>&quot;chain_of_thought&quot;</span><span class=p>]</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>    <span class=n>answer</span> <span class=o>=</span> <span class=n>values</span><span class=p>[</span><span class=s2>&quot;answer&quot;</span><span class=p>]</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>    <span class=n>resp</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a>            <span class=p>{</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a>                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;You are a validator. Determine if the value is valid for the statement. If it is not, explain why.&quot;</span><span class=p>,</span>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a>            <span class=p>},</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>            <span class=p>{</span>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a>                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Verify that `</span><span class=si>{</span><span class=n>answer</span><span class=si>}</span><span class=s2>` follows the chain of thought: </span><span class=si>{</span><span class=n>chain_of_thought</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a>            <span class=p>},</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>        <span class=p>],</span>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a>        <span class=c1># this comes from client = instructor.patch(OpenAI())</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a>        <span class=n>response_model</span><span class=o>=</span><span class=n>Validation</span><span class=p>,</span>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a>    <span class=p>)</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a>    <span class=k>if</span> <span class=ow>not</span> <span class=n>resp</span><span class=o>.</span><span class=n>is_valid</span><span class=p>:</span>
</span><span id=__span-12-20><a id=__codelineno-12-20 name=__codelineno-12-20 href=#__codelineno-12-20></a>        <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=n>resp</span><span class=o>.</span><span class=n>error_message</span><span class=p>)</span>
</span><span id=__span-12-21><a id=__codelineno-12-21 name=__codelineno-12-21 href=#__codelineno-12-21></a>    <span class=k>return</span> <span class=n>values</span>
</span></code></pre></div> <p>We can then take advantage of the <code>model_validator</code> decorator to perform a validation on a subset of the model's data.</p> <blockquote> <p>We're defining a model validator here which runs before <code>Pydantic</code> parses the input into its respective fields. That's why we have a <strong>before</strong> keyword used in the <code>model_validator</code> class.</p> </blockquote> <div class="language-python highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>model_validator</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=k>class</span> <span class=nc>AIResponse</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>    <span class=n>chain_of_thought</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>    <span class=n>answer</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>    <span class=nd>@model_validator</span><span class=p>(</span><span class=n>mode</span><span class=o>=</span><span class=s1>&#39;before&#39;</span><span class=p>)</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>    <span class=nd>@classmethod</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>    <span class=k>def</span> <span class=nf>chain_of_thought_makes_sense</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>data</span><span class=p>:</span> <span class=n>Any</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Any</span><span class=p>:</span>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a>        <span class=c1># here we assume data is the dict representation of the model</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>        <span class=c1># since we use &#39;before&#39; mode.</span>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a>        <span class=k>return</span> <span class=n>validate_chain_of_thought</span><span class=p>(</span><span class=n>data</span><span class=p>)</span>
</span></code></pre></div> <p>Now, when you create a <code>AIResponse</code> instance, the <code>chain_of_thought_makes_sense</code> validator will be invoked. Here's an example:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>    <span class=n>resp</span> <span class=o>=</span> <span class=n>AIResponse</span><span class=p>(</span>
</span><span id=__span-14-3><a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>        <span class=n>chain_of_thought</span><span class=o>=</span><span class=s2>&quot;1 + 1 = 2&quot;</span><span class=p>,</span> <span class=n>answer</span><span class=o>=</span><span class=s2>&quot;The meaning of life is 42&quot;</span>
</span><span id=__span-14-4><a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>    <span class=p>)</span>
</span><span id=__span-14-5><a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-14-6><a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></code></pre></div> <p>If we create a <code>AIResponse</code> instance with an answer that does not follow the chain of thought, we will get an error.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>1 validation error for AIResponse
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>    Value error, The statement &#39;The meaning of life is 42&#39; does not follow the chain of thought: 1 + 1 = 2.
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>    [type=value_error, input_value={&#39;chain_of_thought&#39;: &#39;1 +... meaning of life is 42&#39;}, input_type=dict]
</span></code></pre></div> <h4 id=validating-citations-from-original-text><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#validating-citations-from-original-text>Validating Citations From Original Text</a></h4> <p>Let's see a more concrete example. Let's say that we've asked our model a question about some text source and we want to validate that the generated answer is supported by the source. This would allow us to minimize hallucinations and prevent statements that are not backed by the original text. While we could verify this by looking up the original source manually, a more scalable approach is to use a validator to do this automatically.</p> <p>We can pass in additional context to our validation functions using the <code>model_validate</code> function in <code>Pydantic</code> so that our models have more information to work with when performing validation. This context is a normal python dictionary and can be accessed inside the <code>info</code> argument in our validator functions.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>ValidationInfo</span><span class=p>,</span><span class=n>BaseModel</span><span class=p>,</span><span class=n>field_validator</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a>
</span><span id=__span-16-3><a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=k>class</span> <span class=nc>AnswerWithCitation</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-16-4><a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a>    <span class=n>answer</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-16-5><a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a>    <span class=n>citation</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-16-6><a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a>
</span><span id=__span-16-7><a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a>    <span class=nd>@field_validator</span><span class=p>(</span><span class=s1>&#39;citation&#39;</span><span class=p>)</span>
</span><span id=__span-16-8><a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a>    <span class=nd>@classmethod</span>
</span><span id=__span-16-9><a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a>    <span class=k>def</span> <span class=nf>citation_exists</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span> <span class=n>info</span><span class=p>:</span> <span class=n>ValidationInfo</span><span class=p>):</span> <span class=c1># (1)!</span>
</span><span id=__span-16-10><a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a>        <span class=n>context</span> <span class=o>=</span> <span class=n>info</span><span class=o>.</span><span class=n>context</span>
</span><span id=__span-16-11><a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a>        <span class=k>if</span> <span class=n>context</span><span class=p>:</span>
</span><span id=__span-16-12><a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a>            <span class=n>context</span> <span class=o>=</span> <span class=n>context</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s1>&#39;text_chunk&#39;</span><span class=p>)</span>
</span><span id=__span-16-13><a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a>            <span class=k>if</span> <span class=n>v</span> <span class=ow>not</span> <span class=ow>in</span> <span class=n>context</span><span class=p>:</span>
</span><span id=__span-16-14><a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a>                <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=sa>f</span><span class=s2>&quot;Citation `</span><span class=si>{</span><span class=n>v</span><span class=si>}</span><span class=s2>` not found in text chunks&quot;</span><span class=p>)</span>
</span><span id=__span-16-15><a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a>        <span class=k>return</span> <span class=n>v</span>
</span></code></pre></div> <ol> <li>This <code>info</code> object corresponds to the value of <code>context</code> that we pass into the <code>model_validate</code> function as seen below.</li> </ol> <p>We can then take our original example and test it against our new model</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=k>try</span><span class=p>:</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>    <span class=n>AnswerWithCitation</span><span class=o>.</span><span class=n>model_validate</span><span class=p>(</span>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>        <span class=p>{</span><span class=s2>&quot;answer&quot;</span><span class=p>:</span> <span class=s2>&quot;Jason is a cool guy&quot;</span><span class=p>,</span> <span class=s2>&quot;citation&quot;</span><span class=p>:</span> <span class=s2>&quot;Jason is cool&quot;</span><span class=p>},</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>        <span class=n>context</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;text_chunk&quot;</span><span class=p>:</span> <span class=s2>&quot;Jason is just a guy&quot;</span><span class=p>},</span> <span class=c1># (1)!</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>    <span class=p>)</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=k>except</span> <span class=n>ValidationError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>    <span class=nb>print</span><span class=p>(</span><span class=n>e</span><span class=p>)</span>
</span></code></pre></div> <ol> <li>This <code>context</code> object is just a normal python dictionary and can take in and store any arbitrary values</li> </ol> <p>This in turn generates the following error since <code>Jason is cool</code> does not exist in the text <code>Jason is just a guy</code>.</p> <div class="language-text highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>1 validation error for AnswerWithCitation
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>citation
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>Value error, Citation `Jason is cool` not found in text chunks [type=value_error, input_value=&#39;Jason is cool&#39;, input_type=str]
</span><span id=__span-18-4><a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>    For further information visit https://errors.pydantic.dev/2.4/v/value_error
</span></code></pre></div> <h3 id=putting-it-all-together-with-client-instructorpatchopenai><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#putting-it-all-together-with-client-instructorpatchopenai>Putting it all together with <code>client = instructor.patch(OpenAI())</code></a></h3> <p>To pass this context from the <code>client.chat.completions.create</code> call, <code>client = instructor.patch(OpenAI())</code> also passes the <code>validation_context</code>, which will be accessible from the <code>info</code> argument in the decorated validator functions.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=c1># Enables `response_model` and `max_retries` parameters</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a>
</span><span id=__span-19-7><a id=__codelineno-19-7 name=__codelineno-19-7 href=#__codelineno-19-7></a><span class=k>def</span> <span class=nf>answer_question</span><span class=p>(</span><span class=n>question</span><span class=p>:</span><span class=nb>str</span><span class=p>,</span> <span class=n>text_chunk</span><span class=p>:</span> <span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>AnswerWithCitation</span><span class=p>:</span>
</span><span id=__span-19-8><a id=__codelineno-19-8 name=__codelineno-19-8 href=#__codelineno-19-8></a>    <span class=k>return</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-19-9><a id=__codelineno-19-9 name=__codelineno-19-9 href=#__codelineno-19-9></a>        <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-19-10><a id=__codelineno-19-10 name=__codelineno-19-10 href=#__codelineno-19-10></a>        <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-19-11><a id=__codelineno-19-11 name=__codelineno-19-11 href=#__codelineno-19-11></a>            <span class=p>{</span>
</span><span id=__span-19-12><a id=__codelineno-19-12 name=__codelineno-19-12 href=#__codelineno-19-12></a>                <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span><span id=__span-19-13><a id=__codelineno-19-13 name=__codelineno-19-13 href=#__codelineno-19-13></a>                <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=sa>f</span><span class=s2>&quot;Answer the question: </span><span class=si>{</span><span class=n>question</span><span class=si>}</span><span class=s2> with the text chunk: </span><span class=si>{</span><span class=n>text_chunk</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
</span><span id=__span-19-14><a id=__codelineno-19-14 name=__codelineno-19-14 href=#__codelineno-19-14></a>            <span class=p>},</span>
</span><span id=__span-19-15><a id=__codelineno-19-15 name=__codelineno-19-15 href=#__codelineno-19-15></a>        <span class=p>],</span>
</span><span id=__span-19-16><a id=__codelineno-19-16 name=__codelineno-19-16 href=#__codelineno-19-16></a>        <span class=n>response_model</span><span class=o>=</span><span class=n>AnswerWithCitation</span><span class=p>,</span>
</span><span id=__span-19-17><a id=__codelineno-19-17 name=__codelineno-19-17 href=#__codelineno-19-17></a>        <span class=n>validation_context</span><span class=o>=</span><span class=p>{</span><span class=s2>&quot;text_chunk&quot;</span><span class=p>:</span> <span class=n>text_chunk</span><span class=p>},</span>
</span><span id=__span-19-18><a id=__codelineno-19-18 name=__codelineno-19-18 href=#__codelineno-19-18></a>    <span class=p>)</span>
</span></code></pre></div> <h3 id=error-handling-and-re-asking><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#error-handling-and-re-asking>Error Handling and Re-Asking</a></h3> <p>Validators can ensure certain properties of the outputs by throwing errors, in an AI system we can use the errors and allow language model to self correct. The by running <code>client = instructor.patch(OpenAI())</code> not only do we add <code>response_model</code> and <code>validation_context</code> it also allows you to use the <code>max_retries</code> parameter to specify the number of times to try and self correct.</p> <p>This approach provides a layer of defense against two types of bad outputs:</p> <ol> <li>Pydantic Validation Errors (code or LLM-based)</li> <li>JSON Decoding Errors (when the model returns an incorrect response)</li> </ol> <h4 id=define-the-response-model-with-validators><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#define-the-response-model-with-validators>Define the Response Model with Validators</a></h4> <p>To keep things simple lets assume we have a model that returns a <code>UserModel</code> object. We can define the response model using Pydantic and add a field validator to ensure that the name is in uppercase.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>field_validator</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=k>class</span> <span class=nc>UserModel</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-20-4><a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-20-5><a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-20-6><a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>
</span><span id=__span-20-7><a id=__codelineno-20-7 name=__codelineno-20-7 href=#__codelineno-20-7></a>    <span class=nd>@field_validator</span><span class=p>(</span><span class=s2>&quot;name&quot;</span><span class=p>)</span>
</span><span id=__span-20-8><a id=__codelineno-20-8 name=__codelineno-20-8 href=#__codelineno-20-8></a>    <span class=nd>@classmethod</span>
</span><span id=__span-20-9><a id=__codelineno-20-9 name=__codelineno-20-9 href=#__codelineno-20-9></a>    <span class=k>def</span> <span class=nf>validate_name</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=n>v</span><span class=p>):</span>
</span><span id=__span-20-10><a id=__codelineno-20-10 name=__codelineno-20-10 href=#__codelineno-20-10></a>        <span class=k>if</span> <span class=n>v</span><span class=o>.</span><span class=n>upper</span><span class=p>()</span> <span class=o>!=</span> <span class=n>v</span><span class=p>:</span>
</span><span id=__span-20-11><a id=__codelineno-20-11 name=__codelineno-20-11 href=#__codelineno-20-11></a>            <span class=k>raise</span> <span class=ne>ValueError</span><span class=p>(</span><span class=s2>&quot;Name must be in uppercase.&quot;</span><span class=p>)</span>
</span><span id=__span-20-12><a id=__codelineno-20-12 name=__codelineno-20-12 href=#__codelineno-20-12></a>        <span class=k>return</span> <span class=n>v</span>
</span></code></pre></div> <p>This is where the <code>max_retries</code> parameter comes in. It allows the model to self correct and retry the prompt using the error message rather than the prompt.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=n>model</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-21-4><a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;Extract jason is 25 years old&quot;</span><span class=p>},</span>
</span><span id=__span-21-5><a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>    <span class=p>],</span>
</span><span id=__span-21-6><a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>    <span class=c1># Powered by client = instructor.patch(OpenAI())</span>
</span><span id=__span-21-7><a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>UserModel</span><span class=p>,</span>
</span><span id=__span-21-8><a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a>    <span class=n>max_retries</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span>
</span><span id=__span-21-9><a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=p>)</span>
</span><span id=__span-21-10><a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a>
</span><span id=__span-21-11><a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=k>assert</span> <span class=n>model</span><span class=o>.</span><span class=n>name</span> <span class=o>==</span> <span class=s2>&quot;JASON&quot;</span>
</span></code></pre></div> <p>In this example, even though there is no code explicitly transforming the name to uppercase, the model is able to correct the output.</p> <h3 id=conclusion><a class=toclink href=2023/10/23/good-llm-validation-is-just-good-validation/#conclusion>Conclusion</a></h3> <p>From the simplicity of Pydantic and Instructor to the dynamic validation capabilities of LLMs, the landscape of validation is changing but without needing to introduce new contepts. It's clear that the future of validation is not just about preventing bad data but about allowing llms to understand the data and correcting it.</p> <p>If you enjoy the content or want to try out <code>Instructor</code> please check out the <a href=https://github.com/jxnl/instructor>github</a> and give us a star!</p> <nav class=md-post__action> <a href=2023/10/23/good-llm-validation-is-just-good-validation/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1724672723748638720/qOBwmkOI_400x400.jpg alt="Jason Liu"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-10-17 00:00:00">2023/10/17</time></li> <li class=md-meta__item> 4 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation><a href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/ class=toclink>Enhancing Python Functions with Instructor: A Guide to Fine-Tuning and Distillation</a></h2> <h3 id=introduction><a class=toclink href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/#introduction>Introduction</a></h3> <p>Get ready to dive deep into the world of fine-tuning task specific language models with Python functions. We'll explore how the <code>instructor.instructions</code> streamlines this process, making the task you want to distil more efficient and powerful while preserving its original functionality and backwards compatibility.</p> <p>If you want to see the full example checkout <a href=https://github.com/jxnl/instructor/tree/main/examples/distilations>examples/distillation</a></p> <h3 id=why-use-instructor><a class=toclink href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/#why-use-instructor>Why use Instructor?</a></h3> <p>Imagine you're developing a backend service that uses a mix old and new school ML practises, it may involve pipelines with multiple function calls, validations, and data processing. Sounds cumbersome, right? That's where <code>Instructor</code> comes in. It simplifies complex procedures, making them more efficient and easier to manage by adding a decorator to your function that will automatically generate a dataset for fine-tuning and help you swap out the function implementation.</p> <h3 id=quick-start-how-to-use-instructors-distillation-feature><a class=toclink href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/#quick-start-how-to-use-instructors-distillation-feature>Quick Start: How to Use Instructor's Distillation Feature</a></h3> <p>Before we dig into the nitty-gritty, let's look at how easy it is to use Instructor's distillation feature to use function calling finetuning to export the data to a JSONL file.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>import</span> <span class=nn>logging</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kn>import</span> <span class=nn>random</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=kn>from</span> <span class=nn>instructor</span> <span class=kn>import</span> <span class=n>Instructions</span> <span class=c1># pip install instructor</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=c1># Logging setup</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=n>logging</span><span class=o>.</span><span class=n>basicConfig</span><span class=p>(</span><span class=n>level</span><span class=o>=</span><span class=n>logging</span><span class=o>.</span><span class=n>INFO</span><span class=p>)</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=n>instructions</span> <span class=o>=</span> <span class=n>Instructions</span><span class=p>(</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    <span class=n>name</span><span class=o>=</span><span class=s2>&quot;three_digit_multiply&quot;</span><span class=p>,</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>    <span class=n>finetune_format</span><span class=o>=</span><span class=s2>&quot;messages&quot;</span><span class=p>,</span>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>    <span class=c1># log handler is used to save the data to a file</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>    <span class=c1># you can imagine saving it to a database or other storage</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>    <span class=c1># based on your needs! </span>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>    <span class=n>log_handlers</span><span class=o>=</span><span class=p>[</span><span class=n>logging</span><span class=o>.</span><span class=n>FileHandler</span><span class=p>(</span><span class=s2>&quot;math_finetunes.jsonl&quot;</span><span class=p>)]</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=p>)</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=k>class</span> <span class=nc>Multiply</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>    <span class=n>a</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>    <span class=n>b</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>    <span class=n>result</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-0-22><a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>
</span><span id=__span-0-23><a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=c1># Define a function with distillation</span>
</span><span id=__span-0-24><a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=c1># The decorator will automatically generate a dataset for fine-tuning</span>
</span><span id=__span-0-25><a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=c1># They must return a pydantic model to leverage function calling</span>
</span><span id=__span-0-26><a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a><span class=nd>@instructions</span><span class=o>.</span><span class=n>distil</span>
</span><span id=__span-0-27><a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a><span class=k>def</span> <span class=nf>fn</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Multiply</span><span class=p>:</span>
</span><span id=__span-0-28><a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>    <span class=n>resp</span> <span class=o>=</span> <span class=n>a</span> <span class=o>*</span> <span class=n>b</span>
</span><span id=__span-0-29><a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a>    <span class=k>return</span> <span class=n>Multiply</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=o>=</span><span class=n>b</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=n>resp</span><span class=p>)</span>
</span><span id=__span-0-30><a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>
</span><span id=__span-0-31><a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a><span class=c1># Generate some data</span>
</span><span id=__span-0-32><a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a><span class=k>for</span> <span class=n>_</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>10</span><span class=p>):</span>
</span><span id=__span-0-33><a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a>    <span class=n>a</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>999</span><span class=p>)</span>
</span><span id=__span-0-34><a id=__codelineno-0-34 name=__codelineno-0-34 href=#__codelineno-0-34></a>    <span class=n>b</span> <span class=o>=</span> <span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>100</span><span class=p>,</span> <span class=mi>999</span><span class=p>)</span>
</span><span id=__span-0-35><a id=__codelineno-0-35 name=__codelineno-0-35 href=#__codelineno-0-35></a>    <span class=nb>print</span><span class=p>(</span><span class=n>fn</span><span class=p>(</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=p>))</span>
</span></code></pre></div> <h3 id=the-intricacies-of-fine-tuning-language-models><a class=toclink href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/#the-intricacies-of-fine-tuning-language-models>The Intricacies of Fine-tuning Language Models</a></h3> <p>Fine-tuning isn't just about writing a function like <code>def f(a, b): return a * b</code>. It requires detailed data preparation and logging. However, Instructor provides a built-in logging feature and structured outputs to simplify this.</p> <h3 id=why-instructor-and-distillation-are-game-changers><a class=toclink href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/#why-instructor-and-distillation-are-game-changers>Why Instructor and Distillation are Game Changers</a></h3> <p>The library offers two main benefits:</p> <ol> <li><strong>Efficiency</strong>: Streamlines functions, distilling requirements into model weights and a few lines of code.</li> <li><strong>Integration</strong>: Eases combining classical machine learning and language models by providing a simple interface that wraps existing functions.</li> </ol> <h3 id=role-of-instructor-in-simplifying-fine-tuning><a class=toclink href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/#role-of-instructor-in-simplifying-fine-tuning>Role of Instructor in Simplifying Fine-Tuning</a></h3> <p>The <code>from instructor import Instructions</code> feature is a time saver. It auto-generates a fine-tuning dataset, making it a breeze to imitate a function's behavior.</p> <h3 id=logging-output-and-running-a-finetune><a class=toclink href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/#logging-output-and-running-a-finetune>Logging Output and Running a Finetune</a></h3> <p>Here's how the logging output would look:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=p>{</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a>    <span class=s2>&quot;messages&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s1>&#39;Predict the results of this function: ...&#39;</span><span class=p>},</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s1>&#39;Return fn(133, b=539)&#39;</span><span class=p>},</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;assistant&quot;</span><span class=p>,</span> 
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>            <span class=s2>&quot;function_call&quot;</span><span class=p>:</span> 
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a>                <span class=p>{</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>                    <span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;Multiply&quot;</span><span class=p>,</span> 
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>                    <span class=s2>&quot;arguments&quot;</span><span class=p>:</span> <span class=s1>&#39;{&quot;a&quot;:133,&quot;b&quot;:539,&quot;result&quot;:89509}&#39;</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>            <span class=p>}</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>        <span class=p>}</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>    <span class=p>],</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>    <span class=s2>&quot;functions&quot;</span><span class=p>:</span> <span class=p>[</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>        <span class=p>{</span><span class=s2>&quot;name&quot;</span><span class=p>:</span> <span class=s2>&quot;Multiply&quot;</span><span class=p>,</span> <span class=s2>&quot;description&quot;</span><span class=p>:</span> <span class=s2>&quot;Correctly extracted `Multiply`...&quot;</span><span class=p>}</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>    <span class=p>]</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=p>}</span>
</span></code></pre></div> <p>Run a finetune like this:</p> <div class="admonition note annotate"> <p class=admonition-title>Don't forget to set your OpenAI Key as an environment variable</p> <p>All of the <code>instructor jobs</code> commands assume you've set an environment variable of <code>OPENAI_API_KEY</code> in your shell. You can set this by running the command <code>export OPENAI_API_KEY=&lt;Insert API Key Here&gt;</code> in your shell</p> </div> <div class="language-bash highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a>instructor<span class=w> </span><span class=nb>jobs</span><span class=w> </span>create-from-file<span class=w> </span>math_finetunes.jsonl
</span></code></pre></div> <h3 id=next-steps-and-future-plans><a class=toclink href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/#next-steps-and-future-plans>Next Steps and Future Plans</a></h3> <p>Here's a sneak peek of what I'm planning:</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=kn>from</span> <span class=nn>instructor</span> <span class=kn>import</span> <span class=n>Instructions</span><span class=p>,</span> <span class=n>patch</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=n>patch</span><span class=p>()</span> <span class=c1>#(1)!</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=k>class</span> <span class=nc>Multiply</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>    <span class=n>a</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    <span class=n>b</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>    <span class=n>result</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-3-9><a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>
</span><span id=__span-3-10><a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=n>instructions</span> <span class=o>=</span> <span class=n>Instructions</span><span class=p>(</span>
</span><span id=__span-3-11><a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>    <span class=n>name</span><span class=o>=</span><span class=s2>&quot;three_digit_multiply&quot;</span><span class=p>,</span>
</span><span id=__span-3-12><a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=p>)</span>
</span><span id=__span-3-13><a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>
</span><span id=__span-3-14><a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=nd>@instructions</span><span class=o>.</span><span class=n>distil</span><span class=p>(</span><span class=n>model</span><span class=o>=</span><span class=s1>&#39;gpt-3.5-turbo:finetuned-123&#39;</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&quot;dispatch&quot;</span><span class=p>)</span> <span class=c1># (2)!</span>
</span><span id=__span-3-15><a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a><span class=k>def</span> <span class=nf>fn</span><span class=p>(</span><span class=n>a</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span> <span class=n>b</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Multiply</span><span class=p>:</span>
</span><span id=__span-3-16><a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>    <span class=n>resp</span> <span class=o>=</span> <span class=n>a</span> <span class=o>+</span> <span class=n>b</span>
</span><span id=__span-3-17><a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>    <span class=k>return</span> <span class=n>Multiply</span><span class=p>(</span><span class=n>a</span><span class=o>=</span><span class=n>a</span><span class=p>,</span> <span class=n>b</span><span class=o>=</span><span class=n>b</span><span class=p>,</span> <span class=n>result</span><span class=o>=</span><span class=n>resp</span><span class=p>)</span>
</span></code></pre></div> <ol> <li> <p>Don't forget to run the <code>patch()</code> command that we provide with the <code>Instructor</code> package. This helps automatically serialize the content back into the `Pydantic`` model that we're looking for.</p> </li> <li> <p>Don't forget to replace this with your new model id. OpenAI identifies fine tuned models with an id of <code>ft:gpt-3.5-turbo-0613:personal::&lt;id&gt;</code> under their <strong>Fine-tuning</strong> tab on their dashboard</p> </li> </ol> <p>With this, you can swap the function implementation, making it backward compatible. You can even imagine using the different models for different tasks or validating and runnign evals by using the original function and comparing it to the distillation.</p> <h3 id=conclusion><a class=toclink href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/#conclusion>Conclusion</a></h3> <p>We've seen how <code>Instructor</code> can make your life easier, from fine-tuning to distillation. Now if you're thinking wow, I'd love a backend service to do this for continously, you're in luck! Please check out the survey at <a href=https://useinstructor.com>useinstructor.com</a> and let us know who you are.</p> <p>If you enjoy the content or want to try out <code>instructor</code> please check out the <a href=https://github.com/jxnl/instructor>github</a> and give us a star!</p> <nav class=md-post__action> <a href=2023/10/17/enhancing-python-functions-with-instructor-a-guide-to-fine-tuning-and-distillation/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1724672723748638720/qOBwmkOI_400x400.jpg alt="Jason Liu"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-09-17 00:00:00">2023/09/17</time></li> <li class=md-meta__item> 7 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=rag-is-more-than-just-embedding-search><a href=2023/09/17/rag-is-more-than-just-embedding-search/ class=toclink>RAG is more than just embedding search</a></h2> <p>With the advent of large language models (LLM), retrival augmented generation (RAG) has become a hot topic. However throught the past year of <a href="https://jxnl.notion.site/Working-with-me-ec2bb36a5ac048c2a8f6bd888faea6c2?pvs=4">helping startups</a> integrate LLMs into their stack I've noticed that the pattern of taking user queries, embedding them, and directly searching a vector store is effectively demoware.</p> <div class="admonition note"> <p class=admonition-title>What is RAG?</p> </div> <p>Retrival augmented generation (RAG) is a technique that uses an LLM to generate responses, but uses a search backend to augment the generation. In the past year using text embeddings with a vector databases has been the most popular approach I've seen being socialized.</p> <figure> <p><img alt=RAG src=img/dumb_rag.png> </p> <figcaption>Simple RAG that embedded the user query and makes a search.</figcaption> </figure> <p>So let's kick things off by examining what I like to call the 'Dumb' RAG Modela basic setup that's more common than you'd think.</p> <h3 id=the-dumb-rag-model><a class=toclink href=2023/09/17/rag-is-more-than-just-embedding-search/#the-dumb-rag-model>The 'Dumb' RAG Model</a></h3> <p>When you ask a question like, "what is the capital of France?" The RAG 'dumb' model embeds the query and searches in some unopinonated search endpoint. Limited to a single method API like <code>search(query: str) -&gt; List[str]</code>. This is fine for simple queries, since you'd expect words like 'paris is the capital of france' to be in the top results of say, your wikipedia embeddings.</p> <h4 id=why-is-this-a-problem><a class=toclink href=2023/09/17/rag-is-more-than-just-embedding-search/#why-is-this-a-problem>Why is this a problem?</a></h4> <ul> <li> <p><strong>Query-Document Mismatch</strong>: This model assumes that query embedding and the content embedding are similar in the embedding space, which is not always true based on the text you're trying to search over. Only using queries that are semantically similar to the content is a huge limitation!</p> </li> <li> <p><strong>Monolithic Search Backend</strong>: Assumes a single search backend, which is not always the case. You may have multiple search backends, each with their own API, and you want to route the query to vector stores, search clients, sql databases, and more.</p> </li> <li> <p><strong>Limitation of text search</strong>: Restricts complex queries to a single string (<code>{query: str}</code>), sacrificing expressiveness, in using keywords, filters, and other advanced features. For example, asking <code>what problems did we fix last week</code> cannot be answered by a simple text search since documents that contain <code>problem, last week</code> are going to be present at every week.</p> </li> <li> <p><strong>Limited ability to plan</strong>: Assumes that the query is the only input to the search backend, but you may want to use other information to improve the search, like the user's location, or the time of day using the context to rewrite the query. For example, if you present the language model of more context its able to plan a suite of queries to execute to return the best results.</p> </li> </ul> <p>Now let's dive into how we can make it smarter with query understanding. This is where things get interesting.</p> <h3 id=improving-the-rag-model-with-query-understanding><a class=toclink href=2023/09/17/rag-is-more-than-just-embedding-search/#improving-the-rag-model-with-query-understanding>Improving the RAG Model with Query Understanding</a></h3> <div class="admonition note"> <p class=admonition-title>Shoutouts</p> </div> <p>Much of this work has been inspired by / done in collab with a few of my clients at <a href=https://new.computer>new.computer</a>, <a href=https://metaphor.systems>Metaphor Systems</a>, and <a href=https://narohq.com>Naro</a>, go check them out!</p> <p>Ultimately what you want to deploy is a <a href=https://en.wikipedia.org/wiki/Query_understanding>system that understands</a> how to take the query and rewrite it to improve precision and recall.</p> <figure> <p><img alt=RAG src=img/query_understanding.png> </p> <figcaption>Query Understanding system routes to multiple search backends.</figcaption> </figure> <p>Not convinced? Let's move from theory to practice with a real-world example. First up, Metaphor Systems.</p> <h3 id=whats-instructor><a class=toclink href=2023/09/17/rag-is-more-than-just-embedding-search/#whats-instructor>Whats instructor?</a></h3> <p>Instructor uses Pydantic to simplify the interaction between the programmer and language models via the function calling API.</p> <ul> <li><strong>Widespread Adoption</strong>: Pydantic is a popular tool among Python developers.</li> <li><strong>Simplicity</strong>: Pydantic allows model definition in Python.</li> <li><strong>Framework Compatibility</strong>: Many Python frameworks already use Pydantic.</li> </ul> <h3 id=case-study-1-metaphor-systems><a class=toclink href=2023/09/17/rag-is-more-than-just-embedding-search/#case-study-1-metaphor-systems>Case Study 1: Metaphor Systems</a></h3> <p>Take <a href=https://metaphor.systems>Metaphor Systems</a>, which turns natural language queries into their custom search-optimized query. If you take a look web UI you'll notice that they have an auto-prompt option, which uses function calls to furthur optimize your query using a language model, and turns it into a fully specified metaphor systems query.</p> <figure> <p><img alt="Metaphor Systems" src=img/meta.png></p> <figcaption>Metaphor Systems UI</figcaption> </figure> <p>If we peek under the hood, we can see that the query is actually a complex object, with a date range, and a list of domains to search in. It's actually more complex than this but this is a good start. We can model this structured output in Pydantic using the instructor library</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>class</span> <span class=nc>DateRange</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a>    <span class=n>start</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>date</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>    <span class=n>end</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>date</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=k>class</span> <span class=nc>MetaphorQuery</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>    <span class=n>rewritten_query</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>    <span class=n>published_daterange</span><span class=p>:</span> <span class=n>DateRange</span>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a>    <span class=n>domains_allow_list</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute</span><span class=p>():</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>        <span class=k>return</span> <span class=k>await</span> <span class=n>metaphor</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></code></pre></div> <p>Note how we model a rewritten query, range of published dates, and a list of domains to search in. This powerful pattern allows the user query to be restructured for better performance without the user having to know the details of how the search backend works.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=c1># Enables response_model in the openai client</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=n>query</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4&quot;</span><span class=p>,</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>MetaphorQuery</span><span class=p>,</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>        <span class=p>{</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>            <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>            <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;You&#39;re a query understanding system for the Metafor Systems search engine. Here are some tips: ...&quot;</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>        <span class=p>},</span>
</span><span id=__span-1-15><a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>        <span class=p>{</span>
</span><span id=__span-1-16><a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a>            <span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span>
</span><span id=__span-1-17><a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a>            <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;What are some recent developments in AI?&quot;</span>
</span><span id=__span-1-18><a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a>        <span class=p>}</span>
</span><span id=__span-1-19><a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a>    <span class=p>],</span>
</span><span id=__span-1-20><a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a><span class=p>)</span>
</span></code></pre></div> <p><strong>Example Output</strong></p> <div class="language-json highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=p>{</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>  </span><span class=nt>&quot;rewritten_query&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;novel developments advancements ai artificial intelligence machine learning&quot;</span><span class=p>,</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>  </span><span class=nt>&quot;published_daterange&quot;</span><span class=p>:</span><span class=w> </span><span class=p>{</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=nt>&quot;start&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2023-09-17&quot;</span><span class=p>,</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=nt>&quot;end&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2021-06-17&quot;</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>  </span><span class=p>},</span>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>  </span><span class=nt>&quot;domains_allow_list&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;arxiv.org&quot;</span><span class=p>]</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=p>}</span>
</span></code></pre></div> <p>This isn't just about adding some date ranges. It's about nuanced, tailored searches, that are deeply integrated with the backend. Metaphor Systems has a whole suite of other filters and options that you can use to build a powerful search query. They can even use some chain of thought prompting to improve how they use some of these advanced features.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>class</span> <span class=nc>DateRange</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    <span class=n>start</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>date</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=n>end</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>date</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    <span class=n>chain_of_thought</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=n>Field</span><span class=p>(</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>        <span class=kc>None</span><span class=p>,</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>        <span class=n>description</span><span class=o>=</span><span class=s2>&quot;Think step by step to plan what is the best time range to search in&quot;</span>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>    <span class=p>)</span>
</span></code></pre></div> <p>Now, let's see how this approach can help model an agent like personal assistant.</p> <h3 id=case-study-2-personal-assistant><a class=toclink href=2023/09/17/rag-is-more-than-just-embedding-search/#case-study-2-personal-assistant>Case Study 2: Personal Assistant</a></h3> <p>Another great example of this multiple dispatch pattern is a personal assistant. You might ask, "What do I have today?", from a vague query you might want events, emails, reminders etc. That data will likely exist in multiple backends, but what you want is one unified summary of results. Here you can't assume that text of those documents are all embedded in a search backend. There might be a calendar client, email client, across personal and profession accounts.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>class</span> <span class=nc>ClientSource</span><span class=p>(</span><span class=n>enum</span><span class=o>.</span><span class=n>Enum</span><span class=p>):</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    <span class=n>GMAIL</span> <span class=o>=</span> <span class=s2>&quot;gmail&quot;</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>    <span class=n>CALENDAR</span> <span class=o>=</span> <span class=s2>&quot;calendar&quot;</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=k>class</span> <span class=nc>SearchClient</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>    <span class=n>query</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>    <span class=n>keywords</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>    <span class=n>email</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a>    <span class=n>source</span><span class=p>:</span> <span class=n>ClientSource</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>    <span class=n>start_date</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>date</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>    <span class=n>end_date</span><span class=p>:</span> <span class=n>datetime</span><span class=o>.</span><span class=n>date</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>source</span> <span class=o>==</span> <span class=n>ClientSource</span><span class=o>.</span><span class=n>GMAIL</span><span class=p>:</span>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a>            <span class=o>...</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>        <span class=k>elif</span> <span class=bp>self</span><span class=o>.</span><span class=n>source</span> <span class=o>==</span> <span class=n>ClientSource</span><span class=o>.</span><span class=n>CALENDAR</span><span class=p>:</span>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>            <span class=o>...</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>
</span><span id=__span-4-19><a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=k>class</span> <span class=nc>Retrival</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-4-20><a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a>    <span class=n>queries</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>SearchClient</span><span class=p>]</span>
</span><span id=__span-4-21><a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a>
</span><span id=__span-4-22><a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a>    <span class=k>async</span> <span class=k>def</span> <span class=nf>execute</span><span class=p>(</span><span class=bp>self</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>str</span><span class=p>:</span>
</span><span id=__span-4-23><a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a>        <span class=k>return</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>gather</span><span class=p>(</span><span class=o>*</span><span class=p>[</span><span class=n>query</span><span class=o>.</span><span class=n>execute</span><span class=p>()</span> <span class=k>for</span> <span class=n>query</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>queries</span><span class=p>])</span>
</span></code></pre></div> <p>Now we can call this with a simple query like "What do I have today?" and it will try to async dispatch to the correct backend. It's still important to prompt the language model well, but we'll leave that for another day.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=c1># Enables response_model in the openai client</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=n>retrival</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-4&quot;</span><span class=p>,</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>Retrival</span><span class=p>,</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;You are Jason&#39;s personal assistant.&quot;</span><span class=p>},</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;What do I have today?&quot;</span><span class=p>}</span>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a>    <span class=p>],</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=p>)</span>
</span></code></pre></div> <p><strong>Example Output</strong></p> <div class="language-json highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=p>{</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=nt>&quot;queries&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>            </span><span class=nt>&quot;query&quot;</span><span class=p>:</span><span class=w> </span><span class=err>No</span><span class=kc>ne</span><span class=p>,</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>            </span><span class=nt>&quot;keywords&quot;</span><span class=p>:</span><span class=w> </span><span class=err>No</span><span class=kc>ne</span><span class=p>,</span>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>            </span><span class=nt>&quot;email&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;jason@example.com&quot;</span><span class=p>,</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>            </span><span class=nt>&quot;source&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;gmail&quot;</span><span class=p>,</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>            </span><span class=nt>&quot;start_date&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2023-09-17&quot;</span><span class=p>,</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>            </span><span class=nt>&quot;end_date&quot;</span><span class=p>:</span><span class=w> </span><span class=err>No</span><span class=kc>ne</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>        </span><span class=p>},</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>        </span><span class=p>{</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>            </span><span class=nt>&quot;query&quot;</span><span class=p>:</span><span class=w> </span><span class=err>No</span><span class=kc>ne</span><span class=p>,</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>            </span><span class=nt>&quot;keywords&quot;</span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;meeting&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;call&quot;</span><span class=p>,</span><span class=w> </span><span class=s2>&quot;zoom&quot;</span><span class=p>]]],</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>            </span><span class=nt>&quot;email&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;jason@example.com&quot;</span><span class=p>,</span>
</span><span id=__span-6-15><a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>            </span><span class=nt>&quot;source&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;calendar&quot;</span><span class=p>,</span>
</span><span id=__span-6-16><a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>            </span><span class=nt>&quot;start_date&quot;</span><span class=p>:</span><span class=w> </span><span class=s2>&quot;2023-09-17&quot;</span><span class=p>,</span>
</span><span id=__span-6-17><a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>            </span><span class=nt>&quot;end_date&quot;</span><span class=p>:</span><span class=w> </span><span class=err>No</span><span class=kc>ne</span>
</span><span id=__span-6-18><a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a>
</span><span id=__span-6-19><a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>        </span><span class=p>}</span>
</span><span id=__span-6-20><a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>    </span><span class=p>]</span>
</span><span id=__span-6-21><a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=p>}</span>
</span></code></pre></div> <p>Notice that we have a list of queries that route to different search backends (email and calendar). We can even dispatch them async to be as performance as possible. Not only do we dispatch to different backends (that we have no control over), but you are likely going to render them to the user differently as well. Perhaps you want to summarize the emails in text, but you want to render the calendar events as a list that they can scroll across on a mobile app.</p> <div class="admonition note"> <p class=admonition-title>Can I used framework X?</p> </div> <p>I get this question a lot, but it's just code. Within these dispatchs you can do whatever you want. You can use <code>input()</code> to ask the user for more information, make a post request, call a Langchain agent or LLamaindex query engine to get more information. The sky is the limit.</p> <p>Both of these examples showcase how both search providors and consumers can use <code>instructor</code> to model their systems. This is a powerful pattern that allows you to build a system that can be used by anyone, and can be used to build an LLM layer, from scratch, in front of any arbitrary backend.</p> <h3 id=conclusion><a class=toclink href=2023/09/17/rag-is-more-than-just-embedding-search/#conclusion>Conclusion</a></h3> <p>This isnt about fancy embedding tricks, it's just plain old information retrival and query understanding. The beauty of instructor is that it simplifies modeling the complex and lets you define the output of the language model, the prompts, and the payload we send to the backend in a single place.</p> <h3 id=whats-next><a class=toclink href=2023/09/17/rag-is-more-than-just-embedding-search/#whats-next>What's Next?</a></h3> <p>Here I want to show that `instructor`` isnt just about data extraction. Its a powerful framework for building a data model and integrating it with your LLM. Structured output is just the beginning  the untapped goldmine is skilled use of tools and APIs.</p> <p>If you enjoy the content or want to try out <code>instructor</code> please check out the <a href=https://github.com/jxnl/instructor>github</a> and give us a star!</p> <nav class=md-post__action> <a href=2023/09/17/rag-is-more-than-just-embedding-search/ > Continue reading </a> </nav> </div> </article> <article class="md-post md-post--excerpt"> <header class=md-post__header> <nav class="md-post__authors md-typeset"> <span class=md-author> <img src=https://pbs.twimg.com/profile_images/1724672723748638720/qOBwmkOI_400x400.jpg alt="Jason Liu"> </span> </nav> <div class="md-post__meta md-meta"> <ul class=md-meta__list> <li class=md-meta__item> <time datetime="2023-09-11 00:00:00">2023/09/11</time></li> <li class=md-meta__item> 2 min read </li> </ul> </div> </header> <div class="md-post__content md-typeset"> <h2 id=bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls><a href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/ class=toclink>Bridging Language Models with Python using Instructor, Pydantic, and OpenAI's Function Calls</a></h2> <p>Language models have seen significant growth. Using them effectively often requires complex frameworks. This post discusses how Instructor simplifies this process using Pydantic.</p> <h3 id=the-problem-with-existing-llm-frameworks><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#the-problem-with-existing-llm-frameworks>The Problem with Existing LLM Frameworks</a></h3> <p>Current frameworks for Language Learning Models (LLMs) have complex setups. Developers find it hard to control interactions with language models. Some frameworks require complex JSON Schema setups.</p> <h3 id=the-openai-function-calling-game-changer><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#the-openai-function-calling-game-changer>The OpenAI Function Calling Game-Changer</a></h3> <p>OpenAI's Function Calling feature provides a constrained interaction model. However, it has its own complexities, mostly around JSON Schema.</p> <h3 id=why-pydantic><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#why-pydantic>Why Pydantic?</a></h3> <p>Instructor uses Pydantic to simplify the interaction between the programmer and the language model.</p> <ul> <li><strong>Widespread Adoption</strong>: Pydantic is a popular tool among Python developers.</li> <li><strong>Simplicity</strong>: Pydantic allows model definition in Python.</li> <li><strong>Framework Compatibility</strong>: Many Python frameworks already use Pydantic.</li> </ul> <div class="language-python highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=kn>import</span> <span class=nn>pydantic</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=kn>import</span> <span class=nn>instructor</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=c1># Enables the response_model</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=n>client</span> <span class=o>=</span> <span class=n>instructor</span><span class=o>.</span><span class=n>patch</span><span class=p>(</span><span class=n>OpenAI</span><span class=p>())</span>
</span><span id=__span-0-7><a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a>
</span><span id=__span-0-8><a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=k>class</span> <span class=nc>UserDetail</span><span class=p>(</span><span class=n>pydantic</span><span class=o>.</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-0-9><a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-0-10><a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-0-11><a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>
</span><span id=__span-0-12><a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>    <span class=k>def</span> <span class=nf>introduce</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span><span id=__span-0-13><a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>        <span class=k>return</span> <span class=sa>f</span><span class=s2>&quot;Hello I&#39;m </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2> and I&#39;m </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>age</span><span class=si>}</span><span class=s2> years old&quot;</span>
</span><span id=__span-0-14><a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>
</span><span id=__span-0-15><a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=n>user</span><span class=p>:</span> <span class=n>UserDetail</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=o>.</span><span class=n>create</span><span class=p>(</span>
</span><span id=__span-0-16><a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>    <span class=n>model</span><span class=o>=</span><span class=s2>&quot;gpt-3.5-turbo&quot;</span><span class=p>,</span>
</span><span id=__span-0-17><a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>    <span class=n>response_model</span><span class=o>=</span><span class=n>UserDetail</span><span class=p>,</span>
</span><span id=__span-0-18><a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>    <span class=n>messages</span><span class=o>=</span><span class=p>[</span>
</span><span id=__span-0-19><a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>        <span class=p>{</span><span class=s2>&quot;role&quot;</span><span class=p>:</span> <span class=s2>&quot;user&quot;</span><span class=p>,</span> <span class=s2>&quot;content&quot;</span><span class=p>:</span> <span class=s2>&quot;Extract Jason is 25 years old&quot;</span><span class=p>},</span>
</span><span id=__span-0-20><a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>    <span class=p>]</span>
</span><span id=__span-0-21><a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=p>)</span>
</span></code></pre></div> <h3 id=simplifying-validation-flow-with-pydantic><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#simplifying-validation-flow-with-pydantic>Simplifying Validation Flow with Pydantic</a></h3> <p>Pydantic validators simplify features like re-asking or self-critique. This makes these tasks less complex compared to other frameworks.</p> <div class="language-python highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=kn>from</span> <span class=nn>typing_extensions</span> <span class=kn>import</span> <span class=n>Annotated</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kn>from</span> <span class=nn>pydantic</span> <span class=kn>import</span> <span class=n>BaseModel</span><span class=p>,</span> <span class=n>BeforeValidator</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=kn>from</span> <span class=nn>instructor</span> <span class=kn>import</span> <span class=n>llm_validator</span><span class=p>,</span> <span class=n>patch</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=kn>from</span> <span class=nn>openai</span> <span class=kn>import</span> <span class=n>OpenAI</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a>
</span><span id=__span-1-7><a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=k>class</span> <span class=nc>QuestionAnswerNoEvil</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-1-8><a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a>    <span class=n>question</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-1-9><a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a>    <span class=n>answer</span><span class=p>:</span> <span class=n>Annotated</span><span class=p>[</span>
</span><span id=__span-1-10><a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>        <span class=nb>str</span><span class=p>,</span>
</span><span id=__span-1-11><a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>        <span class=n>BeforeValidator</span><span class=p>(</span>
</span><span id=__span-1-12><a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>            <span class=n>llm_validator</span><span class=p>(</span><span class=s2>&quot;don&#39;t say objectionable things&quot;</span><span class=p>)</span>
</span><span id=__span-1-13><a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>        <span class=p>),</span>
</span><span id=__span-1-14><a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>    <span class=p>]</span>
</span></code></pre></div> <h3 id=the-modular-approach><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#the-modular-approach>The Modular Approach</a></h3> <p>Pydantic allows for modular output schemas. This leads to more organized code.</p> <h4 id=composition-of-schemas><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#composition-of-schemas>Composition of Schemas</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>class</span> <span class=nc>UserDetails</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=k>class</span> <span class=nc>UserWithAddress</span><span class=p>(</span><span class=n>UserDetails</span><span class=p>):</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>    <span class=n>address</span><span class=p>:</span> <span class=nb>str</span>
</span></code></pre></div> <h4 id=defining-relationships><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#defining-relationships>Defining Relationships</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>class</span> <span class=nc>UserDetail</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-3-3><a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-3-4><a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-3-5><a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>    <span class=n>friends</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=nb>int</span><span class=p>]</span>
</span><span id=__span-3-6><a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>
</span><span id=__span-3-7><a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=k>class</span> <span class=nc>UserRelationships</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-3-8><a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>    <span class=n>users</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>UserDetail</span><span class=p>]</span>
</span></code></pre></div> <h4 id=using-enums><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#using-enums>Using Enums</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kn>from</span> <span class=nn>enum</span> <span class=kn>import</span> <span class=n>Enum</span><span class=p>,</span> <span class=n>auto</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=k>class</span> <span class=nc>Role</span><span class=p>(</span><span class=n>Enum</span><span class=p>):</span>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>    <span class=n>PRINCIPAL</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>    <span class=n>TEACHER</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>    <span class=n>STUDENT</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>    <span class=n>OTHER</span> <span class=o>=</span> <span class=n>auto</span><span class=p>()</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=k>class</span> <span class=nc>UserDetail</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>    <span class=n>role</span><span class=p>:</span> <span class=n>Role</span>
</span></code></pre></div> <h4 id=flexible-schemas><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#flexible-schemas>Flexible Schemas</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=kn>from</span> <span class=nn>typing</span> <span class=kn>import</span> <span class=n>List</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=k>class</span> <span class=nc>Property</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>    <span class=n>key</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>    <span class=n>value</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=k>class</span> <span class=nc>UserDetail</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>    <span class=n>properties</span><span class=p>:</span> <span class=n>List</span><span class=p>[</span><span class=n>Property</span><span class=p>]</span>
</span></code></pre></div> <h4 id=chain-of-thought><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#chain-of-thought>Chain of Thought</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>class</span> <span class=nc>TimeRange</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>    <span class=n>chain_of_thought</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>    <span class=n>start_time</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>    <span class=n>end_time</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=k>class</span> <span class=nc>UserDetail</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a>    <span class=nb>id</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a>    <span class=n>age</span><span class=p>:</span> <span class=nb>int</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a>    <span class=n>name</span><span class=p>:</span> <span class=nb>str</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a>    <span class=n>work_time</span><span class=p>:</span> <span class=n>TimeRange</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a>    <span class=n>leisure_time</span><span class=p>:</span> <span class=n>TimeRange</span>
</span></code></pre></div> <h3 id=language-models-as-microservices><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#language-models-as-microservices>Language Models as Microservices</a></h3> <p>The architecture resembles FastAPI. Most code can be written as Python functions that use Pydantic objects. This eliminates the need for prompt chains.</p> <h4 id=fastapi-stub><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#fastapi-stub>FastAPI Stub</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=n>app</span> <span class=o>=</span> <span class=n>FastAPI</span><span class=p>()</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a><span class=nd>@app</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=s2>&quot;/user/</span><span class=si>{user_id}</span><span class=s2>&quot;</span><span class=p>,</span> <span class=n>response_model</span><span class=o>=</span><span class=n>UserDetails</span><span class=p>)</span>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=k>async</span> <span class=k>def</span> <span class=nf>get_user</span><span class=p>(</span><span class=n>user_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>UserDetails</span><span class=p>:</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>    <span class=k>return</span> <span class=n>UserDetails</span><span class=p>(</span><span class=o>...</span><span class=p>)</span>
</span></code></pre></div> <h4 id=using-instructor-as-a-function><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#using-instructor-as-a-function>Using Instructor as a Function</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>def</span> <span class=nf>extract_user</span><span class=p>(</span><span class=nb>str</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>UserDetails</span><span class=p>:</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    <span class=k>return</span> <span class=n>client</span><span class=o>.</span><span class=n>chat</span><span class=o>.</span><span class=n>completions</span><span class=p>(</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>           <span class=n>response_model</span><span class=o>=</span><span class=n>UserDetails</span><span class=p>,</span>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>           <span class=n>messages</span><span class=o>=</span><span class=p>[</span><span class=o>...</span><span class=p>]</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>    <span class=p>)</span>
</span></code></pre></div> <h4 id=response-modeling><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#response-modeling>Response Modeling</a></h4> <div class="language-python highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>class</span> <span class=nc>MaybeUser</span><span class=p>(</span><span class=n>BaseModel</span><span class=p>):</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a>    <span class=n>result</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>UserDetail</span><span class=p>]</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a>    <span class=n>error</span><span class=p>:</span> <span class=nb>bool</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a>    <span class=n>message</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span>
</span></code></pre></div> <h3 id=conclusion><a class=toclink href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/#conclusion>Conclusion</a></h3> <p>Instructor, with Pydantic, simplifies interaction with language models. It is usable for both experienced and new developers.</p> <p>If you enjoy the content or want to try out <code>instructor</code> please check out the <a href=https://github.com/jxnl/instructor>github</a> and give us a star!</p> <nav class=md-post__action> <a href=2023/09/11/bridging-language-models-with-python-using-instructor-pydantic-and-openais-function-calls/ > Continue reading </a> </nav> </div> </article> <nav class=md-pagination> </nav> </div> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../api/ class="md-footer__link md-footer__link--prev" aria-label="Previous: Core Library"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> Previous </span> <div class=md-ellipsis> Core Library </div> </div> </a> <a href=archive/2023/ class="md-footer__link md-footer__link--next" aria-label="Next: 2023"> <div class=md-footer__title> <span class=md-footer__direction> Next </span> <div class=md-ellipsis> 2023 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 Jason Liu </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://twitter.com/jxnlco target=_blank rel=noopener title=twitter.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg> </a> <a href=https://github.com/jxnl target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <div class=md-progress data-md-component=progress role=progressbar></div> <script id=__config type=application/json>{"base": "..", "features": ["announce.dismiss", "content.action.edit", "content.action.view", "content.code.annotate", "content.code.copy", "content.code.select", "content.tabs.link", "content.tooltips", "header.autohide", "navigation.expand", "navigation.footer", "navigation.indexes", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress", "navigation.prune", "navigation.sections", "navigation.tabs", "navigation.top", "navigation.tracking", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../assets/javascripts/workers/search.f886a092.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../assets/javascripts/bundle.cd18aaf1.min.js></script> </body> </html>